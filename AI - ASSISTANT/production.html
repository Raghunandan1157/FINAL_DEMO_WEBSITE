<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Chat — EN/KN Toggle + Webhook</title>
<style>
  :root{--bg:#f8fafc;--ink:#0f172a;--muted:#64748b;--card:#ffffff;--ring:#e2e8f0;--brand:#2563eb}
  *{box-sizing:border-box}
  body{margin:0;height:100vh;display:flex;flex-direction:column;background:var(--bg);color:var(--ink);
       font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:760px;margin:0 auto;display:flex;flex-direction:column;height:100vh}
  header{padding:14px 16px}
  .title{font-weight:600}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.04);
        display:flex;flex-direction:column;overflow:hidden;height:calc(100vh - 88px)}
  .messages{flex:1;overflow:auto;padding:18px 16px 8px}
  .msg{max-width:80%;padding:10px 12px;border-radius:12px;margin:8px 0;white-space:pre-wrap;word-wrap:break-word}
  .me{background:#e6f0ff;border:1px solid #cfe0ff;margin-left:auto;border-top-right-radius:6px}
  .bot{background:#f3f4f6;border:1px solid #e5e7eb;border-top-left-radius:6px}
  .composer{display:flex;gap:10px;align-items:flex-end;padding:10px;border-top:1px solid var(--ring);background:var(--card)}
  .lang-toggle{display:flex;border:1px solid var(--ring);border-radius:10px;overflow:hidden;background:#f1f5f9}
  .lang-toggle button{appearance:none;border:0;background:transparent;padding:8px 10px;cursor:pointer;font-weight:600;color:var(--muted);min-width:36px}
  .lang-toggle button.active{background:#ffffff;color:var(--ink)}
  .input-wrap{position:relative;flex:1;display:flex;align-items:center;border:1px solid var(--ring);border-radius:12px;padding:6px 10px;background:#fff}
  textarea{border:0;resize:none;outline:none;width:100%;max-height:140px;min-height:36px;padding:6px 4px;background:transparent;color:var(--ink)}
  .send{appearance:none;border:0;background:var(--brand);color:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .send[disabled]{opacity:.6;cursor:not-allowed}
  .hint{font-size:12px;color:var(--muted);padding-left:6px}
  .status{font-size:12px;color:var(--muted);margin-left:6px}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
         background:#111827;color:#fff;border-radius:10px;padding:10px 14px;opacity:0;pointer-events:none;transition:opacity .25s}
  .toast.show{opacity:1}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Chat</div>
      <div class="hint">Toggle English (A) or Kannada (ಅ). In Kannada, we append “Answer in Kannada. ಕನ್ನಡದಲ್ಲಿ ಉತ್ತರಿಸಿ.” invisibly.</div>
    </header>

    <section class="card" aria-label="Chat window">
      <div id="messages" class="messages" role="log" aria-live="polite" aria-relevant="additions"></div>

      <div class="composer">
        <!-- Left-side language toggle -->
        <div class="lang-toggle" role="group" aria-label="Language toggle">
          <button id="btnEN" class="active" aria-pressed="true" title="English">A</button>
          <button id="btnKN" aria-pressed="false" title="Kannada">ಅ</button>
        </div>

        <!-- Input -->
        <div class="input-wrap" style="flex:1;">
          <textarea id="input" placeholder="Type a message… (Enter to send, Shift+Enter for new line)" rows="1"></textarea>
        </div>

        <!-- Send -->
        <button id="sendBtn" class="send" type="button" aria-label="Send message">Send</button>
      </div>
      <div class="status" id="status"></div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Sent</div>

<script>
  // ===== Config =====
  const WEBHOOK_BASE = "https://spaced-admissibly-rochel.ngrok-free.dev/webhook-test/ae09123e-7628-4f5d-a2c8-4af94ff51f12/ae09123e-762/:message";

  // ===== State & Elements =====
  let lang = 'EN';
  const input   = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');
  const messages= document.getElementById('messages');
  const btnEN   = document.getElementById('btnEN');
  const btnKN   = document.getElementById('btnKN');
  const status  = document.getElementById('status');
  const toast   = document.getElementById('toast');

  // ===== UI Helpers =====
  function setLang(newLang){
    lang = newLang;
    const en = lang === 'EN';
    btnEN.classList.toggle('active', en);
    btnKN.classList.toggle('active', !en);
    btnEN.setAttribute('aria-pressed', en ? 'true':'false');
    btnKN.setAttribute('aria-pressed', !en ? 'true':'false');
    input.placeholder = en
      ? "Type a message… (Enter to send, Shift+Enter for new line)"
      : "ಸಂದೇಶವನ್ನು ಟೈಪ್ ಮಾಡಿ… (ಕಳುಹಿಸಲು Enter, ಹೊಸ ಸಾಲಿಗೆ Shift+Enter)";
  }

  function addMessage(text, who='me'){
    const wrap = document.createElement('div');
    const bubble = document.createElement('div');
    bubble.className = 'msg ' + (who==='me' ? 'me':'bot');
    bubble.textContent = text;
    wrap.appendChild(bubble);
    messages.appendChild(wrap);
    messages.scrollTop = messages.scrollHeight;
  }

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 1200);
  }

  function buildWebhookUrl(msgForPath){
    // Replace ':message' with URL-encoded message (keep it short to avoid very long URLs)
    const preview = (msgForPath || '').slice(0, 120);
    return WEBHOOK_BASE.replace(':message', encodeURIComponent(preview));
  }

  // ===== Send Flow =====
  async function sendMessage(){
    const visibleText = input.value.trim();
    if(!visibleText) return;

    // Render user bubble immediately
    addMessage(visibleText, 'me');

    // Compose outgoing (append Kannada instruction invisibly)
    const suffixKN = " Answer in Kannada. ಕನ್ನಡದಲ್ಲಿ ಉತ್ತರಿಸಿ.";
    const payloadText = lang === 'KN' ? (visibleText + suffixKN) : visibleText;

    // Clear input
    input.value = '';
    input.style.height = '36px';
    input.focus();

    // Build request
    const url = buildWebhookUrl(visibleText);
    const body = {
      prompt: payloadText,          // what you want your model/flow to use
      original: visibleText,        // raw user input (no suffix)
      lang,                         // EN or KN
      meta: {
        ts: new Date().toISOString(),
        ua: navigator.userAgent
      }
    };

    sendBtn.disabled = true;
    status.textContent = "Sending…";

    try{
      // Try POST JSON first (recommended for n8n)
      let res = await fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body),
        mode: "cors",
      });

      // If server forbids POST/CORS, fall back to GET with ?q=
      if(!res.ok){
        try{
          const alt = url + "?q=" + encodeURIComponent(payloadText);
          res = await fetch(alt, { method: "GET", mode: "cors" });
        }catch(_){}
      }

      // Try to parse JSON first; if not available, read text
      let replyText = '';
      try{
        const data = await res.clone().json();
        if(typeof data?.output === 'string' && data.output.trim().length){
          replyText = data.output.trim();
        }else{
          replyText = "Received data:\n" + JSON.stringify(data, null, 2);
        }
      }catch(_){
        const txt = await res.clone().text();
        replyText = txt ? "Received data:\n" + txt : "Received data: <empty response>";
      }

      addMessage(replyText, 'bot');
      status.textContent = "Sent";
      showToast("Sent");
    }catch(err){
      console.error(err);
      addMessage("Failed to send. Please check webhook CORS/methods.", 'bot');
      status.textContent = "Error";
      showToast("Error");
    }finally{
      sendBtn.disabled = false;
      setTimeout(()=>{ if(status.textContent!=='Error') status.textContent=''; }, 1200);
    }
  }

  // ===== Events =====
  btnEN.addEventListener('click', ()=> setLang('EN'));
  btnKN.addEventListener('click', ()=> setLang('KN'));
  sendBtn.addEventListener('click', sendMessage);
  input.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });
  input.addEventListener('input', ()=>{
    input.style.height = '36px';
    input.style.height = Math.min(input.scrollHeight, 140) + 'px';
  });

  // Init
  setLang('EN');
</script>
</body>
</html>
