<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Region Matrix â€“ Auto Aggregate (Seq. Branch Calc)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Tailwind (utilities only) -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Supabase JS v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --ink:#0e1a2b; --muted:#6a7485; --grid:#e5e9f3; --line:#d6dbe6;
    --paper:#ffffff; --bg:#f5f7fb;
    --ok:#16a34a; --bad:#dc2626; --accent:#0a84ff;
    --dot-size:36px; --ring-thick:3px;
  }
  body{ margin:0; background:var(--bg); color:var(--ink);
        font-family: "Inter","Segoe UI",Roboto,system-ui,-apple-system,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif; }
  .wrap{max-width:1123px; margin:18px auto; padding:0 10px;}
  .sheet{ background:var(--paper); border:1px solid var(--line); border-radius:14px; padding:16px; }

  .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
  .header-left{ display:flex; align-items:center; gap:12px; min-width:0; }
  .logo{ width:56px; height:auto; display:block; object-fit:contain; cursor:pointer; }
  .header h1{ font-size:22px; font-weight:800; margin:0; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .badge{ font-size:12px; color:#334155; background:#f1f5ff; border:1px solid #dbe6ff; padding:.25rem .6rem; border-radius:999px; font-weight:700; }

  .toolbar{ display:flex; justify-content:flex-end; gap:10px; margin:10px 0 14px; position:sticky; top:8px; z-index:10; }
  .btn{ appearance:none; border:none; border-radius:10px; padding:10px 14px; font-weight:800; background:#111827; color:#fff; cursor:pointer; box-shadow:0 6px 16px rgba(0,0,0,.18); }
  .btn:active{ transform:translateY(1px); }

  /* Progress grid */
  .progress-wrap{ border:1px dashed var(--line); border-radius:12px; padding:10px; background:#fff; }
  .progress-grid{ display:grid; grid-template-columns: repeat(10, minmax(0,1fr)); gap:8px; align-items:center; justify-items:center; }
  .dot{ width:var(--dot-size); height:var(--dot-size); border-radius:50%; position:relative; display:grid; place-items:center; font-size:12px; font-weight:800; color:#0f172a; user-select:none; }
  .dot .ring{ position:absolute; inset:0; border-radius:50%; padding:calc(var(--ring-thick));
    -webkit-mask: radial-gradient(farthest-side,#0000 calc(100% - var(--ring-thick) - .5px),#000 calc(100% - var(--ring-thick)));
            mask: radial-gradient(farthest-side,#0000 calc(100% - var(--ring-thick) - .5px),#000 calc(100% - var(--ring-thick)));
    background: conic-gradient(var(--accent) 0deg, var(--accent) 60deg, #e5e7eb 60deg);
  }
  .dot.active .ring{ animation:spin .9s linear infinite; }
  .dot.done  .ring{ background: conic-gradient(var(--ok) 360deg, var(--ok) 360deg, #e5e7eb 0); }
  .dot.done  .num{ color:var(--ok); }
  .dot.error .ring{ background: conic-gradient(var(--bad) 360deg, var(--bad) 360deg, #e5e7eb 0); }
  @keyframes spin{ to{ transform:rotate(1turn);} }

  .table-grid { border-collapse: separate; border-spacing: 0; width:100%; font-size:13px; }
  .table-grid th, .table-grid td { border-right: 1px solid var(--grid); border-bottom: 1px solid var(--grid); padding:.55rem .6rem; text-align:left; }
  .table-grid tr:first-child th, .table-grid tr:first-child td { border-top: 1px solid var(--grid); }
  .table-grid tr td:first-child, .table-grid tr th:first-child { border-left: 1px solid var(--grid); }
  .table-head{ background:#f8fbff; }

  @page { size: A4 landscape; margin: 10mm; }
  @media print{
    body{ background:#fff !important; }
    .toolbar{ display:none !important; }
    .wrap{ max-width:none; margin:0; padding:0; }
    .sheet{ border:none; border-radius:0; padding:0; }
    .table-grid thead{ display:table-header-group; }
    .table-grid tfoot{ display:table-footer-group; }
    .table-grid th, .table-grid td{ font-size:11.5px !important; padding:6px 8px !important; border-color:#d0d5dd !important; }
    .table-head{ background:#f8fafc !important; }
    .logo{ width:56px; height:auto; }
    /* ðŸ”’ Hide ALL progress UI in print */
    .progress-wrap, #pgLabel, #pgCount, .progress-grid, .dot{ display:none !important; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <button class="btn" id="btnPrint" title="Print A4 (Landscape)">Print</button>
  </div>

  <div class="sheet">
    <div class="header">
      <div class="header-left">
        <img src="Official Logo.jpg" alt="Logo" class="logo" title="Back" />
        <h1 id="hdrTitle">Region</h1>
      </div>
      <span class="badge" id="hdrBadge">Preparingâ€¦</span>
    </div>

    <!-- Progress (hidden in print) -->
    <div class="progress-wrap mb-3">
      <div class="flex items-center justify-between mb-2">
        <div class="text-[12px] font-semibold text-slate-700" id="pgLabel"></div>
        <div class="text-[12px] text-slate-600" id="pgCount">0/0</div>
      </div>
      <div class="progress-grid" id="progressGrid"></div>
    </div>

    <!-- FINAL (AGGREGATED) TABLE -->
    <div class="overflow-auto">
      <table class="table-grid" id="finalTable">
        <thead>
          <tr class="table-head">
            <th>Parameters</th>
            <th id="thB">Prev Month</th>
            <th id="thC">Current Month</th>
            <th>Difference</th>
          </tr>
        </thead>
        <tbody id="finalBody"></tbody>
      </table>
    </div>
    <p id="statusLine" class="mt-2 text-[12px] text-slate-600"></p>
  </div>
</div>

<script>
/* ====== SUPABASE CONFIG ====== */
const SUPABASE_URL = "https://zovnmmdfthpbubrorsgh.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvdm5tbWRmdGhwYnVicm9yc2doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NzE3ODgsImV4cCI6MjA3NzE0Nzc4OH0.92BH2sjUOgkw6iSRj1_4gt0p3eThg3QT4VK-Q4EdmBE";
const TABLE_NAME   = "NLPL_FINAL_TABLE";
const ROW_LIMIT    = 20000;

/* ====== HARD-WIRED REGION BRANCHES ====== */
const REGION_BRANCHES = {
  "TUMKUR":[
    "AJJAMPURA","BAGEPALLI","BANGARPET","BETHAMANGALA","CHALLAKERE","CHANDAPURA","CHANNAGIRI","CHIKBALLAPURA","CHIKKAMAGALURU","CHIKKANAYAKANAHALLI","CHINTAMANI","CHITRADURGA","DABUSPET","DEVANAHALLI","DODDABALLAPURA","GOWRIBIDANUR","GUBBI","HEBBAL","HIRIYUR","HOLAKERE","HOSADURGA","HULIYAR","J P NAGAR","JAGALORE","KADUR","KENGERI","KOLAR","KORATAGERE","KUNIGAL","MADHUGIRI","MALUR","MUDIGERE","NR PURA","PANCHANHALLI","SIRA","SRINIVASPURA","TARIKERE","TIPTUR","TUMKUR","TUREVEKERE"
  ],
  "KALBURGI":[
    "AFZALPUR","ALAND","ALMEL","AURAD","BAGALKOT","BASAVAKALYAN","BHALKI","BIDAR","BIDAR-2","BILAGI","CHADCHAN","CHINCHOLI","DEVADURGA","GANGAVATHI","HULSOOR","HUMNABAD","HUNGUND","INDI","JAMAKHANDI","JEVARGI","KALABURAGI","KALAGI","KALBURGI-2","KAMALAPURA","KOPPAL","KUSHTAGI","LINGSUGUR","LOKAPUR","MANVI","MUDDEBIHAL","RAICHUR","SEDAM","SHAHAPUR","SINDAGI","SINDHNUR","SIRWAR","TALIKOTI","TIKOTA","VIJAYAPUR","YADGIR"
  ],
  "DHARWAD":[
    "ATHANI","BADAMI","BAILHONGAL","BALLARI","BELAGAVI","CHIKKODI","DAVANAGERE","DHARWAD","GADAG","GAJENDRAGAD","GOKAK","HAGARIBOMMANAHALLI","HARAPANAHALLI","HARIHARA","HONNALI","HOSPET","HUBLI","HUBLI-2","HUVENAHADAGALLI","KALGHATGI","KHANAHOSAHALLI","KITTUR","KOTTURU","KUDATHINI","KUDLIGI","LAXMESHWAR","MUDALAGI","MUNDARAGI","NARAGUNDA","NIPPANI","RAMDURGA","SANDURU","SANTHEBENNURU","SIRUGUPPA","YARAGATTI"
  ],
  "TELANGANA":[ "GADWAL","KODANGAL","MAHABUB NAGAR","MARIKAL","NARAYANKHED","SANGAREDDY","TANDUR","ZAHEERABAD" ],
  "ANDHRA PRADESH":[ "BADVEL","DHARMAVARAM","KADAPA","KADIRI" ]
};

/* ====== UTIL ====== */
const MONTHS_LONG = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const el = (sel)=> document.querySelector(sel);
function getQueryParams(){ const p={}; const s=location.search; if(!s) return p; s.substring(1).split('&').forEach(x=>{const[k,v]=x.split('='); p[decodeURIComponent(k)]=decodeURIComponent(v||'')}); return p;}
function norm(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,''); }
function regionKeyFromInput(v){ const s=(v||'').toUpperCase().replace(/\s+REGION\b/,'').trim(); if(REGION_BRANCHES[s]) return s; for(const k of Object.keys(REGION_BRANCHES)){ if(norm(k)===norm(s)) return k; } return s; }
function toNumber(v){ if (v===null || v===undefined || v==='') return NaN; const n=parseFloat(String(v).replace(/[^0-9.\-]/g,'')); return isNaN(n)?NaN:n; }
function fmtNumIndian(n){ if (!isFinite(n)) return 'â€”'; const isInt=Math.abs(n%1)<1e-9; return isInt?Number(Math.round(n)).toLocaleString('en-IN'):Number(n).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function withPercent(val){ if (val===null || val===undefined || String(val).trim()==='') return 'â€”'; const s=String(val).trim(); if (s.endsWith('%')) return s; const n=Number(s.replace(/,/g,'')); return !isNaN(n)?(n.toFixed(2)+' %'):s+' %'; }
function isRegularCollectionLabel(label){ const s=(label||'').toLowerCase(); return s.includes('regular')&&s.includes('collection')||s.includes('collection efficiency')||s.trim()==='ce'; }
function isIdentifierLabel(label){ const s=(label||'').toLowerCase(); return s.includes('code')||s.includes(' id')||s.endsWith(' id')||s.includes('account no')||s.includes('mobile')||s.includes('phone'); }
function isReverseDiffLabel(label){ const s=(label||'').toLowerCase().replace(/[\u2013\u2014]/g,'-'); if(s.includes('ftod')&&s.includes('addition')&&(s.includes('account')||s.includes('accounts')))return true; if(s.includes('ftod')&&s.includes('par')&&s.includes('addition'))return true; if(s.includes('incremental')&&s.includes('par')&&(s.includes('1+')||s.includes('1 +')||s.includes('1 plus')||s.includes('1par')))return true; if(s.includes('incremental')&&s.includes('npa'))return true; return false; }

/* ðŸš« Removed "Branch Code" row */
const DEFAULT_PARAMS = [
  'Disbursement Vol â€“ Amt','Total POS','Regular Collection %','FTOD Addition â€“ Accounts',
  'FTOD PAR Addition','Incremental 1+ PAR','Incremental NPA','Total NPA Collections â€“ Accounts',
  'Total NPA Collections â€“ Amount','Total Collections â€“ Accounts','Total Collections â€“ Amount'
];

/* ====== Supabase ====== */
let supabaseClient = null;
function ensureClient(){ if(!supabaseClient){ supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } }

/* ====== Column helpers ====== */
function smartMatchTitleToColumn(desired, cols){
  if (!desired) return '';
  if (cols.includes(desired)) return desired;
  const nDesired = norm(desired);
  for (const c of cols){ if (norm(c) === nDesired) return c; }
  const tokens = (desired.toLowerCase().match(/[a-z0-9]+/g) || []);
  let best='', score=0;
  for (const c of cols){ const lc=c.toLowerCase(); let s=0; tokens.forEach(t=>{ if(lc.includes(t)) s++; }); if (s>score){ score=s; best=c; } }
  return score?best:'';
}
function pickMonthColumn(cols){
  const exact = cols.find(c => c.toLowerCase() === 'month'); if (exact) return exact;
  const cands = cols.filter(c=>{ const n=norm(c); return /(^|[^a-z])month([^a-z]|$)/.test(n)||n.includes('mnth')||n==='mth'||n.endsWith('month')||n.startsWith('month'); });
  if (cands.length) cands.sort((a,b)=>a.length-b.length);
  return cands[0] || '';
}
function pickBranchNameColumn(cols){
  const aliases=['Branch Name','branch name','branch_name','branch','Branch','BranchName'];
  for (const a of aliases){ const pick=smartMatchTitleToColumn(a, cols); if (pick) return pick; }
  const nCols=cols.map(c=>({raw:c,n:norm(c)})); const hit=nCols.find(o=>o.n.includes('branch')&&o.n.includes('name')); return hit?hit.raw:'';
}
function monthIndexFromValue(v){
  if (typeof v === 'number'){ const n=Math.floor(v); return (n>=1&&n<=12)?n:null; }
  const s=String(v||'').toLowerCase(); const map={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,july:7,jul:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12};
  for (const k in map){ if (s.includes(k)) return map[k]; }
  const d=new Date(s); if (!isNaN(d.getTime())) return d.getMonth()+1;
  const m=parseInt(s,10); return (!isNaN(m)&&m>=1&&m<=12)?m:null;
}

/* ====== Data fetch ====== */
async function fetchColumns(){ ensureClient(); try{ const { data } = await supabaseClient.from(TABLE_NAME).select('*').limit(1); if (data&&data.length){ return Object.keys(data[0]); } }catch{} return []; }
async function computeAvailableMonths(cols){
  ensureClient(); const monthCol=pickMonthColumn(cols); if(!monthCol) return [];
  const { data, error } = await supabaseClient.from(TABLE_NAME).select(`"${monthCol}"`).limit(ROW_LIMIT);
  if (error||!data) return []; const seen=new Set();
  for (const row of data){ const idx=monthIndexFromValue(row[monthCol]); if (idx!=null) seen.add(idx); }
  return Array.from(seen).sort((a,b)=>a-b).map(i=>MONTHS_LONG[i-1]);
}
async function loadRowsForBranches(branchCol, monthCol, metrics, branches){
  ensureClient(); const selectList=[`"${monthCol}"`,`"${branchCol}"`,...metrics.map(m=>`"${m}"`)].join(',');
  try{
    const { data, error } = await supabaseClient.from(TABLE_NAME).select(selectList).in(branchCol, branches).limit(ROW_LIMIT);
    if (error) throw error; return data||[];
  }catch(e){
    const chunks=[]; for (const b of branches){ const { data } = await supabaseClient.from(TABLE_NAME).select(selectList).eq(branchCol, b).limit(ROW_LIMIT); if (data&&data.length) chunks.push(...data); }
    return chunks;
  }
}

/* ====== UI builders ====== */
function buildMatrixSkeleton(tbody, rows){
  tbody.innerHTML=''; for (let i=0;i<rows;i++){ const tr=document.createElement('tr');
    tr.innerHTML=`<td class="paramLabel">â€”</td><td class="bVal">â€”</td><td class="cVal">â€”</td><td class="dVal">â€”</td>`; tbody.appendChild(tr); }
}
function setRowDisplay(cells, label, vb, vc, reverse, isPct, isId){
  const [tdLabel, tdB, tdC, tdD]=cells; tdLabel.textContent=label||'â€”';
  const nb=Number.isFinite(vb)?vb:toNumber(vb); const nc=Number.isFinite(vc)?vc:toNumber(vc);
  tdB.textContent=Number.isFinite(nb)?(isPct?withPercent(nb):fmtNumIndian(nb)):'â€”';
  tdC.textContent=Number.isFinite(nc)?(isPct?withPercent(nc):fmtNumIndian(nc)):'â€”';
  if (Number.isFinite(nb)&&Number.isFinite(nc)){
    const d=nc-nb; const pretty=isPct?withPercent(d):fmtNumIndian(d);
    const cls=reverse?(d>0?'text-red-600 font-semibold':d<0?'text-green-600 font-semibold':'text-slate-600')
                     :(d>0?'text-green-600 font-semibold':d<0?'text-red-600 font-semibold':'text-slate-600');
    tdD.innerHTML=`<span class="${cls}">${pretty}</span>`;
  } else { tdD.textContent='â€”'; }
}

/* ====== MAIN ====== */
(async function main(){
  const hdrTitle=el('#hdrTitle'); const hdrBadge=el('#hdrBadge'); const statusLine=el('#statusLine');
  const thB=el('#thB'), thC=el('#thC'); const finalBody=el('#finalBody');
  const pgGrid=el('#progressGrid'); const pgCount=el('#pgCount'); const pgLabel=el('#pgLabel');

  // Print + logo
  el('#btnPrint').addEventListener('click', ()=> window.print());
  window.addEventListener('beforeprint', ()=>{ const wrap=document.querySelector('.progress-wrap'); if(wrap) wrap.style.display='none'; });
  window.addEventListener('afterprint', ()=>{ const wrap=document.querySelector('.progress-wrap'); if(wrap) wrap.style.removeProperty('display'); });
  document.querySelectorAll('.logo').forEach(img=>img.addEventListener('click', ()=>{ if(history.length>1) history.back(); else if(document.referrer) location.href=document.referrer; else location.href='./'; }));

  // Region
  const qp=getQueryParams(); const inputRegion=qp.region||qp.name||qp.r||'TUMKUR REGION';
  const regionKey=regionKeyFromInput(inputRegion); const branches=REGION_BRANCHES[regionKey]||[];
  hdrTitle.textContent=`${regionKey} (${branches.length} branches)`;

  // Progress dots
  pgGrid.innerHTML=''; branches.forEach((b,i)=>{ const dot=document.createElement('div'); dot.className='dot'; dot.title=b; dot.innerHTML=`<div class="ring"></div><div class="num">${i+1}</div>`; pgGrid.appendChild(dot); });
  pgCount.textContent=`0/${branches.length}`;

  // Columns & params
  hdrBadge.textContent='Preparingâ€¦'; ensureClient(); const cols=await fetchColumns();
  if(!cols.length){ hdrBadge.textContent='No columns'; statusLine.textContent='Could not discover columns from table.'; return; }
  const monthCol=pickMonthColumn(cols); const branchCol=pickBranchNameColumn(cols);
  const paramCols=DEFAULT_PARAMS.map(desired=>smartMatchTitleToColumn(desired, cols)||desired);
  if(!monthCol||!branchCol){ hdrBadge.textContent='Missing mapping'; statusLine.textContent=`Could not identify ${!monthCol?'Month':'Branch Name'} column.`; return; }

  // Build table skeleton now that we know the param count (11 rows)
  buildMatrixSkeleton(finalBody, paramCols.length);
  Array.from(finalBody.querySelectorAll('tr')).forEach((tr,i)=>{ tr.querySelector('.paramLabel').textContent=paramCols[i]||'â€”'; });

  // Months
  let months=await computeAvailableMonths(cols);
  let labelPrev='Prev Month', labelCurr='Current Month';
  if(months&&months.length){ const last=months[months.length-1]; const prev=months[months.length-2]||last; labelPrev=prev; labelCurr=last; }
  thB.textContent=labelPrev; thC.textContent=labelCurr;

  // Fetch rows for region branches
  hdrBadge.textContent='Fetchingâ€¦';
  const metricsUnique=Array.from(new Set(paramCols.filter(Boolean)));
  const rows=branches.length?await loadRowsForBranches(branchCol, monthCol, metricsUnique, branches):[];

  // Map branch -> monthIdx -> row
  const byBranchMonth=new Map();
  for(const r of rows){ const b=r[branchCol]; const mi=monthIndexFromValue(r[monthCol]); if(!b||!mi) continue; if(!byBranchMonth.has(b)) byBranchMonth.set(b,new Map()); byBranchMonth.get(b).set(mi,r); }
  const miB=monthIndexFromValue(labelPrev); const miC=monthIndexFromValue(labelCurr);

  // Aggregators
  const agg=paramCols.map(label=>({ label, isPct:isRegularCollectionLabel(label), isId:isIdentifierLabel(label), reverse:isReverseDiffLabel(label), sumB:0,sumC:0,cntB:0,cntC:0 }));

  // Sequential calc + spinner
  hdrBadge.textContent='Calculatingâ€¦';
  const dots=Array.from(pgGrid.children);
  for(let i=0;i<branches.length;i++){
    const bName=branches[i]; const dot=dots[i]; if(dot) dot.classList.add('active');
    try{
      const m=byBranchMonth.get(bName)||new Map(); const rowB=miB?m.get(miB):null; const rowC=miC?m.get(miC):null;
      for(const A of agg){ if(A.isId) continue; const vb=rowB?rowB[A.label]:null; const vc=rowC?rowC[A.label]:null;
        const nb=toNumber(vb), nc=toNumber(vc); if(Number.isFinite(nb)){ A.sumB+=nb; A.cntB+=(A.isPct?1:0); } if(Number.isFinite(nc)){ A.sumC+=nc; A.cntC+=(A.isPct?1:0); } }
      await new Promise(r=>setTimeout(r,60));
      if(dot){ dot.classList.remove('active'); dot.classList.add('done'); }
    }catch(e){ if(dot){ dot.classList.remove('active'); dot.classList.add('error'); } }
    pgCount.textContent=`${i+1}/${branches.length}`;
  }

  // Paint table
  const finalRows=Array.from(finalBody.querySelectorAll('tr'));
  for(let i=0;i<agg.length;i++){
    const A=agg[i]; const vb=A.isPct?(A.cntB?A.sumB/A.cntB:NaN):A.sumB; const vc=A.isPct?(A.cntC?A.sumC/A.cntC:NaN):A.sumC;
    const tr=finalRows[i]; const cells=[tr.children[0],tr.children[1],tr.children[2],tr.children[3]];
    setRowDisplay(cells,A.label,vb,vc,A.reverse,A.isPct,A.isId);
  }

  // Cache
  try{
    const cacheKey=`nlpl.region.cache.${regionKey}`;
    sessionStorage.setItem(cacheKey, JSON.stringify({ region:regionKey, branches, monthsChosen:{prev:labelPrev,curr:labelCurr}, aggregated:agg.map(a=>({label:a.label,isPct:a.isPct,isId:a.isId,reverse:a.reverse,B:a.isPct?(a.cntB?a.sumB/a.cntB:null):a.sumB,C:a.isPct?(a.cntC?a.sumC/a.cntC:null):a.sumC})), ts:new Date().toISOString() }));
  }catch{}

  hdrBadge.textContent=`live summary â€¢ ${regionKey}`;

  /* Clean up the small status label: blank immediately and remove after 6s */
  if (pgLabel){ pgLabel.textContent=''; setTimeout(()=>{ if(pgLabel&&pgLabel.parentElement) pgLabel.remove(); },6000); }
})();
</script>
</body>
</html>
