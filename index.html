<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NLPL / NMSPL ‚Äì Org Select + Login + Directory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ‚úÖ CHATBASE EMBED (replace id with your real Chatbase widget id) -->
  <script src="https://www.chatbase.co/embed.min.js" id="YOUR_CHATBASE_ID"></script>

  <style>
    :root{
      --bg:#ffffff; --frame:#ffffff; --ink:#0f172a; --muted:#6b7280; --line:rgba(17,24,39,.08);
      --accent:#e46357; --accent-2:#e9786f;
      --indigo-1:#6366f1; --indigo-2:#8b5cf6;
      --glow-1:#f472b6; --glow-2:#60a5fa; --glow-3:#34d399;
    }

    html,body{height:100%}
    body{
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial;
      color:var(--ink);
      background:var(--bg);
      overflow-x:hidden;
    }

    /* ---------- Decorative backgrounds (no logic change) ---------- */
    #viewOrgChoice, #viewLogin{
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(99,102,241,.08), transparent 60%),
        radial-gradient(1000px 700px at 120% 120%, rgba(233,99,87,.06), transparent 60%),
        radial-gradient(circle at 1px 1px, rgba(15,23,42,.06) 1px, transparent 0) 0 0/24px 24px,
        var(--bg);
    }
    #viewOrgChoice::before, #viewLogin::before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.35));
      mask:linear-gradient(180deg, rgba(0,0,0,.6), transparent 60%);
    }

    /* ---------- GENERAL CARDS / BUTTONS ---------- */
    .frame{
      border:6px solid var(--frame);
      border-radius:28px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.78));
      overflow:hidden;
      position:relative;
      box-shadow:
        0 20px 60px rgba(2, 8, 23, .08),
        inset 0 1px 0 rgba(255,255,255,.5);
      backdrop-filter:saturate(1.2) blur(10px);
      animation:cardPulse 10s ease-in-out infinite;
    }
    .frame::before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:inherit;
      background:conic-gradient(from 90deg, rgba(99,102,241,.35), rgba(236,72,153,.35), rgba(99,102,241,.35));
      opacity:.45;
      filter:blur(18px);
      z-index:-1;
      animation:borderGlow 12s linear infinite;
    }
    .logo{width:min(72%,360px); height:auto; object-fit:contain}

    .input{
      appearance:none;width:100%;
      border-radius:12px;border:1px solid #e5e7eb;background:#fff;
      padding:.75rem .9rem;outline:none;
      transition:border-color .2s,box-shadow .2s, transform .06s ease;
      text-transform:uppercase; /* UX: normalize */
    }
    .input:focus{border-color:#c7d2fe;box-shadow:0 0 0 6px rgba(99,102,241,.12)}
    .input:active{transform:scale(.998)}

    .otp-grid{display:grid;grid-template-columns:repeat(var(--digits,6),1fr);gap:.6rem}
    .otp-cell{
      text-align:center;letter-spacing:.04em;font-weight:800;font-size:1.15rem;
      font-variant-numeric:tabular-nums;
      text-transform:uppercase;
    }

    @keyframes roll{0%{filter:brightness(.95)}50%{filter:brightness(1.05)}100%{filter:brightness(1)}}
    @keyframes flipIn{0%{transform:rotateX(0)}60%{transform:rotateX(360deg)}100%{transform:rotateX(360deg)}}
    .rolling{animation:roll .6s ease-in-out}
    .flip{animation:flipIn .6s ease-in-out}

    /* ---------- ORG CHOICE BIG BUTTONS ---------- */
    .org-btn{
      border-radius:22px;border:2px solid rgba(15,23,42,.06);background:#fff;
      padding:28px;
      box-shadow:0 24px 60px rgba(2, 8, 23, .08);
      transition:transform .15s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
      position:relative; isolation:isolate;
      overflow:hidden;
    }
    .org-btn::after{
      content:""; position:absolute; inset:0; border-radius:20px; z-index:-1;
      background:linear-gradient(135deg, rgba(99,102,241,.12), rgba(233,99,87,.10));
      opacity:.0; transition:opacity .2s ease;
    }
    .org-btn::before{
      content:""; position:absolute; inset:-2px; border-radius:24px; z-index:-2;
      background:conic-gradient(from 0deg, rgba(96,165,250,.35), rgba(244,114,182,.45), rgba(129,140,248,.4));
      opacity:.7; filter:blur(25px);
      animation:gradientOrbit 6s linear infinite;
    }
    .org-btn:hover{
      transform:translateY(-2px);
      box-shadow:0 28px 70px rgba(2, 8, 23, .12);
      border-color:rgba(99,102,241,.35);
    }
    .org-btn:hover::after{opacity:1}
    .org-title{font-size:clamp(22px,4vw,40px);font-weight:900;letter-spacing:.01em}
    .org-sub{color:#6b7280}

    /* ---------- DIRECTORY THEME (dark) ---------- */
    .dir-wrap{
      min-height:100vh;
      background:
        radial-gradient(1200px 800px at -10% -10%, rgba(99,102,241,.18), transparent 55%),
        radial-gradient(1000px 700px at 110% 120%, rgba(8,145,178,.18), transparent 55%),
        #0b1020;
      color:#e6ebff;
    }
    #linkContainer{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(260px,1fr));
      gap:14px;
    }
    .card{
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;padding:16px 18px;
      display:flex;align-items:center;justify-content:space-between;
      transition:background .18s ease, transform .1s ease, border-color .18s ease;
      box-shadow:0 8px 24px rgba(0,0,0,.18);
    }
    .card:hover{background:rgba(255,255,255,0.09);transform:translateY(-2px);border-color:rgba(255,255,255,0.18);}
    .details{font-weight:600; letter-spacing:.2px}

    .button-link{
      background:linear-gradient(135deg,var(--indigo-1),var(--indigo-2));
      color:#fff;padding:10px 14px;border-radius:10px;
      text-decoration:none;font-weight:600;white-space:nowrap;
      box-shadow:0 0 0 0 rgba(139,92,246,.0);
      transition:transform .1s ease, box-shadow .15s ease, filter .15s ease;
    }
    .button-link:hover{transform:translateY(-1px); filter:brightness(1.05); box-shadow:0 6px 18px rgba(139,92,246,.35);}

    /* ---------- Name Suggest dropdown ---------- */
    #nameSuggest{
      background:rgba(255,255,255,.9);
      backdrop-filter:saturate(1.2) blur(8px);
      border-radius:14px;
      border:1px solid rgba(15,23,42,.08);
      box-shadow:0 18px 45px rgba(2,8,23,.12);
      overflow:auto;
      max-height: 320px;
    }
    #nameSuggest > div{transition:background .12s ease}
    #nameSuggest > div:hover{background:rgba(99,102,241,.09)}

    /* ---------- Status text ---------- */
    #status{min-height:1.25rem}

    /* ---------- Buttons (CTA) ---------- */
    .cta{
      display:inline-flex; align-items:center; justify-content:center;
      border-radius:999px; padding:.9rem 1.1rem; font-weight:700; color:#fff;
      box-shadow:0 10px 24px rgba(233,99,87,.25);
      transition:transform .1s ease, filter .15s ease, box-shadow .15s ease;
      position:relative;
      overflow:hidden;
    }
    .cta::after{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(120deg,rgba(255,255,255,.4),rgba(255,255,255,0));
      transform:translateX(-120%);
      animation:ctaShine 4s ease-in-out infinite;
    }
    .cta:hover{transform:translateY(-1px); filter:brightness(1.02);}
    .cta:active{transform:translateY(0);}

    /* ---------- Ambient d√©cor ---------- */
    #viewOrgChoice > main,
    #viewLogin > main{position:relative; z-index:1;}
    .hero-ambient,
    .login-ambient{
      position:absolute;
      inset:-10% -5%;
      pointer-events:none;
      z-index:0;
    }
    .hero-ambient span,
    .login-ambient span{
      position:absolute;
      width:220px;
      height:220px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 30%, rgba(96,165,250,.25), transparent 60%);
      filter:blur(0px);
      opacity:.8;
      top:var(--y,20%);
      left:var(--x,20%);
      animation:floatDrift var(--time,14s) ease-in-out infinite;
      animation-delay:var(--delay,0s);
    }
    .hero-ambient span:nth-child(2){background:radial-gradient(circle at 60% 30%, rgba(244,114,182,.25), transparent 60%);}
    .hero-ambient span:nth-child(3){background:radial-gradient(circle at 50% 50%, rgba(52,211,153,.25), transparent 65%);}
    .hero-badges{
      display:flex; justify-content:center; gap:.75rem; flex-wrap:wrap;
      margin-top:1.75rem;
    }
    .hero-badges span{
      font-size:.7rem; letter-spacing:.12em; text-transform:uppercase;
      border:1px solid rgba(15,23,42,.08); border-radius:999px;
      padding:.4rem .95rem;
      color:var(--muted);
      background:rgba(255,255,255,.85);
      box-shadow:0 12px 25px rgba(15,23,42,.06);
      animation:badgePulse 5s ease-in-out infinite;
    }
    .hero-badges span:nth-child(2){animation-delay:.3s}
    .hero-badges span:nth-child(3){animation-delay:.6s}

    .login-pills{
      display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.25rem;
    }
    .login-pills span{
      font-size:.68rem; letter-spacing:.08em; text-transform:uppercase;
      padding:.3rem .85rem;
      border-radius:999px;
      border:1px solid rgba(99,102,241,.18);
      background:rgba(255,255,255,.9);
      color:#4c1d95;
      animation:badgePulse 4.2s ease-in-out infinite;
    }
    .login-pills span:nth-child(2){animation-delay:.2s}
    .login-pills span:nth-child(3){animation-delay:.4s}

    /* ---------- Animations ---------- */
    @keyframes floatDrift{
      0%{transform:translate3d(0,0,0) scale(.8); opacity:.4;}
      50%{transform:translate3d(30px,-40px,0) scale(1.05); opacity:.75;}
      100%{transform:translate3d(-10px,10px,0) scale(.8); opacity:.4;}
    }
    @keyframes gradientOrbit{
      0%{transform:rotate(0deg);}
      100%{transform:rotate(360deg);}
    }
    @keyframes cardPulse{
      0%,100%{box-shadow:0 20px 60px rgba(2,8,23,.10);}
      50%{box-shadow:0 25px 70px rgba(2,8,23,.18);}
    }
    @keyframes borderGlow{
      0%{opacity:.4;}
      50%{opacity:.8;}
      100%{opacity:.4;}
    }
    @keyframes badgePulse{
      0%,100%{transform:translateY(0); box-shadow:0 8px 18px rgba(99,102,241,.12);}
      50%{transform:translateY(-6px); box-shadow:0 18px 25px rgba(244,114,182,.18);}
    }
    @keyframes ctaShine{
      0%{transform:translateX(-120%);}
      40%{transform:translateX(120%);}
      100%{transform:translateX(120%);}
    }

    @media (prefers-reduced-motion: reduce){
      .hero-ambient span,
      .login-ambient span,
      .hero-badges span,
      .login-pills span,
      .frame,
      .cta::after,
      .org-btn::before{animation:none !important;}
    }

    /* ---------- Small tweaks for mobile spacing ---------- */
    @media (max-width: 1024px){
      #viewOrgChoice main{padding-inline:clamp(1.25rem,4vw,2rem);}
      #viewOrgChoice .grid{gap:1.25rem;}
      .org-btn{padding:22px;}
      .org-btn .org-title{font-size:clamp(20px,3vw,36px);}
      #viewDirectory .max-w-4xl{padding-inline:clamp(1rem,6vw,2.5rem);}
    }

    @media (max-width: 640px){
      .frame{border-width:4px;border-radius:22px}
      .otp-cell{font-size:1.05rem}
      #viewOrgChoice header{padding-inline:1rem;}
      #viewOrgChoice h1{font-size:clamp(1.75rem,6vw,2.5rem);}
      #viewLogin .frame{padding:0;}
      #viewDirectory .max-w-4xl{padding-inline:1rem;}
    }
  </style>
</head>
<body>

  <!-- ============= VIEW: ORGANIZATION CHOICE ============= -->
  <section id="viewOrgChoice" class="min-h-screen flex items-center justify-center p-6">
    <div class="hero-ambient" aria-hidden="true">
      <span style="--x:8%;--y:15%;--time:18s;"></span>
      <span style="--x:70%;--y:10%;--time:20s;--delay:.6s;"></span>
      <span style="--x:55%;--y:65%;--time:15s;--delay:1.2s;"></span>
      <span style="--x:15%;--y:70%;--time:22s;--delay:.9s;"></span>
    </div>
    <main class="w-full max-w-5xl">
      <header class="text-center mb-10">
        <h1 class="text-3xl sm:text-4xl font-black text-green-600 tracking-tight">SELECT YOUR ENTITY</h1>
        <p class="text-[var(--muted)] mt-2">Pick where you want to go. We‚Äôll tailor the login and links accordingly.</p>
        <div class="hero-badges" aria-hidden="true">
          <span>Single Sign-on</span>
          <span>Realtime Directory</span>
          <span>Launchpad Access</span>
        </div>
      </header>

      <div class="grid sm:grid-cols-2 gap-6">
        <!-- NMSPL -->
        <button id="btnChooseNMSPL" class="org-btn text-left">
          <div class="flex items-center gap-4">
            <div class="h-14 w-14 rounded-xl bg-indigo-50 flex items-center justify-center">
              <span class="text-2xl">üè¢</span>
            </div>
            <div>
              <div class="org-title text-indigo-600">NMSPL</div>
              <div class="org-sub">Go to NMSPL branch location (password login)</div>
            </div>
          </div>
        </button>

        <!-- NLPL -->
        <button id="btnChooseNLPL" class="org-btn text-left">
          <div class="flex items-center gap-4">
            <div class="h-14 w-14 rounded-xl bg-rose-50 flex items-center justify-center">
              <span class="text-2xl">üåê</span>
            </div>
            <div>
              <div class="org-title text-rose-600">NLPL</div>
              <div class="org-sub">Open the full directory (no password)</div>
            </div>
          </div>
        </button>
      </div>
    </main>
  </section>

  <!-- ============= VIEW: LOGIN (Shared Shell) ============= -->
  <section id="viewLogin" class="min-h-screen hidden flex items-center justify-center p-4 sm:p-6">
    <div class="login-ambient" aria-hidden="true">
      <span style="--x:12%;--y:20%;--time:18s;"></span>
      <span style="--x:80%;--y:15%;--time:20s;--delay:.5s;"></span>
      <span style="--x:60%;--y:75%;--time:16s;--delay:1s;"></span>
    </div>
    <main class="frame w-full max-w-6xl grid lg:grid-cols-2">
      <!-- LEFT / TOP on mobile: Logo -->
      <section class="p-6 sm:p-8 md:p-10 flex items-center justify-center order-1">
        <img id="orgLogo" src="./NLPL Logo.jpg" alt="Organization Logo" class="logo" />
      </section>

      <!-- RIGHT / BOTTOM on mobile -->
      <section class="p-5 sm:p-8 md:p-10 flex flex-col gap-6 order-2">
        <div>
          <h1 id="welcomeTitle" class="text-2xl sm:text-3xl md:text-4xl font-black leading-tight">Welcome</h1>
          <p id="welcomeSub" class="text-gray-500 mt-1">Please sign in</p>
          <div class="login-pills" aria-hidden="true">
            <span>Encrypted Flow</span>
            <span>Supabase Sync</span>
            <span>Chatbase Ready</span>
          </div>
        </div>

        <!-- ===== NLPL Pane (name only) ===== -->
        <div id="nlplPane" class="grid gap-5">
          <div class="relative">
            <label class="block text-sm text-gray-500 mb-1">Name</label>
            <input id="nameInput" class="input" type="text" placeholder="Start typing your name‚Ä¶" autocomplete="off" />
            <div id="nameSuggest" class="absolute left-0 right-0 top-[calc(100%+6px)] hidden z-10"></div>
            <p class="mt-1 text-xs text-gray-400">Just pick your name and we‚Äôll load the rest automatically.</p>
          </div>

          <button id="continueBtn" class="cta w-full shadow-sm active:scale-[.99]"
            style="background:linear-gradient(180deg,var(--accent),var(--accent-2))">Continue</button>
        </div>

        <!-- ===== NMSPL Pane (username + password) ===== -->
        <div id="nmsplPane" class="grid gap-5 hidden">
          <div>
            <label class="block text-sm text-gray-500 mb-1">Username</label>
            <input id="nmsplUser" class="input" type="text" placeholder="Enter username" autocomplete="username" />
          </div>
          <div>
            <label class="block text-sm text-gray-500 mb-1">Password</label>
            <input id="nmsplPass" class="input" type="password" placeholder="Enter password" autocomplete="current-password" />
            <p class="mt-1 text-xs text-gray-400">Username: <b>NMSPL</b> / <b>Nmspl@123</b></p>
          </div>
          <button id="nmsplLoginBtn" class="cta w-full shadow-sm active:scale-[.99]"
            style="background:linear-gradient(180deg,#6366f1,#8b5cf6)">Login to NMSPL</button>
        </div>

        <div class="mt-1 text-center">
          <div id="status" class="text-sm text-gray-500"></div>
        </div>

        <div class="text-center">
          <button id="backToOrg" class="text-xs text-gray-500 hover:text-gray-700 underline">‚Üê Choose a different organization</button>
        </div>
      </section>
    </main>
  </section>

  <!-- ============= VIEW: DIRECTORY (NLPL) ============= -->
  <section id="viewDirectory" class="dir-wrap hidden">
    <div class="max-w-4xl mx-auto p-6 sm:p-8">
      <div class="flex flex-col gap-4 mb-6 lg:flex-row lg:items-center lg:justify-between">
        <div class="flex flex-col items-center gap-3 lg:flex-row lg:items-center">
          <img src="./NLPL Logo.jpg" alt="Company Logo" class="h-12 w-auto" />
          <div class="text-center lg:text-left">
            <h1 class="text-2xl sm:text-3xl font-semibold text-indigo-300">üåê NLPL Website Link Directory</h1>
            <p class="mt-1 text-sm text-indigo-2 00">
              <span class="inline-block px-2 py-1 rounded bg-white/10 border border-white/10 mr-2">üîê Login Integrated</span>
              Welcome back, <span id="welcomeName" class="font-semibold"></span>
              <span class="opacity-80">‚Äî ID:</span> <span id="welcomeId" class="font-mono"></span>
            </p>
          </div>
        </div>
        <div class="flex gap-3 justify-center lg:justify-end">
          <button id="signOutBtn" class="text-xs px-3 py-2 rounded border border-white/15 hover:bg-white/10">Sign out</button>
          <button id="switchOrgBtn" class="text-xs px-3 py-2 rounded border border-white/15 hover:bg-white/10">Switch org</button>
        </div>
      </div>

      <div id="linkContainer"></div>
    </div>
  </section>

  <script>
    /* ================== Supabase (only for NLPL login) ================== */
    const supabaseUrl = "https://zovnmmdfthpbubrorsgh.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvdm5tbWRmdGhwYnVicm9yc2doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NzE3ODgsImV4cCI6MjA3NzE0Nzc4OH0.92BH2sjUOgkw6iSRj1_4gt0p3eThg3QT4VK-Q4EdmBE";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    const tableName = "PROFILE_DEMO";
    const profileTableName = "PROFILE_DEMO";

    /* ================== Chatbase Identity Endpoint ================== */
    // ‚õ≥ Set this to your deployed backend when live (e.g., https://api.yourdomain.com/get-user-token)
    const CHATBASE_TOKEN_ENDPOINT = "http://localhost:3000/get-user-token";

    /* ================== Elements ================== */
    const viewOrgChoice = document.getElementById('viewOrgChoice');
    const viewLogin = document.getElementById('viewLogin');
    const viewDirectory = document.getElementById('viewDirectory');

    const orgLogo = document.getElementById('orgLogo');
    const welcomeTitle = document.getElementById('welcomeTitle');
    const welcomeSub = document.getElementById('welcomeSub');

    const nlplPane = document.getElementById('nlplPane');
    const nmsplPane = document.getElementById('nmsplPane');

    const statusEl = document.getElementById('status');
    const backToOrg = document.getElementById('backToOrg');

    const nameInput = document.getElementById('nameInput');
    const nameSuggest = document.getElementById('nameSuggest');
    const continueBtn = document.getElementById('continueBtn');

    const nmsplUser = document.getElementById('nmsplUser');
    const nmsplPass = document.getElementById('nmsplPass');
    const nmsplLoginBtn = document.getElementById('nmsplLoginBtn');

    const welcomeName = document.getElementById('welcomeName');
    const welcomeId = document.getElementById('welcomeId');
    const signOutBtn = document.getElementById('signOutBtn');
    const switchOrgBtn = document.getElementById('switchOrgBtn');

/* ================== Org choice buttons ================== */
document.getElementById('btnChooseNMSPL').addEventListener('click', ()=> chooseOrg('NMSPL'));
document.getElementById('btnChooseNLPL').addEventListener('click', ()=> chooseOrg('NLPL'));


    backToOrg.addEventListener('click', ()=>{
      viewLogin.classList.add('hidden');
      viewDirectory.classList.add('hidden');
      viewOrgChoice.classList.remove('hidden');
      statusEl.textContent='';
    });

    let currentOrg = null;
    let selectedRole = null; // remember Role from autoFill

    function chooseOrg(org){
      currentOrg = org;
      // Update branding + panes
      if(org==='NMSPL'){
        orgLogo.src = './NMSPL logo.png';
        welcomeTitle.textContent = 'Welcome to NMSPL';
        welcomeSub.textContent = 'Please sign in with username & password';
        nlplPane.classList.add('hidden');
        nmsplPane.classList.remove('hidden');
      }else{
        orgLogo.src = './NLPL Logo.jpg';
        welcomeTitle.textContent = 'Welcome';
        welcomeSub.textContent = 'Please enter your name';
        nmsplPane.classList.add('hidden');
        nlplPane.classList.remove('hidden');
      }
      // Show login
      viewOrgChoice.classList.add('hidden');
      viewDirectory.classList.add('hidden');
      viewLogin.classList.remove('hidden');
      window.scrollTo({top:0,behavior:"instant"});
    }

    let selectedRecord = null;

    /* ================== NLPL: Load Names ================== */
    let nameList = [];
    async function loadNames(){
      const { data, error } = await supabaseClient.from(tableName).select('Name').limit(20000);
      if(error){ statusEl.textContent='Failed to load names.'; statusEl.style.color='#ef4444'; return; }
      nameList = [...new Set((data||[]).map(r=>r.Name).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
    }
    loadNames();

    async function fetchProfileRecord(empId){
      if(!empId) return null;
      try{
        const { data, error } = await supabaseClient
          .from(profileTableName)
          .select('*')
          .eq('Employee ID', empId)
          .limit(1);
        if(error) throw error;
        return (data && data[0]) ? data[0] : null;
      }catch(err){
        console.warn('Unable to fetch NLPL profile record', err);
        return null;
      }
    }

    function renderSuggest(items){
      if(!items.length){ nameSuggest.innerHTML=''; nameSuggest.classList.add('hidden'); return; }
      nameSuggest.innerHTML = items.slice(0,80).map((n,i)=>`<div class="px-3 py-2 hover:bg-gray-100 cursor-pointer" data-idx="${i}">${n}</div>`).join('');
      nameSuggest.classList.remove('hidden');
    }

    nameInput?.addEventListener('input',()=>{
      const q = nameInput.value.trim();
      selectedRecord = null;
      selectedRole = null;
      if(q.length<2){ renderSuggest([]); return; }
      const m = nameList.filter(n => n.toLowerCase().includes(q.toLowerCase()));
      renderSuggest(m);
    });

    nameSuggest?.addEventListener('click',e=>{
      const item = e.target.closest('[data-idx]');
      if(!item) return;
      const val = item.textContent.trim();
      nameInput.value = val;
      nameSuggest.classList.add('hidden');
      autoFillByName(val);
    });

    // click-away to close suggestions
    document.addEventListener('click', (e)=>{
      if(!nameSuggest.classList.contains('hidden')){
        if(!nameSuggest.contains(e.target) && e.target !== nameInput){
          nameSuggest.classList.add('hidden');
        }
      }
    });

    nameInput?.addEventListener('keydown',(e)=>{
      if(e.key==='Enter'){
        e.preventDefault();
        const first = nameSuggest.querySelector('[data-idx]');
        if(first) first.click();
      }
    });

    /* ================== NLPL: Auto-fill by Name ================== */
    async function autoFillByName(name){
      statusEl.textContent = 'Fetching profile details‚Ä¶';
      statusEl.style.color = '#6b7280';

      const { data, error } = await supabaseClient
        .from(tableName)
        .select('*')
        .eq('Name', name)
        .limit(10);

      if(error || !data || !data.length){
        statusEl.textContent = error?.message || 'No record found for that name.';
        statusEl.style.color = '#ef4444';
        selectedRecord = null;
        selectedRole = null;
        return;
      }

      const preferred = data.find(r => r.Role === 'BOE') || data[0];
      selectedRole = preferred.Role || null;
      selectedRecord = preferred;

      statusEl.textContent = `Profile for ${name} loaded.`;
      statusEl.style.color = '#16a34a';
    }

    /* ================== CHATBASE: Identify helper ================== */
    async function identifyWithChatbase(attrs){
      try{
        if(typeof window.chatbase !== "function") return; // widget not loaded
        const res = await fetch(CHATBASE_TOKEN_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(attrs)
        });
        const data = await res.json();
        if(data && data.token){
          window.chatbase("identify", { token: data.token });
          console.log("‚úÖ Chatbase identified:", attrs.name || attrs.email || attrs.user_id);
        }
      }catch(err){
        console.warn("Chatbase identify failed:", err);
      }
    }

    /* ================== CONTINUE (NLPL) ================== */
    continueBtn?.addEventListener('click', async ()=>{
      if(currentOrg!=='NLPL'){ return; }
      const nameVal = nameInput.value.trim();
      if(!nameVal){ statusEl.textContent='Please enter your name.'; statusEl.style.color='#ef4444'; return; }

      if(!selectedRecord || selectedRecord.Name !== nameVal){
        await autoFillByName(nameVal);
      }

      const empId = (selectedRecord?.['Employee ID'] || selectedRecord?.NMEmpId || '').toString();
      if(!empId){
        statusEl.textContent='Unable to determine Employee ID. Please pick a valid name from the list.';
        statusEl.style.color='#ef4444';
        return;
      }

      statusEl.textContent = 'Preparing your NLPL workspace‚Ä¶';
      statusEl.style.color = '#6b7280';

      localStorage.setItem('nlpl_user_name', nameVal);
      localStorage.setItem('nlpl_user_id', empId);

      const profileRecord = await fetchProfileRecord(empId);
      const payload = {
        name: nameVal,
        empId,
        role: selectedRole || null,
        profile: profileRecord,
        branch: {
          name: profileRecord?.["Branch Name"] || null,
          code: profileRecord?.["Branch Code"] || null,
          email: profileRecord?.["Branch Email ID"] || null
        }
      };
      try{
        localStorage.setItem('nlpl_profile_payload', JSON.stringify(payload));
      }catch(err){
        console.warn('Unable to store NLPL profile payload', err);
      }

      // üî• Chatbase identify
      identifyWithChatbase({ user_id: empId, name: nameVal, org: 'NLPL', role: selectedRole || undefined });

      window.location.href = './nlpl/index.html';
    });

    /* ================== NMSPL LOGIN ================== */
    nmsplLoginBtn?.addEventListener('click', ()=>{
      if(currentOrg!=='NMSPL'){ return; }
      const u = (nmsplUser.value || '').trim();
      const p = nmsplPass.value || '';
      if(u==='NMSPL' && p==='Nmspl@123'){
        statusEl.textContent = 'Login successful. Redirecting to NMSPL Branch Location‚Ä¶';
        statusEl.style.color = '#16a34a';

        // üî• Chatbase identify for NMSPL user (use username as id/name here)
        identifyWithChatbase({ user_id: u, name: u, org: 'NMSPL' });

        const target = './NMSPL%20BRANCH%20LOCATION/index.html';
        setTimeout(()=>{ window.location.href = target; }, 400);
      }else{
        statusEl.textContent = 'Invalid NMSPL credentials.';
        statusEl.style.color = '#ef4444';
      }
    });

    /* ================== Optional: auto-skip NLPL if we have user ================== */
    window.addEventListener('DOMContentLoaded', ()=>{
      const savedName = localStorage.getItem('nlpl_user_name');
      const savedId = localStorage.getItem('nlpl_user_id');
      if(savedName && savedId){
        if(!localStorage.getItem('nlpl_profile_payload')){
          const fallback = {
            name: savedName,
            empId: savedId,
            role: null,
            profile: null,
            branch: null
          };
          try{
            localStorage.setItem('nlpl_profile_payload', JSON.stringify(fallback));
          }catch(err){
            console.warn('Failed to persist NLPL payload on restore', err);
          }
        }
        window.location.href = './nlpl/index.html';
      }
    });

    /* ================== Directory content (NLPL view) ================== */
    const foldersAll = [
      "NLPL BRANCH LOCATION",
      "NMSPL BRANCH LOCATION",
      "NLPL AT A GLANCE",
      "RAISE YOUR CONCERN"
    ];
    function filteredFoldersForOrg(org){
      if(org==='NLPL'){
        // Remove NMSPL branch location
        return foldersAll.filter(f => f !== "NMSPL BRANCH LOCATION");
      }
      return foldersAll;
    }
    function mountDirectory(name, id, org='NLPL'){
      welcomeName.textContent = name || '';
      welcomeId.textContent = id || '';
      const folders = filteredFoldersForOrg(org);
      const container = document.getElementById("linkContainer");
      container.innerHTML = folders.map(label => `
        <div class="card">
          <div class="details">${label}</div>
          <a href="./${encodeURIComponent(label)}/index.html" class="button-link">Open Website ‚Üí</a>
        </div>
      `).join("");
    }

    /* ================== Sign out + Switch Org (NLPL directory) ================== */
    signOutBtn?.addEventListener('click', ()=>{
      localStorage.removeItem('nlpl_user_name');
      localStorage.removeItem('nlpl_user_id');
      localStorage.removeItem('nlpl_profile_payload');
      viewDirectory.classList.add('hidden');
      viewOrgChoice.classList.remove('hidden');
      statusEl.textContent='';
      nameInput.value='';
      window.scrollTo({top:0,behavior:'instant'});
      // (Optional) If Chatbase supports reset, you could call it here.
    });
    switchOrgBtn?.addEventListener('click', ()=>{
      viewDirectory.classList.add('hidden');
      viewOrgChoice.classList.remove('hidden');
      statusEl.textContent='';
    });

    /* ================== Load names (kick off) ================== */
    loadNames();
  </script>
  <script>
  // if user opens /nlpl/index.html directly, or reloads, go back to main page
  if (window.location.pathname.toLowerCase().includes('/nlpl/index.html')) {
    window.addEventListener('load', () => {
      // optional short delay for smooth feel
      setTimeout(() => {
        window.location.href = '../index.html';
      }, 100);
    });
  }
</script>

</body>
</html>
