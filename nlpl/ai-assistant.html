<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mini Chat UI</title>
  <style>
    :root {
      --bg:#f9fafb; --ink:#1f2937; --muted:#6b7280; --ring:#e5e7eb; --brand:#2563eb;
      --panel:#ffffff; --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; height: 100vh; display: flex; flex-direction: column;
      background: var(--bg); color: var(--ink);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial;
    }
    .chat-container{
      flex:1; display:flex; flex-direction:column; justify-content:stretch;
      max-width: 700px; width:100%; margin:auto; background:var(--panel);
      border:1px solid var(--ring); border-radius:12px; box-shadow: var(--shadow);
      overflow:hidden;
    }
    /* Top bar with Change Language */
    .topbar{
      display:flex; justify-content:flex-end; padding:10px 12px; border-bottom:1px solid var(--ring);
      background:#fff;
    }
    .btn{
      border:none; background:var(--brand); color:#fff; padding:8px 12px; border-radius:999px;
      font-weight:600; cursor:pointer; transition: filter .2s ease;
    }
    .btn:hover{ filter: brightness(0.95); }

    .chat-messages{
      flex:1; padding:16px; overflow-y:auto; display:flex; flex-direction:column; gap:12px;
      background:#fff;
    }
    .message{
      max-width:80%; padding:10px 14px; border-radius:10px; font-size:15px; line-height:1.4;
      white-space:pre-wrap; word-wrap:break-word;
    }
    .user { align-self:flex-end; background:var(--brand); color:#fff; }
    .bot  { align-self:flex-start; background:#e5e7eb; color:#111827; }

    .input-bar{
      display:flex; padding:12px; border-top:1px solid var(--ring); background:#f3f4f6;
      gap:10px;
    }
    .input-bar input{
      flex:1; padding:10px 14px; border-radius:8px; border:1px solid #d1d5db; font-size:15px; outline:none;
      background:#fff;
    }
    .input-bar button{
      background:var(--brand); color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer;
      transition: filter .2s ease;
    }
    .input-bar button:hover{ filter:brightness(.95); }

    /* Language Modal */
    .modal {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      pointer-events:none; opacity:0; transition: opacity .2s ease;
    }
    .modal.show {
      pointer-events:auto; opacity:1;
    }
    .overlay{
      position:absolute; inset:0; background:rgba(0,0,0,.15); opacity:0; transition: opacity .2s ease;
    }
    .modal.show .overlay{ opacity:1; }
    .panel{
      position:relative; z-index:1; width:92%; max-width:360px; background:#fff; border-radius:14px;
      box-shadow: var(--shadow); border:1px solid var(--ring);
      transform: translateY(6px) scale(.98); opacity:0; transition: transform .2s ease, opacity .2s ease;
    }
    .modal.show .panel{ transform:none; opacity:1; }
    .panel header{
      padding:14px 16px; font-weight:700; border-bottom:1px solid var(--ring);
    }
    .lang-list{ list-style:none; margin:0; padding:6px; }
    .lang-item{
      display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; cursor:pointer;
    }
    .lang-item:hover{ background:#f3f4f6; }
    .lang-item.active{ background:#eef2ff; outline:1px solid #c7d2fe; }
    .lang-note{
      font-size:12px; color:var(--muted); margin: 8px 12px 12px 12px;
    }

    @media (prefers-reduced-motion: reduce){
      .modal, .overlay, .panel { transition: none !important; }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="topbar">
      <button id="changeLangBtn" class="btn" aria-haspopup="dialog" aria-controls="langModal">
        Change Language
      </button>
    </div>

    <div class="chat-messages" id="messages" aria-live="polite">
      <div class="bot message">Hello! This is your mini Chat UI. Try sending something!</div>
    </div>

    <div class="input-bar">
      <input id="userInput" type="text" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <!-- Language Modal -->
  <div id="langModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="langTitle">
    <div class="overlay" id="modalOverlay" tabindex="-1"></div>
    <div class="panel" role="document">
      <header id="langTitle">Choose language</header>
      <ul class="lang-list" id="langList">
        <li class="lang-item" data-lang="EN">English <span style="color:var(--muted);font-size:12px;">(default)</span></li>
        <li class="lang-item" data-lang="KN">Kannada</li>
        <li class="lang-item" data-lang="TE">Telugu</li>
        <li class="lang-item" data-lang="TA">Tamil</li>
        <li class="lang-item" data-lang="ML">Malayalam</li>
      </ul>
      <div class="lang-note">Your selection is saved and will be used for all messages until you change it.</div>
    </div>
  </div>

  <script>
    const messages = document.getElementById('messages');
    const input = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    const changeLangBtn = document.getElementById('changeLangBtn');
    const langModal = document.getElementById('langModal');
    const modalOverlay = document.getElementById('modalOverlay');
    const langList = document.getElementById('langList');

    // Persisted language (defaults to EN)
    const DEFAULT_LANG = 'EN';
    let selectedLang = localStorage.getItem('chatLang') || DEFAULT_LANG;

    const langPhrases = {
      EN: '',                               // English → no phrase
      KN: 'Answer in Kannada.',
      TE: 'Answer in Telugu.',
      TA: 'Answer in Tamil.',
      ML: 'Answer in Malayalam.'
    };

    function addMessage(text, sender) {
      const msg = document.createElement('div');
      msg.classList.add('message', sender);
      msg.textContent = text;
      messages.appendChild(msg);
      messages.scrollTop = messages.scrollHeight;
    }

    function openModal() {
      langModal.classList.add('show');
    }
    function closeModal() {
      langModal.classList.remove('show');
    }

    function highlightActiveLang() {
      [...langList.querySelectorAll('.lang-item')].forEach(li => {
        li.classList.toggle('active', li.dataset.lang === selectedLang);
      });
    }

    function setLanguage(langCode) {
      selectedLang = langCode;
      localStorage.setItem('chatLang', selectedLang); // ✅ persist
      highlightActiveLang();
      closeModal();
    }

    // Initialize active highlight on load
    highlightActiveLang();

    // Modal interactions
    changeLangBtn.addEventListener('click', openModal);
    modalOverlay.addEventListener('click', closeModal);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });
    langList.addEventListener('click', (e) => {
      const li = e.target.closest('.lang-item');
      if (!li) return;
      setLanguage(li.dataset.lang);
    });

    // Sending logic (append phrase for non-EN languages and keep it consistent)
    sendBtn.addEventListener('click', async () => {
      const base = input.value.trim();
      if (!base) return;

      const phrase = langPhrases[selectedLang];
      const finalText = phrase ? `${base} ${phrase}` : base;

      // Show user's final outgoing message (with phrase if applicable)
      addMessage(finalText, 'user');
      input.value = '';

      // Use your webhook (kept intact), sending both the embedded :message and a JSON body
      const webhookUrl = `https://spaced-admissibly-rochel.ngrok-free.dev/webhook/072f509b-09e9-4f44-8a5c-68a55e192493/:message${encodeURIComponent(finalText)}`;

      try {
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: finalText, lang: selectedLang })
        });

        if (response.ok) {
          const raw = await response.text();
          let cleanText = raw;

          // Try to parse JSON if it looks like JSON
          try {
            const json = JSON.parse(raw);
            const payload = Array.isArray(json) && json.length ? json[0] : json;
            if (typeof payload === 'string') {
              cleanText = payload;
            } else if (typeof payload?.output === 'string') {
              cleanText = payload.output;
            } else {
              cleanText = JSON.stringify(payload, null, 2);
            }
          } catch { /* not JSON, keep raw */ }

          cleanText = cleanText.replace(/^\"|\"$/g, '').trim();
          addMessage(cleanText, 'bot');
        } else {
          addMessage('Webhook failed: ' + response.status, 'bot');
        }
      } catch (err) {
        addMessage('Error sending webhook: ' + err.message, 'bot');
      }
    });

    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendBtn.click();
    });

    // Ensure the modal reflects the persisted language on load
    highlightActiveLang();
  </script>
</body>
</html>
