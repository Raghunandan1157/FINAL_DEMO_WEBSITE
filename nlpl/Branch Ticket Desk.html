<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NLPL Helpdesk â€” Branch Ticket Desk (BOE)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --ring:#e2e8f0; --bg:#ffffff;
      --brand:#6366f1; --brand-2:#a78bfa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#fff;color:var(--ink);font:16px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--ring);border-radius:16px;box-shadow:0 10px 28px rgba(2,6,23,.06)}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--ring);background:#f8fafc;font-weight:600}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--bad)}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    select,input,textarea{width:100%;border:1px solid var(--ring);border-radius:12px;background:#f8fafc;padding:12px 14px;font:inherit;color:inherit;outline:none}
    select:focus,input:focus,textarea:focus{box-shadow:0 0 0 4px rgba(99,102,241,.16);background:#fff;border-color:#bfdbfe}
    textarea{min-height:120px;resize:vertical}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid #cbd5e1;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border-color:#6366f1}
    .btn.ghost{background:#f8fafc}
    .badge{font-size:12px;border-radius:999px;padding:3px 8px}
    .badge.pending{background:#fee2e2;color:#991b1b}
    .badge.completed{background:#dcfce7;color:#065f46}
    .badge.active{background:#dbeafe;color:#1e3a8a}

    /* Context strip inputs (Branch view) */
    .ctx-label{font-size:11px;color:#475569}
    .ctx-input{padding:8px 10px;border-radius:10px;border:1px solid var(--ring);background:#f8fafc;font-size:13px}
    .ctx-input:disabled{background:#f1f5f9;color:#334155;opacity:1}

    /* Phone number 10-box input */
    .phone-grid{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .phone-grid input{
      width:2.3rem;
      text-align:center;
      padding:8px 0;
      border-radius:10px;
      border:1px solid var(--ring);
      background:#f8fafc;
      font-size:14px;
    }
    .phone-grid input:focus{
      box-shadow:0 0 0 3px rgba(99,102,241,.16);
      border-color:#bfdbfe;
      background:#fff;
      outline:none;
    }

    /* Ticket list cards inside status boxes */
    .ticket-item{
      border:1px solid #e2e8f0;
      border-radius:0.75rem;
      padding:0.5rem 0.65rem;
      margin-bottom:0.4rem;
      background:#f8fafc;
    }
    .ticket-item-title{
      font-weight:600;
      font-size:0.85rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:180px;
    }
    .ticket-item-meta{
      font-size:0.7rem;
      color:#64748b;
      margin-top:0.1rem;
    }
    .ticket-item-issue{
      font-size:0.75rem;
      margin-top:0.2rem;
      white-space:pre-wrap;
    }
    .ticket-item{
      position:relative;
      overflow:hidden;
      cursor:pointer;
    }
    .ticket-item::after{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:0.9rem;
      pointer-events:none;
      opacity:0;
      border:2px solid transparent;
      background:conic-gradient(from 0deg,var(--hl-color,rgba(59,130,246,.4)) 0deg,transparent 80deg,transparent 360deg);
      filter:drop-shadow(0 0 12px rgba(59,130,246,.35));
      transform-origin:center;
    }
    .ticket-item.highlight-pending::after{
      opacity:1;
      --hl-color:rgba(248,113,113,.55);
      animation:ticketRay 1.2s linear infinite;
    }
    .ticket-item.highlight-active::after{
      opacity:1;
      --hl-color:rgba(59,130,246,.75);
      animation:ticketRay 1.1s linear infinite;
    }
    .ticket-item.highlight-completed::after{
      opacity:1;
      --hl-color:rgba(34,197,94,.6);
      animation:ticketRay 1.3s linear infinite;
    }
    @keyframes ticketRay{
      from{transform:rotate(0deg);}
      to{transform:rotate(360deg);}
    }
    .ticket-toggle{
      width:100%;
      border:none;
      background:none;
      text-align:left;
      padding:0.4rem 0;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:1rem;
      cursor:pointer;
      font:inherit;
      color:inherit;
    }
    .ticket-toggle:focus-visible{
      outline:2px solid #94a3b8;
      border-radius:0.75rem;
    }
    .ticket-chevron{
      width:18px;
      height:18px;
      border-radius:999px;
      border:1px solid #cbd5e1;
      display:grid;
      place-items:center;
      font-size:12px;
      color:#475569;
      transition:transform .2s ease;
      flex-shrink:0;
    }
    .ticket-item[data-expanded="true"] .ticket-chevron{
      transform:rotate(180deg);
    }
    .ticket-details{
      border-top:1px dashed #cbd5e1;
      margin-top:0.4rem;
      padding-top:0.5rem;
      font-size:0.8rem;
      color:#475569;
      display:flex;
      flex-direction:column;
      gap:0.4rem;
    }
    .ticket-item[data-expanded="false"] .ticket-details{
      display:none;
    }
    .ticket-buttons{display:flex;gap:0.5rem;flex-wrap:wrap;}
    .ticket-filter-btn{
      flex:1;
      min-width:130px;
      border-radius:999px;
      border:1px solid #dbeafe;
      background:#eff6ff;
      padding:0.65rem 1rem;
      font-weight:600;
      color:#1d4ed8;
      cursor:pointer;
      transition:all .2s ease;
      text-align:center;
    }
    .ticket-filter-btn.waiting{background:#fff1f2;border-color:#fecdd3;color:#9f1239;}
    .ticket-filter-btn.progress{background:#eff6ff;border-color:#bfdbfe;color:#1d4ed8;}
    .ticket-filter-btn.closed{background:#ecfdf5;border-color:#bbf7d0;color:#047857;}
    .ticket-filter-btn.active{
      box-shadow:0 8px 20px rgba(15,23,42,.15);
      transform:translateY(-1px);
    }
    .ticket-empty{
      border:1px dashed #cbd5e1;
      border-radius:0.9rem;
      background:#f8fafc;
      padding:0.9rem;
      text-align:center;
      font-size:0.85rem;
      color:#475569;
    }
    .flip-wrap{
      position:relative;
      width:100%;
      display:none;
      align-items:center;
      justify-content:center;
      padding:1.5rem;
    }
    .flip-wrap.show{display:flex;}
    .flip-card{
      width:220px;
      height:140px;
      perspective:1000px;
    }
    .flip-card-inner{
      width:100%;
      height:100%;
      position:relative;
      transform-style:preserve-3d;
      animation:flipLoading 1.2s ease-in-out infinite;
      border-radius:16px;
      background:linear-gradient(135deg,#e0e7ff,#fde68a);
      box-shadow:0 20px 35px rgba(15,23,42,.2);
    }
    .flip-card-face{
      position:absolute;
      inset:0;
      backface-visibility:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:#0f172a;
    }
    .flip-card-face.back{
      transform:rotateY(180deg);
    }
    @keyframes flipLoading{
      0%{ transform:rotateY(0deg); }
      50%{ transform:rotateY(180deg); }
      100%{ transform:rotateY(360deg); }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <section class="border-b border-slate-200 bg-white">
    <div class="wrap flex items-center justify-between py-4">
      <div>
        <div class="text-2xl font-semibold">NLPL Helpdesk Suite</div>
        <div class="text-slate-500 text-sm">Branch Ticket Desk (BOE)</div>
      </div>
      <div class="flex items-center gap-2">
        <span class="chip">
          <span class="dot" id="dotBranch"></span>
          <span id="badgeBranch">Checkingâ€¦</span>
        </span>
      </div>
    </div>
  </section>

  <!-- BRANCH DESK -->
  <section id="viewBranch">
    <div class="wrap space-y-4">
      <!-- Upload Context strip -->
      <div class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="font-semibold">Upload Context (auto-sent to table)</div>
          <div class="text-sm text-slate-500">Synced from your profile</div>
        </div>
        <div id="ctx_grid" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <!-- LEFT: Raise Ticket -->
        <div class="card p-5">
          <div class="font-semibold mb-3">Raise a new ticket</div>
          <div class="space-y-3">
            <label class="block">
              <span class="text-sm text-slate-600">Department</span>
              <select id="b_dept">
                <option value="" selected>Select your department</option>
                <option>Audit</option><option>Training</option><option>IT</option>
                <option>Accounts</option><option>Admin</option><option>Operations</option>
                <option>MIS</option><option>HRM</option>
              </select>
            </label>
            <label class="block">
              <span class="text-sm text-slate-600">Short title</span>
              <input id="b_title" placeholder="Short title">
            </label>
            <label class="block">
              <span class="text-sm text-slate-600">Describe the issue</span>
              <textarea id="b_issue" placeholder="Describe the issue"></textarea>
            </label>
            <label class="block">
              <span class="text-sm text-slate-600">Contact (phone)</span>
              <!-- 10-digit phone boxes -->
              <div id="phoneBoxes" class="phone-grid"></div>
              <!-- Hidden field to store joined contact if you ever need to inspect it -->
              <input id="b_contact" type="hidden">
              <div class="text-[11px] text-slate-500 mt-1">Enter 10-digit mobile number (one digit in each box).</div>
            </label>
            <div class="flex items-center gap-2 pt-1">
              <button id="b_submit" class="btn primary">Raise Ticket</button>
              <div id="b_msg" class="text-sm text-slate-500"></div>
            </div>
          </div>
        </div>

        <!-- RIGHT: Tickets -->
        <div class="card p-5 space-y-4">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Your tickets</div>
            <button id="b_refresh" class="btn ghost text-xs px-3 py-2">Refresh</button>
          </div>
          <div class="ticket-buttons" id="ticketButtons">
            <button class="ticket-filter-btn waiting" data-filter="pending">Waiting (Pending)</button>
            <button class="ticket-filter-btn progress" data-filter="active">In Progress (Active)</button>
            <button class="ticket-filter-btn closed" data-filter="completed">Closed (Completed)</button>
          </div>
          <div id="ticketFlipFx" class="flip-wrap">
            <div class="flip-card">
              <div class="flip-card-inner">
                <div class="flip-card-face">Fetching...</div>
                <div class="flip-card-face back">Please wait</div>
              </div>
            </div>
          </div>
          <div id="b_list" class="space-y-3 text-sm text-slate-600" style="display:none;"></div>
        </div>
      </div>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== Helpers =====
      const $ = (s, el=document)=>el.querySelector(s);
      const qsa = (s, el=document)=>Array.from(el.querySelectorAll(s));
      const ticketFlipFx = document.getElementById('ticketFlipFx');
      const ticketList = document.getElementById('b_list');
      const fmt = (iso)=>{try{return new Date(iso).toLocaleString();}catch(_){return iso||'â€”';}};
      const escapeHtml = (s)=> String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
      const setBadge = (dotEl, textEl, state)=>{
        dotEl?.classList.remove('ok','warn');
        if (state==='ok') dotEl?.classList.add('ok');
        else if (state==='warn') dotEl?.classList.add('warn');
        if (textEl) textEl.textContent = state==='ok' ? 'Connected' : state==='warn' ? 'Connected (RLS/limited)' : 'Not connected';
      };
      const ticketsUiState = {
        filter: '',
        buckets: { pending: [], active: [], completed: [] },
        snapshot: {}
      };
      const FILTER_MAP = {
        pending: { label:'Waiting (Pending)', empty:'No waiting tickets right now.' },
        active: { label:'In Progress (Active)', empty:'No active tickets right now.' },
        completed: { label:'Closed (Completed)', empty:'No closed tickets right now.' }
      };
      const ticketHighlightMap = new Map();
      const HIGHLIGHT_DURATION = 6000;
      function queueTicketHighlight(id, statusKey){
        if (!id) return;
        const token = Date.now();
        const existing = ticketHighlightMap.get(id);
        if (existing?.timer) clearTimeout(existing.timer);
        const timer = setTimeout(()=>{
          const current = ticketHighlightMap.get(id);
          if (current && current.token === token){
            ticketHighlightMap.delete(id);
            applyTicketHighlights();
          }
        }, HIGHLIGHT_DURATION);
        ticketHighlightMap.set(id, { statusKey, timer, token });
        applyTicketHighlights();
      }
      function updateFilterButtons(){
        const buttons = qsa('.ticket-filter-btn');
        buttons.forEach(btn=>{
          const filter = btn.getAttribute('data-filter');
          btn.classList.toggle('active', filter === ticketsUiState.filter);
        });
      }
      let flipTimer = null;
      function runFlipAnimation(onDone, skip){
        if (!ticketFlipFx){
          onDone();
          return;
        }
        if (skip){
          ticketFlipFx.classList.remove('show');
          onDone();
          return;
        }
        ticketFlipFx.classList.add('show');
        if (ticketList) ticketList.style.display = 'none';
        if (flipTimer) clearTimeout(flipTimer);
        flipTimer = setTimeout(()=>{
          ticketFlipFx.classList.remove('show');
          flipTimer = null;
          onDone();
        }, 6000);
      }
      function triggerFilterDisplay(filterKey, skipAnimation=false){
        if (!FILTER_MAP[filterKey]) return;
        ticketsUiState.filter = filterKey;
        updateFilterButtons();
        runFlipAnimation(()=>{
          renderTicketBlocks();
        }, skipAnimation);
      }
      function applyTicketHighlights(){
        qsa('.ticket-item').forEach(item=>{
          const id = item.getAttribute('data-ticket-id');
          item.classList.remove('highlight-pending','highlight-active','highlight-completed');
          const entry = ticketHighlightMap.get(id);
          if (entry){
            item.classList.add('highlight-'+entry.statusKey);
          }
        });
      }
      function handleTicketSnapshot(rows){
        const prev = ticketsUiState.snapshot || {};
        const isInitial = !prev || !Object.keys(prev).length;
        const next = {};
        (rows || []).forEach(row=>{
          const statusKey = ticketStatusKey(row);
          const id = String(row.id);
          next[id] = { statusKey, updated_at: row.updated_at };
          const prevItem = prev[id];
          const changed = !prevItem || prevItem.statusKey !== statusKey || prevItem.updated_at !== row.updated_at;
          const allowInitialHighlight = !isInitial || statusKey === 'active';
          if (changed && allowInitialHighlight){
            queueTicketHighlight(id, statusKey);
          }
        });
        ticketsUiState.snapshot = next;
      }
      function setupTicketAccordions(container){
        if (!container) return;
        qsa('.ticket-item', container).forEach(item=>{
          const btn = item.querySelector('.ticket-toggle');
          if (!btn) return;
          btn.addEventListener('click', ()=>{
            const expanded = item.getAttribute('data-expanded') === 'true';
            item.setAttribute('data-expanded', expanded ? 'false' : 'true');
            btn.setAttribute('aria-expanded', expanded ? 'false' : 'true');
          });
        });
      }
      function renderTicketBlocks(){
        if (!ticketList) return;
        ticketList.innerHTML = '';
        const filter = ticketsUiState.filter;
        if (!filter){
          ticketList.style.display = 'none';
          return;
        }
        const cfg = FILTER_MAP[filter];
        const rows = (ticketsUiState.buckets[filter] || []);
        if (!rows.length){
          ticketList.innerHTML = `<div class="ticket-empty">${cfg ? cfg.empty : 'No tickets.'}</div>`;
        } else {
          ticketList.innerHTML = rows.map(renderTicketItem).join('');
        }
        ticketList.style.display = 'block';
        setupTicketAccordions(ticketList);
        applyTicketHighlights();
      }

      // ===== Supabase & Webhook =====
      const { createClient } = window.supabase;
      const SUPABASE_URL  = "https://zovnmmdfthpbubrorsgh.supabase.co";
      const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvdm5tbWRmdGhwYnVicm9yc2doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NzE3ODgsImV4cCI6MjA3NzE0Nzc4OH0.92BH2sjUOgkw6iSRj1_4gt0p3eThg3QT4VK-Q4EdmBE";
      const PROFILE_TABLE = "PROFILE_DEMO";
      const PROFILE_COLS = {
        designation: "Designation",
        state: "State",
        district: "District",
        region: "Region",
        branchCode: "Branch Code",
        employeeId: "Employee ID"
      };
      const WEBHOOK_URL = "https://spaced-admissibly-rochel.ngrok-free.dev/webhook/52fbd75c-03ba-40ef-a70b-f79d1934df8b";

      const supa = createClient(SUPABASE_URL, SUPABASE_ANON);

      // ===== Runtime schema detection (optional UI toggles) =====
      const SCHEMA = { priority:false, prioritized_at:false, is_active:false, activated_at:false, closed_at:false };
      async function detectSchema(){
        for (const col of Object.keys(SCHEMA)){
          try{
            const { error } = await supa.from('tickets').select(col).limit(1);
            SCHEMA[col] = !error;
          }catch(_){ SCHEMA[col] = false; }
        }
      }

      // ===== Profile context (12 fields; missing â†’ DEMO) =====
      const COLUMN_MAP = {
        sl_no:'sl_no', year:'year', month:'month', name:'name',
        employee_id:'employee_id', designation:'designation', level:'level', state:'state',
        branch_code:'branch_code', branch_name:'branch_name', district:'district', region:'region'
      };
      const ORDERED_KEYS = Object.keys(COLUMN_MAP);
      const FIELD_ALIASES = {
        sl_no: ['Sl.no.','slno','sl_no','sno','s.no','serial'],
        year: ['Year','yr'],
        month: ['Month','mnth'],
        name: ['Name','employee name','emp name'],
        employee_id: ['Employee ID','emp id','employeeid','empid','eid'],
        designation: ['Designation','role','title'],
        level: ['Level','grade','band'],
        state: ['State'],
        branch_code: ['Branch Code','branch_code','branchcode','bcode','branch id'],
        branch_name: ['Branch Name','branch_name','branch'],
        district: ['District'],
        region: ['Region']
      };
      const FIELD_LABELS = {
        sl_no:'Sl.no.', year:'Year', month:'Month', name:'Name',
        employee_id:'Employee ID', designation:'Designation', level:'Level', state:'State',
        branch_code:'Branch Code', branch_name:'Branch Name', district:'District', region:'Region'
      };
      const canon = (k)=>String(k).toLowerCase().replace(/[^a-z0-9]/g,'');

      function normalizeProfile(src){
        const out={}, canonMap={};
        for (const key in (src||{})) canonMap[canon(key)] = src[key];
        for (const [std, aliases] of Object.entries(FIELD_ALIASES)){
          let val;
          for (const a of [std, ...aliases]){
            const ck = canon(a);
            if (ck in canonMap){ val = canonMap[ck]; break; }
          }
          if (val !== undefined) out[std] = val;
        }
        return out;
      }

      const ctxGrid = $('#ctx_grid');
      let profileStore = {};
      let branchCodeCtx = '';

      function deriveLevelFromDesignation(designation){
        const raw = String(designation || '').trim().toUpperCase();
        if (!raw) return '';
        if (raw.startsWith('B') || raw.includes('FO')) return 'Branch';
        if (raw.startsWith('D')) return 'District';
        if (raw.startsWith('R')) return 'Region';
        if (raw === 'CO') return 'Head Office';
        return 'Head Office';
      }

      // ALWAYS compute year/month from current date when needed
      function updateTemporalNow(){
        const now = new Date();
        profileStore.year = String(now.getFullYear());
        profileStore.month = now.toLocaleString('en-US', { month: 'long' });
      }

      function applyDerivedFields(){
        const derivedLevel = deriveLevelFromDesignation(profileStore.designation);
        if (derivedLevel) profileStore.level = derivedLevel;
      }

      function mergeProfileSource(src){
        if (!src) return;
        const normalized = normalizeProfile(src);
        for (const [key, value] of Object.entries(normalized)){
          // Never import 'year' or 'month' from Supabase â€” keep them live
          if (key === 'year' || key === 'month') continue;
          if (value === undefined || value === null) continue;
          profileStore[key] = String(value).trim();
        }
        applyDerivedFields();
      }

      function readSessionPayload(){
        try{
          return JSON.parse(localStorage.getItem('nlpl_profile_payload') || 'null');
        }catch(_){
          return null;
        }
      }

      function hydrateProfileFromSession(){
        const payload = readSessionPayload();
        if (!payload) return;
        const base = Object.assign({}, payload.profile || {});
        base.name = payload.name ?? base.name;
        base.employee_id = payload.empId ?? base.employee_id;
        base.designation = payload.role ?? base.designation;
        if (payload.branch){
          base.branch_code = payload.branch.code ?? base.branch_code;
          base.branch_name = payload.branch.name ?? base.branch_name;
          base.district = payload.branch.district ?? base.district;
          base.region = payload.branch.region ?? base.region;
          base.state = payload.branch.state ?? base.state;
        }
        mergeProfileSource(base);
      }

      function ensureTemporalDefaults(){
        if (!profileStore.year || !profileStore.month){
          updateTemporalNow();
        }
      }

      function resolveBranchCode(){
        const urlBranch = (new URLSearchParams(window.location.search).get('branch') || '').trim();
        if (urlBranch) return urlBranch.toUpperCase();
        const fromStore = profileStore.branch_code || '';
        return fromStore.trim().toUpperCase();
      }

      function setBranchCode(code){
        const normalized = (code || '').trim().toUpperCase();
        if (!normalized) return '';
        branchCodeCtx = normalized;
        profileStore.branch_code = normalized;
        return normalized;
      }

      function getEffectiveProfile(){ return Object.assign({}, profileStore); }
      function getProfileDataDemoFill(){
        const base = getEffectiveProfile(); const out = {};
        for (const k of ORDERED_KEYS){
          const v = base[k];
          out[k] = (v===undefined || v===null || String(v).trim()==='') ? 'DEMO' : String(v);
        }
        return out;
      }

      function renderCtxBoxes(){
        if (!ctxGrid) return;
        const src = getProfileDataDemoFill();
        ctxGrid.innerHTML = ORDERED_KEYS.map(k=>{
          const label = FIELD_LABELS[k] || k; const val = src[k] ?? '';
          return `<label class="block"><div class="ctx-label mb-1">${escapeHtml(label)}</div>
                  <input class="ctx-input" value="${escapeHtml(val)}" disabled></label>`;
        }).join('');
      }

      // === Enrichment from PROFILE_DEMO ===
      async function enrichFromProfileDemo(){
        const empId = (profileStore.employee_id || '').trim();
        const bcode = (branchCodeCtx || '').trim();
        try{
          let row = null;
          if (empId){
            const byEmp = await supa.from(PROFILE_TABLE)
              .select('*')
              .eq(PROFILE_COLS.employeeId, empId)
              .maybeSingle();
            if (byEmp.error && byEmp.error.code !== 'PGRST116') throw byEmp.error;
            row = byEmp.data || null;
          }
          if (!row && bcode){
            const byBcode = await supa.from(PROFILE_TABLE)
              .select('*')
              .ilike(PROFILE_COLS.branchCode, bcode)
              .maybeSingle();
            if (byBcode.error && byBcode.error.code !== 'PGRST116') throw byBcode.error;
            row = byBcode.data || null;
          }
          if (row){
            mergeProfileSource({
              designation: row[PROFILE_COLS.designation],
              state: row[PROFILE_COLS.state],
              district: row[PROFILE_COLS.district],
              region: row[PROFILE_COLS.region],
              branch_code: row[PROFILE_COLS.branchCode]
            });
            ensureTemporalDefaults();
            renderCtxBoxes();
          }
        }catch(err){
          console.warn('PROFILE_DEMO enrichment failed', err);
        }
      }

      async function fetchBranchRecord(){
        if (!branchCodeCtx) return;
        try{
          const { data, error } = await supa
            .from('branches')
            .select('*')
            .ilike('branch_code', branchCodeCtx)
            .maybeSingle();
          if (error && error.code !== 'PGRST116') throw error;
          if (data){
            mergeProfileSource(data);
            ensureTemporalDefaults();
            renderCtxBoxes();
          }
        }catch(err){
          console.warn('Unable to fetch branch profile', err);
        }
      }

      async function refreshSerialCounter(){
        if (!branchCodeCtx) return;
        try{
          const { count, error } = await supa
            .from('tickets')
            .select('id', { head:true, count:'exact' })
            .ilike('branch_code', branchCodeCtx);
          if (error) throw error;
          const serial = (count ?? 0) + 1;
          profileStore.sl_no = String(serial);
          renderCtxBoxes();
        }catch(err){
          console.warn('Unable to fetch ticket count', err);
        }
      }

      async function hydrateBranchContext(){
        await Promise.all([fetchBranchRecord(), enrichFromProfileDemo(), refreshSerialCounter()]);
      }

      // ===== Connection badge =====
      async function ping(){
        try{
          const { error } = await supa.from('tickets').select('id',{ head:true, count:'exact' }).limit(1);
          return error ? 'warn' : 'ok';
        }catch(e){ return 'bad'; }
      }
      async function refreshBadges(){
        const state = await ping();
        setBadge($('#dotBranch'), $('#badgeBranch'), state);
      }

      // ===== Phone 10-box setup =====
      function setupPhoneBoxes(){
        const container = $('#phoneBoxes');
        if (!container) return;
        container.innerHTML = '';
        const boxes = [];
        for (let i=0;i<10;i++){
          const inp = document.createElement('input');
          inp.type = 'text';
          inp.inputMode = 'numeric';
          inp.maxLength = 1;
          inp.className = 'phone-digit';
          inp.autocomplete = 'off';

          inp.addEventListener('input', (e)=>{
            const v = e.target.value.replace(/\D/g,'');
            e.target.value = v.slice(0,1);
            if (v && boxes[i+1]) boxes[i+1].focus();
          });

          inp.addEventListener('keydown', (e)=>{
            if (e.key === 'Backspace' && !inp.value && boxes[i-1]){
              boxes[i-1].focus();
            }
            if (e.key === 'ArrowLeft' && boxes[i-1]) boxes[i-1].focus();
            if (e.key === 'ArrowRight' && boxes[i+1]) boxes[i+1].focus();
          });

          boxes.push(inp);
          container.appendChild(inp);
        }
      }

      function getPhoneFromBoxes(){
        const digits = Array.from(document.querySelectorAll('.phone-digit'))
          .map(i=>i.value.trim())
          .join('');
        $('#b_contact').value = digits;
        return digits;
      }

      // ===== Branch: create + list =====
      async function branchCreate(){
        const dept    = $('#b_dept')?.value?.trim() || '';
        const title   = $('#b_title')?.value?.trim() || '';
        const issue   = $('#b_issue')?.value?.trim() || '';
        const contactRaw = getPhoneFromBoxes();
        const msg     = $('#b_msg');

        if (!dept || !title || !issue || !contactRaw){
          msg.textContent = 'Please fill all fields.';
          return;
        }
        if (!/^\d{10}$/.test(contactRaw)){
          msg.textContent = 'Contact must be a 10-digit number.';
          return;
        }

        const setSubmitting = (isSubmitting) => {
          const btn = $('#b_submit');
          if (!btn) return;
          btn.disabled = isSubmitting;
          btn.style.opacity = isSubmitting ? '0.6' : '';
          btn.style.cursor = isSubmitting ? 'wait' : '';
        };

        setSubmitting(true);
        msg.textContent = 'Savingâ€¦';

        try {
          // Always stamp year/month with live values at the moment of ticket creation
          updateTemporalNow();

          const ctx = getProfileDataDemoFill();
          if (!ctx.branch_code || ctx.branch_code === 'DEMO'){
            msg.textContent = 'Branch context missing. Please login via BOE first.';
            return;
          }

          const ctxForDb = {};
          for (const k of ORDERED_KEYS){ ctxForDb[COLUMN_MAP[k]] = ctx[k]; }

          const now = new Date().toISOString();
          const payload = {
            department: dept,
            title,
            issue,
            contact: contactRaw,
            status: 'Pending',
            created_at: now,
            updated_at: now,
            ...ctxForDb
          };

          const { data, error } = await supa
            .from('tickets')
            .insert([payload])
            .select('*')
            .single();

          if (error){
            msg.textContent = 'Insert failed: ' + error.message;
            return;
          }

          // ðŸ”” WEBHOOK CALL (after ticket is successfully created)
          if (WEBHOOK_URL) {
            try {
              const resp = await fetch(WEBHOOK_URL, {
                method: "POST",
                mode: "cors",
                headers: {
                  "Content-Type": "application/json",
                  "ngrok-skip-browser-warning": "true"
                },
                body: JSON.stringify({
                  event: "ticket_created",
                  source: "branch_boe",
                  ticket_id: data.id,
                  branch_code: data.branch_code,
                  department: data.department,
                  title: data.title,
                  status: data.status,
                  created_at: data.created_at,
                  payload: data
                })
              });

              if (!resp.ok) {
                console.warn("Webhook HTTP Error:", resp.status, await resp.text());
              } else {
                console.log("Webhook delivered successfully");
              }

            } catch (err) {
              console.warn("Webhook failed (network error):", err);
            }
          }

          // ðŸŽ‰ Animation + UI updates
          const ticketIdFull = String(data.id);
          const toastRef = '#' + ticketIdFull.slice(0,4);
          showRaiseFx(ticketIdFull);
          setTimeout(() => celebrateClose(toastRef), 2000);

          // Clear fields
          ['#b_title', '#b_issue'].forEach(sel => {
            const el = $(sel);
            if (el) el.value = '';
          });
          // Clear phone boxes
          document.querySelectorAll('.phone-digit').forEach(i=>i.value='');

          msg.textContent = 'Ticket raised successfully.';
          await branchList();
          await refreshSerialCounter();
        } finally {
          setSubmitting(false);
        }
      }

      function ticketStatusKey(row){
        if (row.status === 'Completed') return 'completed';
        if (SCHEMA.is_active && row.status === 'Pending' && row.is_active) return 'active';
        return 'pending';
      }

      function renderTicketItem(r){
        const statusKey = ticketStatusKey(r);
        const shortId = String(r.id).slice(0,8);
        const issueSafe = escapeHtml(r.issue||'').replace(/\n/g,'<br>');
        return `
          <div class="ticket-item" data-ticket-id="${escapeHtml(String(r.id))}" data-status="${statusKey}" data-expanded="false">
            <button class="ticket-toggle" type="button" aria-expanded="false">
              <div class="min-w-0">
                <div class="ticket-item-title">${escapeHtml(r.title||'â€”')}</div>
                <div class="ticket-item-meta">${shortId} â€¢ ${fmt(r.created_at)}</div>
              </div>
              <div class="text-right flex flex-col items-end gap-1 ml-2">
                <span class="badge ${statusKey==='completed'?'completed':statusKey==='active'?'active':'pending'}">${escapeHtml(r.status||'â€”')}</span>
                <div class="ticket-item-meta">${escapeHtml(r.department||'â€”')}</div>
                <span class="ticket-chevron">âŒ„</span>
              </div>
            </button>
            <div class="ticket-details">
              <div class="ticket-item-issue" style="white-space:normal;">${issueSafe || '<span class="text-slate-400">No description provided.</span>'}</div>
              <div class="ticket-item-meta">Dept: ${escapeHtml(r.department||'â€”')}</div>
              <div class="ticket-item-meta">Phone: ${escapeHtml(r.contact||'â€”')}</div>
              ${SCHEMA.is_active && r.status==='Pending' && r.is_active ? '<div class="ticket-item-meta font-semibold text-blue-700">Activation in progress</div>' : ''}
            </div>
          </div>
        `;
      }

      async function branchList(){
        const list = $('#b_list'); 
        list.textContent='Loadingâ€¦';
        let query = supa.from('tickets').select('*').order('created_at',{ascending:false}).limit(50);
        if (branchCodeCtx) query = query.ilike('branch_code', branchCodeCtx);
        const { data, error } = await query;
        if (error){ 
          if (ticketList){
            ticketList.style.display = 'block';
            ticketList.innerHTML = `<div class="ticket-empty" style="color:#b91c1c;border-color:#fecdd3;background:#fef2f2;">Load failed: ${escapeHtml(error.message)}</div>`;
          }
          return; 
        }

        const buckets = { pending:[], active:[], completed:[] };

        for (const r of data || []){
          if (r.status === 'Completed'){
            buckets.completed.push(r);
          } else if (SCHEMA.is_active && r.status === 'Pending' && r.is_active){
            buckets.active.push(r);
          } else if (r.status === 'Pending'){
            buckets.pending.push(r);
          } else {
            buckets.pending.push(r);
          }
        }

        ticketsUiState.buckets = buckets;
        handleTicketSnapshot(data);
        if (ticketsUiState.filter){
          renderTicketBlocks();
        }
      }

      // Realtime: keep in sync
      try{
        supa.channel('tickets_rt_branch')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'tickets' }, async () => {
            await branchList();
            await refreshSerialCounter();
          })
          .subscribe();
      }catch(_){}

      // ===== Wire up buttons =====
      $('#b_submit')?.addEventListener('click', branchCreate);
      $('#b_refresh')?.addEventListener('click', branchList);
      $('#ticketButtons')?.addEventListener('click', (e)=>{
        const button = e.target.closest('.ticket-filter-btn');
        if (!button) return;
        const filter = button.getAttribute('data-filter');
        triggerFilterDisplay(filter);
      });
      updateFilterButtons();

      // Boot
      (async function boot(){
        setupPhoneBoxes();
        hydrateProfileFromSession();
        ensureTemporalDefaults();
        const inferredBranch = resolveBranchCode();
        if (inferredBranch) setBranchCode(inferredBranch);
        renderCtxBoxes();
        await refreshBadges();
        await detectSchema();
        await hydrateBranchContext();
        await branchList();
      })();
    });
  </script>

  <!-- === RAISE TICKET ANIMATION FX === -->
  <style>
  .raiseFX {
    position: fixed;
    inset: 0;
    z-index: 400;
    display: none;
    place-items: center;
    background: radial-gradient(1200px 1200px at 50% 50%, #5b21b6 0%, #1e1b4b 55%, #020617 100%);
    color: #fff;
    perspective: 1000px;
  }
  .fxCard {
    padding: 34px 44px;
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    background: rgba(15, 23, 42, 0.35);
    box-shadow: 0 20px 40px rgba(2,6,23,.8), inset 0 0 0 1px rgba(255,255,255,.08);
    transform-style: preserve-3d;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .fxTitle {
    font-size: 0.85rem;
    opacity: 0.9;
    letter-spacing: 0.22em;
    text-transform: uppercase;
  }
  .fxLongId {
    font-size: clamp(1.3rem, 4vw, 2.6rem);
    font-weight: 800;
    letter-spacing: 0.18em;
    margin-top: 1rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.15em;
    padding: 0.5rem 0.75rem;
    text-shadow: 0 0 8px rgba(59, 130, 246, .35);
    transform-origin: center;
    flex-wrap: wrap;
  }
  .fxLetter{
    display: inline-block;
    min-width: 0.55ch;
    opacity: 0;
    transform: translateY(-80px) rotateX(90deg);
    transform-origin: center;
  }
  .fxHint{
    margin-top: 1rem;
    font-size: 0.9rem;
    letter-spacing: 0.08em;
    color: rgba(226, 232, 240, .8);
  }
  .fxCard.stage-spin .fxLetter{
    animation: fxLetterDrop var(--char-duration, 0.8s) cubic-bezier(.19,.7,.32,1.2) forwards;
    animation-delay: var(--char-delay, 0s);
  }
  .fxCard.stage-hit .fxLongId{
    animation: fxImpact 1s ease-out forwards;
    text-shadow: 0 0 8px rgba(251, 191, 36, .7), 0 0 28px rgba(251, 113, 133, .5);
  }
  .fxCard.stage-hit::after{
    content:"";
    position:absolute;
    inset:-30%;
    background: radial-gradient(circle at 50% 10%, rgba(251,191,36,.5), transparent 45%),
                radial-gradient(circle at 80% 30%, rgba(248,113,113,.35), transparent 55%);
    filter: blur(10px);
    opacity: 0;
    animation: fxFlame 1s ease-out forwards;
    pointer-events:none;
  }
  .fxCard.stage-read .fxLongId{
    animation: none;
    text-shadow: 0 0 10px rgba(255,255,255,.55);
  }
  @keyframes fxLetterDrop {
    0% { opacity: 0; transform: translateY(-90px) rotateX(95deg); }
    55% { opacity: 1; transform: translateY(6px) rotateX(-8deg); }
    70% { opacity: 1; transform: translateY(-2px) rotateX(4deg); }
    100% { opacity: 1; transform: translateY(0) rotateX(0deg); }
  }
  @keyframes fxImpact {
    0% { transform: scale(0.95) rotateX(20deg); }
    50% { transform: scale(1.15) rotateX(0deg); }
    100% { transform: scale(1) rotateX(0deg); }
  }
  @keyframes fxFlame {
    0% { opacity: 0.8; transform: scale(0.8); }
    100% { opacity: 0; transform: scale(1.1); }
  }
  .confetti-wrap {
    position: fixed;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
    z-index: 450;
  }
  .confetti {
    position: absolute;
    top: -12px;
    width: 8px;
    height: 12px;
    border-radius: 2px;
    transform: rotate(var(--ry));
    animation: confettiFall 1.4s ease-in forwards;
    opacity: .95;
    box-shadow: 0 0 8px rgba(52, 211, 153, .45);
  }
  @keyframes confettiFall {
    to { transform: translateY(110vh) rotate(720deg); }
  }
  .close-toast {
    position: fixed;
    bottom: 16px;
    right: 16px;
    z-index: 460;
    padding: .65rem .8rem;
    border: 1px solid rgba(16,185,129,.35);
    background: rgba(16,185,129,.10);
    border-radius: .75rem;
    box-shadow: 0 12px 30px rgba(2,6,23,.6);
    color: #fff;
    font-size: 14px;
  }
  </style>

  <div id="raiseFX" class="raiseFX" role="status" aria-live="polite">
    <div class="fxCard" id="fxCard">
      <div id="fxTitleText" class="fxTitle">TICKET ID - â€”</div>
      <div id="fxCode" class="fxLongId">â€”</div>
      <div id="fxHint" class="fxHint">Preparing animationâ€¦</div>
    </div>
  </div>

  <script>
    // === One-time Raise Ticket Animation ===
    const raiseFX = document.getElementById('raiseFX');
    const fxCode = document.getElementById('fxCode');
    const fxTitleText = document.getElementById('fxTitleText');
    const fxHint = document.getElementById('fxHint');
    const fxCard = document.getElementById('fxCard');
    let raiseTimers = [];

    function resetFxStages(){
      fxCard?.classList.remove('stage-spin','stage-hit','stage-read');
      raiseTimers.forEach(t=>clearTimeout(t));
      raiseTimers = [];
    }

    function renderFxCodeLetters(code){
      if(!fxCode) return;
      const text = String(code || '');
      const letters = text.split('');
      if(!letters.length){
        fxCode.textContent = text;
        return;
      }
      const baseDuration = 0.85;
      const totalWindow = 4;
      const spacing = letters.length > 1
        ? Math.max((totalWindow - baseDuration) / (letters.length - 1), 0.15)
        : 0;
      fxCode.innerHTML = '';
      letters.forEach((char, idx)=>{
        const span = document.createElement('span');
        span.className = 'fxLetter';
        span.textContent = char;
        span.style.setProperty('--char-duration', baseDuration + 's');
        span.style.setProperty('--char-delay', (idx * spacing).toFixed(2) + 's');
        fxCode.appendChild(span);
      });
    }

    function showRaiseFx(code){
      if (!raiseFX || !fxCard) return;
      resetFxStages();
      renderFxCodeLetters(code);
      if (fxTitleText) fxTitleText.textContent = `TICKET ID - ${code}`;
      if (fxHint) fxHint.textContent = 'Rolling out your ticket IDâ€¦';
      raiseFX.style.display = 'grid';
      requestAnimationFrame(()=> fxCard.classList.add('stage-spin'));
      raiseTimers.push(setTimeout(()=>{
        fxCard.classList.remove('stage-spin');
        fxCard.classList.add('stage-hit');
        if (fxHint) fxHint.textContent = 'Impact! Ticket ID is locked.';
      }, 4000));
      raiseTimers.push(setTimeout(()=>{
        fxCard.classList.add('stage-read');
        if (fxHint) fxHint.textContent = 'Take 2 seconds to note it down.';
      }, 5000));
      raiseTimers.push(setTimeout(()=>{
        raiseFX.style.display = 'none';
        resetFxStages();
      }, 7000));
    }

    function celebrateClose(ref){
      const wrap=document.createElement('div');
      wrap.className='confetti-wrap';
      for(let i=0;i<24;i++){
        const p=document.createElement('div');
        p.className='confetti';
        p.style.left=(Math.random()*100).toFixed(1)+'%';
        p.style.background=Math.random()>.5?
          'linear-gradient(180deg,#34d399,#22d3ee)':
          'linear-gradient(180deg,#a78bfa,#60a5fa)';
        p.style.setProperty('--ry',(Math.random()*360).toFixed(1)+'deg');
        p.style.animationDelay=(Math.random()*0.2).toFixed(2)+'s';
        wrap.appendChild(p);
      }
      document.body.appendChild(wrap);
      const toast=document.createElement('div');
      toast.className='close-toast';
      toast.textContent='Ticket '+ref+' saved';
      document.body.appendChild(toast);
      setTimeout(()=>{wrap.remove();toast.remove();},1700);
    }
  </script>

</body>
</html>
