<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NLPL Branch Locator — Open in Google Maps</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --muted:#6b7280; --text:#0a0a0a;
      --accent:#0a84ff; --accent-2:#00d4ff; --line:#e5e7eb; --hover:#f9fafb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
    }

    /* Stage (for demo scroll + impact shake) */
    #stage{will-change:transform; transition:transform .6s cubic-bezier(.22,.61,.36,1)}
    .demo-scroll-up #stage{ transition-duration:2s; transform:translateY(-25vh) }
    .demo-scroll-reset #stage{ transition-duration:.22s; transform:translateY(0) }
    @keyframes shakeOnce{
      0%{transform:translate(0,0)}
      15%{transform:translate(-4px,2px)}
      30%{transform:translate(4px,-2px)}
      45%{transform:translate(-3px,1px)}
      60%{transform:translate(3px,-1px)}
      75%{transform:translate(-2px,1px)}
      100%{transform:translate(0,0)}
    }
    .shake-now #stage{ animation:shakeOnce 1s cubic-bezier(.36,.07,.19,.97) both }

    /* Header */
    header{
      padding:18px 20px 10px;
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(150%) blur(6px);
      background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.65) 40%,rgba(255,255,255,0));
      border-bottom:1px solid var(--line);
    }
    h1{margin:0 0 6px; font-size:18px; font-weight:800; letter-spacing:.3px}
    .sub{color:var(--muted); font-size:12px}
    .wrap{max-width:1200px; margin:0 auto}

    /* Controls */
    .controls{display:grid; grid-template-columns:1fr auto auto auto auto; gap:10px; margin:12px 0 2px}
    input[type="search"]{
      width:100%; padding:12px 12px; border-radius:12px; background:var(--card);
      border:1px solid var(--line); color:var(--text)
    }
    input[type="search"]::placeholder{color:#9ca3af}
    button,.btn{
      padding:10px 12px; border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#04111f; border:none; font-weight:700; cursor:pointer; text-decoration:none
    }
    button.ghost{background:#f3f4f6; color:var(--text); border:1px solid var(--line)}
    button:disabled{opacity:.6; cursor:not-allowed}
    button:active{transform:translateY(1px)}
    button:focus-visible,.btn:focus-visible,input:focus-visible{outline:2px solid var(--accent); outline-offset:2px}

    /* Cards / Table */
    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:10px; margin:12px 20px; overflow:hidden}
    .meta{color:var(--muted); font-size:12px; padding:0 2px 8px 2px}
    table{width:100%; border-collapse:collapse}
    thead th{
      text-align:left; font-size:12px; color:var(--muted);
      font-weight:700; letter-spacing:.3px; border-bottom:1px solid var(--line); padding:10px
    }
    tbody td{padding:12px 10px; border-bottom:1px dashed var(--line); vertical-align:middle}
    tbody tr:hover{background:var(--hover)}
    .num{width:52px; color:var(--muted)}
    .name{min-width:280px; font-weight:600}
    .coords{font-variant-numeric:tabular-nums; color:#111827}
    .actions{white-space:nowrap}
    .badge{display:inline-block; font-size:11px; padding:3px 8px; border-radius:999px; background:#f3f4f6; color:#374151; border:1px solid var(--line)}

    /* Map */
    #mapCard{margin:12px 20px}
    #map{height:60vh; width:100%; border-radius:14px; border:1px solid var(--line)}
    .leaflet-control-attribution{
      background:rgba(255,255,255,.85); color:#374151; border-radius:6px; border:1px solid var(--line)
    }

    /* Search spotlight */
    .spotlight{
      animation:spot 1.2s ease-in-out 2;
      box-shadow:0 0 0 3px var(--accent), 0 0 0 10px rgba(10,132,255,.15);
    }
    @keyframes spot{0%,100%{transform:scale(1)} 50%{transform:scale(1.01)}}

    /* Full-screen letter overlay */
    #letterOverlay{ position:fixed; inset:0; pointer-events:none; z-index:40; display:none; }
    #letterOverlay.show{display:block}
    .fletter{
      position:fixed; left:50%; top:50%;
      transform:translate(-50%,-50%) scale(1);
      font-weight:900; line-height:1; letter-spacing:.02em;
      font-family:inherit; color:#0a0a0a; opacity:.98;
      font-size:80vmin;
      filter:drop-shadow(0 30px 60px rgba(0,0,0,.15));
      /* left/top update frequently to follow caret; keep them responsive */
      transition:
        left .2s cubic-bezier(.2,.8,.2,1),
        top  .2s cubic-bezier(.2,.8,.2,1),
        transform 2s cubic-bezier(.2,.8,.2,1),
        opacity 2s ease;
    }

    @media (max-width:900px){#map{height:50vh}}
    @media (max-width:720px){
      .controls{grid-template-columns:1fr auto auto auto auto; gap:8px}
      .actions .btn{display:inline-block; margin-top:8px}
      .name{min-width:auto}
      tbody td{padding:10px 8px}
    }
  </style>
</head>
<body>
  <div id="stage">
    <header>
      <div class="wrap">
        <h1>NLPL Branch Locator</h1>
        <div class="sub">
          Click a branch or its coordinates to open the pin in <span class="badge">Google Maps</span>.
          Coordinates shown as <strong>(Lat, Long)</strong>. Use the search to filter; markers update live.
        </div>
        <div class="controls">
          <input id="search" type="search" placeholder="Search branch… (e.g., KOLAR, HUBLI, SEDAM)" />
          <button class="ghost" id="clearBtn" title="Clear search">Clear</button>
          <button id="copyBtn" title="Copy visible rows as CSV">Export CSV</button>
          <button id="fitBtn" title="Zoom map to all visible markers">Fit All</button>
          <button id="demoBtn" class="ghost" title="Run interactive demo">Demo</button>
        </div>
      </div>
    </header>

    <main class="wrap">
      <!-- Map -->
      <div id="mapCard" class="card">
        <div class="meta">Interactive map (OpenStreetMap tiles). Click any marker to open Google Maps for driving directions.</div>
        <div id="map"></div>
        <div class="meta" style="margin-top:8px">
          <button class="ghost" id="locateBtn" title="Center map to your current location">Locate Me</button>
          <span style="margin-left:8px;color:var(--muted)">Your location never leaves your device.</span>
        </div>
      </div>

      <!-- Table -->
      <div id="tableCard" class="card">
        <div class="meta"><span id="count"></span></div>
        <div style="overflow:auto">
          <table id="tbl">
            <thead>
              <tr>
                <th class="num">#</th>
                <th>Branch</th>
                <th>Coordinates (Lat, Long)</th>
                <th class="actions">Open</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Full-screen letter overlay -->
  <div id="letterOverlay" aria-hidden="true"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* ---------------- Data + helpers ---------------- */
    const RAW = `NLPL AFZALPUR BRANCH\t17.1997779,76.3536049
NLPL AJJAMPURA BRANCH\t13.726274, 76.008817
NLPL ALAND BRANCH\t17.56226002198624, 76.56776810223826
NLPL ALMEL BRANCH\t17.0941269,76.2197611
NLPL ATHANI BRANCH\t16.731664605042315, 75.06067059367254
NLPL AURAD BRANCH\t18.250104513120924, 77.42520775345791
NLPL BADAMI BRANCH\t15.926857056660136, 75.67826208217068
NLPL BAGALKOT BRANCH\t16.1768599,75.6597316
NLPL BAGEPALLI BRANCH\t13.7852289,77.7795089
NLPL BAILHONGAL BRANCH\t15.807628477438666, 74.8463467247143
NLPL BALLARI BRANCH\t15.161332744384001, 76.89705008937929
NLPL BANGARPET BRANCH\t13.0123635,78.1717471
NLPL BASAVAKALYAN BRANCH\t17.861923, 76.949958
NLPL BELAGAVI BRANCH\t15.88406656045591, 74.51021291122528
NLPL BETHAMANGALA BRANCH\t13.1542039,78.3894376
NLPL BHALKI BRANCH\t18.05057776924593, 77.2234186532665
NLPL BIDAR BRANCH\t17.889206646555838, 77.51499379978596
NLPL BIDAR-2 BRANCH\t17.932449990450877, 77.4836578108111
NLPL BILAGI BRANCH\t16.34086241329985
, 75.63383153331466
NLPL BUDWAL BRANCH\t14.7395228,79.061661
NLPL CHADCHAN BRANCH\t17.3110572,75.6606753
NLPL CHALLAKERE BRANCH\t14.30718700601603, 76.63572666930843
NLPL CHANDAPURA BRANCH\t12.788410642428197, 77.70438873002904
NLPL CHANNAGIRI BRANCH\t14.0259139,75.9248238
NLPL CHIKBALLAPURA BRANCH\t13.432843, 77.731872
NLPL CHIKKAMAGALURU BRANCH\t13.335988101791475, 75.79655929444841
NLPL CHIKKANAYAKANAHALLI BRANCH\t13.4096649,76.6179462
NLPL CHIKKODI BRANCH\t16.428683671314783, 74.58353865261896
NLPL CHINCHOLI BRANCH\t17.455058,77.4212892
NLPL CHINTAMANI BRANCH\t13.39054,78.047506
NLPL CHITRADURGA BRANCH\t14.235082884732288, 76.41107322883644
NLPL DABUSPET BRANCH\t13.229274926515624, 77.23989524232711
NLPL DAVANAGERE BRANCH\t14.4437731,75.9283368
NLPL DEVADURGA BRANCH\t16.417179,76.9269371
NLPL DEVANAHALLI BRANCH\t13.256782,77.7228719
NLPL DHARMAVARAM BRANCH\t14.404071, 77.709700
NLPL DHARWAD BRANCH\t15.463167930693144, 74.98723517463061
NLPL DODDABALLAPURA BRANCH\t13.308838188553954, 77.54578215535943
NLPL GADAG BRANCH\t15.4317304,75.6421109
NLPL GADWAL BRANCH\t16°14'13.8"N 77°48'21.2"E
NLPL GAJENDRAGAD BRANCH\t15.733954554022079, 75.96230023558951
NLPL GANGAVATHI BRANCH\t15.4286741,76.5243031
NLPL GOKAK BRANCH\t16.163545548331417, 74.81062445399157
NLPL GOWRIBIDANUR BRANCH\t13.617101, 77.518174
NLPL GUBBI BRANCH\t13.3074653,76.9452
NLPL HAGARIBOMMANAHALLI BRANCH\t15.0439943,76.203002
NLPL HARAPANAHALLI BRANCH\t14.782967847998629, 75.9939722000005
NLPL HARIHARA BRANCH\t14.4978145,75.8062615
NLPL HEBBAL BRANCH\t13.046004194735188, 77.54776963254638
NLPL HIRIYUR BRANCH\t13.95323734452114, 76.61266874636014
NLPL HOLAKERE BRANCH\t14.0429936,76.1806632
NLPL HONNALI BRANCH\t14.2355796,75.6463012
NLPL HOSADURGA BRANCH\t13.799741, 76.281405
NLPL HOSPET BRANCH\t15.2664487,76.3729922
NLPL HUBLI BRANCH\t15.343333513840527, 75.11632851618188
NLPL HUBLI-2 BRANCH\t15.3921872048847, 75.08086284161423
NLPL HULIYAR BRANCH\t13.5831178,76.5402221
NLPL HULSOOR BRANCH\t18.018590539861165, 77.0050410423271
NLPL HUMNABAD BRANCH\t17.773303, 77.121126
NLPL HUNGUND BRANCH\t16.057482, 75.939514
NLPL HUVENAHADAGALLI BRANCH\t15.0158027,75.9290902
NLPL INDI BRANCH\t17.1798611,75.9575278
NLPL J P NAGAR BRANCH\t12.880862007333317, 77.56768996348002
NLPL JAGALORE BRANCH\t14.520170106529038, 76.33701459131429
NLPL JAMAKHANDI BRANCH\t16.51190913931777, 75.26428326276755
NLPL JEVARGI BRANCH\t17.0088518,76.7741078
NLPL KADAPA BRANCH\t14.467822,78.8533828
NLPL KADIRI BRANCH\t14.095472, 78.163972
NLPL KADUR BRANCH\t13.548971091968893, 76.01678616749366
NLPL KALAGI BRANCH\t17.3597566,77.1546186
NLPL KALBURGI 1 & 2 BRANCH\t17.3364636,76.8590702
NLPL KALGHATGI BRANCH\t15.180905126494222, 74.97586369912399
NLPL KAMALAPURA BRANCH\t17.5869591,76.9881501
NLPL KENGERI BRANCH\t12.963328417190176, 77.4765347839842
NLPL KHANAHOSAHALLI BRANCH\t14.648576242485095, 76.46650487115161
NLPL KITTUR BRANCH\t15.595249735117445, 74.78107102638802
NLPL KODANGAL BRANCH\t17.3349939,77.9050743
NLPL KOLAR BRANCH\t13.1230352,78.1272801
NLPL KOPPAL BRANCH\t15.3576302,76.1456525
NLPL KORATAGERE BRANCH\t13.5200295,77.2354506
NLPL KOTTURU BRANCH\t14.82214113977693, 76.21756632885065
NLPL KUDATHINI BRANCH\t15.197449704401095, 76.76034836878908
NLPL KUDLIGI BRANCH\t14.903867321976593, 76.39074365924527
NLPL KUNIGAL BRANCH\t13.0281964,77.0372279
NLPL KUSHTAGI BRANCH\t15.7491399,76.19217
NLPL LAXMESHWAR BRANCH\t15.1281544,75.4723542
NLPL LINGSUGUR BRANCH\t16.1574064,76.5221158
NLPL LOKAPUR BRANCH\t16.160192740478404, 75.3730606968417
NLPL MADHUGIRI BRANCH\t13.6611445,77.2167198
NLPL MAHABUB NAGAR BRANCH\t16.7276137,77.984084
NLPL MALUR BRANCH\t12.9994716,77.9378283
NLPL MANVI BRANCH\t15.9995322,77.0478732
NLPL MARIKAL BRANCH\t16.601622, 77.719875
NLPL MUDALAGI BRANCH\t16.34058606256304, 74.96868188990965
NLPL MUDDEBIHAL BRANCH\t16.5754961,75.9737627
NLPL MUDIGERE BRANCH\t13.139689314519405, 75.64357546219954
NLPL MUNDARAGI BRANCH\t15.2045,75.8858611
NLPL NARAGUNDA BRANCH\t15.719347137547135, 75.38436777559099
NLPL NARAYANKHED BRANCH\t18.0381237,77.7899481
NLPL NIPPANI BRANCH\t16.40596433525752, 74.37724545398395
NLPL NR PURA BRANCH\t13.606910303836482, 75.50203319793275
NLPL PANCHANHALLI BRANCH\t13.548023, 76.334716
NLPL RAICHUR BRANCH\t16.2070104,77.3364841
NLPL RAMDURGA BRANCH\t15.949960000253625, 75.29228137301867
NLPL SANDURU BRANCH\t15.090327, 76.548987
NLPL SANGAREDDY BRANCH\t17.593815, 78.071960
NLPL SANTHEBENNURU BRANCH\t14.1687778,76.003
NLPL SEDAM BRANCH\t17.1727473,77.2834414
NLPL SHAHAPUR BRANCH\t16.6874351,76.8483552
NLPL SINDAGI BRANCH\t16.9140642,76.2301392
NLPL SINDHNUR BRANCH\t15.7556867,76.7536364
NLPL SIRA BRANCH\t13.7435876,76.90224
NLPL SIRUGUPPA BRANCH\t15.6284649,76.8925182
NLPL SIRWAR BRANCH\t16.174138,77.0231164
NLPL SRINIVASPURA BRANCH\t13.3439404,78.2139166
NLPL TALIKOTI BRANCH\t16.4849816,76.3065931
NLPL TANDUR BRANCH\t17.261997, 77.596153
NLPL TARIKERE BRANCH\t13.697152311432712, 75.82197494005081
NLPL TIKOTA BRANCH\t16.8410784,75.5215685
NLPL TIPTUR BRANCH\t13.2580006,76.4506201
NLPL TUMKUR BRANCH\t13.3157854,77.1212647
NLPL TUREVEKERE BRANCH\t13.1668995,76.6662337
NLPL VIJAYAPUR BRANCH\t16.8308997,75.7008777
NLPL YADGIR BRANCH\t16.7649523,77.1526902
NLPL YARAGATTI BRANCH\t15.967944022715036, 75.02098953820831
NLPL ZAHEERABAD BRANCH\t17.691302, 77.639235`;

    const d = (v,p=6)=>Number(v).toFixed(p);
    const gmUrl = (lat,lon)=>`https://www.google.com/maps?q=${lat},${lon}`;

    function parseDMS(dmsStr){
      const re=/(\d+)°(\d+)'([\d.]+)"([NS])\s+(\d+)°(\d+)'([\d.]+)"([EW])/;
      const m=dmsStr.match(re); if(!m) return null;
      const [_,d1,m1,s1,h1,d2,m2,s2,h2]=m;
      const lat=(+d1+ m1/60 + s1/3600)*(h1==='S'?-1:1);
      const lon=(+d2+ m2/60 + s2/3600)*(h2==='W'?-1:1);
      return {lat,lon};
    }
    function parseRaw(raw){
      return raw.split(/\n+/).map(l=>l.trim()).filter(Boolean).map(line=>{
        if(line.includes('°')){
          const m=line.match(/^(.*?)\s*(\d+°\d+'[\d.]+"[NS]\s+\d+°\d+'[\d.]+"[EW])/);
          if(m){ const name=m[1].trim(); const c=parseDMS(m[2]); if(c) return {name,lat:c.lat,lon:c.lon}; }
        }
        const m2=line.match(/^(.*?)([-+]?\d+(?:\.\d+)?)\s*,\s*([-+]?\d+(?:\.\d+)?)/);
        if(m2){ const name=m2[1].trim().replace(/\s+$/,''); return {name,lat:+m2[2],lon:+m2[3]}; }
        return null;
      }).filter(Boolean);
    }
    const rows = parseRaw(RAW);

    /* ---------------- Map + table ---------------- */
    let map, markersLayer;
    const markersIndex = new Map();

    function initMap(){
      map = L.map('map',{scrollWheelZoom:true});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom:19,
        attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      updateMarkers('');
    }
    function updateMarkers(filter){
      markersLayer.clearLayers();
      markersIndex.clear();
      const filtered = rows.filter(r=>r.name.toLowerCase().includes(filter.toLowerCase()));
      const bounds=[];
      filtered.forEach(r=>{
        const marker = L.marker([r.lat,r.lon])
          .bindPopup(`<strong>${r.name}</strong><br/>(${d(r.lat)}, ${d(r.lon)})<br/><a href="${gmUrl(r.lat,r.lon)}" target="_blank" rel="noopener">Open in Google Maps</a>`)
          .on('click',()=>window.open(gmUrl(r.lat,r.lon), '_blank'));
        marker.addTo(markersLayer);
        markersIndex.set(r.name, marker);
        bounds.push([r.lat,r.lon]);
      });
      if(bounds.length){ map.fitBounds(bounds,{padding:[30,30]}); }
      else{ map.setView([15.5,76.5],6); }
    }

    const tbody  = document.querySelector('#tbl tbody');
    const countEl= document.getElementById('count');
    function render(filter=''){
      tbody.innerHTML='';
      const filtered = rows.filter(r=>r.name.toLowerCase().includes(filter.toLowerCase()));
      let i=0;
      filtered.forEach(r=>{
        const tr=document.createElement('tr');

        const n=document.createElement('td'); n.className='num'; n.textContent=(++i).toString();

        const name=document.createElement('td'); name.className='name';
        const aName=document.createElement('a'); aName.href=gmUrl(r.lat,r.lon);
        aName.target='_blank'; aName.rel='noopener'; aName.textContent=r.name;
        aName.style.color='#0a84ff'; aName.style.textDecoration='none';
        aName.onmouseenter=()=>aName.style.textDecoration='underline';
        aName.onmouseleave=()=>aName.style.textDecoration='none';
        name.appendChild(aName);

        const coords=document.createElement('td'); coords.className='coords';
        const aCoords=document.createElement('a'); aCoords.href=gmUrl(r.lat,r.lon);
        aCoords.target='_blank'; aCoords.rel='noopener'; aCoords.textContent=`(${d(r.lat)}, ${d(r.lon)})`;
        coords.appendChild(aCoords);

        const actions=document.createElement('td'); actions.className='actions';
        const btn=document.createElement('a'); btn.className='btn'; btn.href=gmUrl(r.lat,r.lon);
        btn.target='_blank'; btn.rel='noopener'; btn.textContent='Open in Maps';
        actions.appendChild(btn);

        tr.append(n,name,coords,actions);
        tbody.appendChild(tr);
      });
      countEl.textContent = `${filtered.length} shown of ${rows.length} branches`;
      if(map) updateMarkers(filter);
    }

    /* ---------------- Controls ---------------- */
    const search    = document.getElementById('search');
    const clearBtn  = document.getElementById('clearBtn');
    const copyBtn   = document.getElementById('copyBtn');
    const fitBtn    = document.getElementById('fitBtn');
    const locateBtn = document.getElementById('locateBtn');
    const demoBtn   = document.getElementById('demoBtn');
    const stage     = document.getElementById('stage');
    const overlay   = document.getElementById('letterOverlay');

    search.addEventListener('input', ()=>render(search.value));
    clearBtn.addEventListener('click', ()=>{ search.value=''; render(''); });
    copyBtn.addEventListener('click', ()=>{
      const visible = Array.from(document.querySelectorAll('#tbl tbody tr')).map(tr=>{
        const name = tr.children[1].innerText.trim();
        const coordTxt = tr.children[2].innerText.replace(/[()]/g,'').trim();
        return `${name},${coordTxt}`;
      }).join('\n');
      navigator.clipboard.writeText(visible).then(()=>{
        copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Export CSV',1200);
      });
    });
    fitBtn.addEventListener('click', ()=>updateMarkers(search.value));
    locateBtn.addEventListener('click', ()=>{
      if(!navigator.geolocation) return alert('Geolocation not supported');
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude:lat, longitude:lon}=pos.coords;
        L.circleMarker([lat,lon],{radius:6,color:'#0a84ff'}).addTo(map).bindPopup('You are here');
        map.setView([lat,lon],12);
      }, err=>alert('Location failed: '+err.message), {enableHighAccuracy:true, timeout:8000});
    });

    /* ---------------- Precision tracking (30–45s window) ---------------- */
    const TRACK_WINDOW_MS = 45000; // feature stays active up to 45s
    let trackUntil = 0;

    function caretPixelX(text){
      const span = document.createElement('span');
      span.style.visibility='hidden';
      span.style.position='absolute';
      span.style.whiteSpace='pre';
      span.style.font = getComputedStyle(search).font;
      span.textContent = text;
      document.body.appendChild(span);
      const w = span.getBoundingClientRect().width;
      document.body.removeChild(span);
      const pad = 12; // input padding
      return pad + w;
    }

    function computeCaretTarget(currentText){
      const r = search.getBoundingClientRect();
      const x = r.left + caretPixelX(currentText) + 6;
      const y = r.top + r.height/2;
      return { x, y };
    }

    // Letter phases: 1s full-screen hold -> 2s fly (retargeting during window) -> 1s impact
    function flyLetterHitDynamic(letter, currentText){
      return new Promise(resolve=>{
        overlay.classList.add('show');
        const el = document.createElement('div');
        el.className = 'fletter';
        el.textContent = letter;
        overlay.appendChild(el);

        // ---- Phase A: full-screen hold (1s)
        const holdTimer = setTimeout(()=>{
          // ---- Phase B: start flight (2s) with live re-targeting while window active
          const start = performance.now();
          const flightMs = 2000;

          // Initial shrink command
          el.style.transform = 'translate(0,0) scale(0.10)';
          el.style.opacity   = '.10';

          let followTimer = null;
          const stepFollow = ()=>{
            if (performance.now() > trackUntil){ // window over: stop following
              if (followTimer) clearInterval(followTimer);
              followTimer = null;
              return;
            }
            const {x,y} = computeCaretTarget(currentText);
            const box = el.getBoundingClientRect();
            const targetLeft = x - box.width*0.05;
            const targetTop  = y - box.height*0.05;
            el.style.left = targetLeft + 'px';
            el.style.top  = targetTop + 'px';
          };
          // Immediately set first target
          stepFollow();
          // Follow ~12 fps; smoothened by .2s CSS transition
          followTimer = setInterval(stepFollow, 80);

          // After full 2s flight -> impact for 1s
          const flightTimer = setTimeout(()=>{
            if (followTimer) clearInterval(followTimer);
            document.body.classList.add('shake-now');
            const impactTimer = setTimeout(()=>{
              document.body.classList.remove('shake-now');
              overlay.removeChild(el);
              if(!overlay.children.length) overlay.classList.remove('show');
              resolve();
            }, 1000); // 1s impact
          }, Math.max(0, flightMs - (performance.now()-start)));

        }, 1000); // 1s hold
      });
    }

    function pickBranchForTyping(){
      const pick = rows[Math.floor(Math.random()*rows.length)].name.toUpperCase();
      return pick.replace(/^NLPL\s+/,'').replace(/\s+BRANCH.*$/,'').trim();
    }

    async function typeFullNameWithFX(name){
      search.focus();
      search.classList.add('spotlight');
      search.value = '';
      render('');
      for(const ch of name){
        if(/[A-Z0-9]/i.test(ch)){
          await flyLetterHitDynamic(ch, search.value); // holds, flies w/ tracking, impacts
          search.value += ch;
          search.dispatchEvent(new Event('input'));
        }else{
          // Preserve spaces/punctuation rhythm
          await new Promise(r=>setTimeout(r, 300));
          search.value += ch;
          search.dispatchEvent(new Event('input'));
        }
      }
      search.classList.remove('spotlight');
    }

    /* ---------------- Demo sequence ---------------- */
    async function runDemo(){
      if(demoBtn.disabled) return;
      demoBtn.disabled = true;
      const originalLabel = demoBtn.textContent;
      demoBtn.textContent = 'Running…';

      // Enable precision tracking window
      trackUntil = performance.now() + TRACK_WINDOW_MS;

      // Scroll whole screen up ~2s, then snap back
      document.body.classList.add('demo-scroll-up');
      await new Promise(r=>setTimeout(r, 2100));
      document.body.classList.remove('demo-scroll-up');
      document.body.classList.add('demo-scroll-reset');
      await new Promise(r=>setTimeout(r, 260));
      document.body.classList.remove('demo-scroll-reset');

      // Full-name letter-by-letter FX into search (with live tracking)
      const name = pickBranchForTyping();
      await typeFullNameWithFX(name);

      // Clear + Fit All
      await new Promise(r=>setTimeout(r, 700));
      clearBtn.click();
      await new Promise(r=>setTimeout(r, 250));
      fitBtn.click();

      // Done
      demoBtn.textContent = originalLabel; // back to "Demo"
      demoBtn.disabled = false;
    }
    document.getElementById('demoBtn').addEventListener('click', runDemo);

    /* ---------------- Boot ---------------- */
    render('');
    initMap();
  </script>
</body>
</html>
