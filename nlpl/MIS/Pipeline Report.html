<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DB pipeline</title>

<!-- SheetJS for XLSX read/write -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  :root{
    --bg:#ffffff;
    --ink:#0f172a;
    --muted:#475569;
    --card:#ffffff;
    --ring:#e2e8f0;
    --surface:#f8fafc;
    --accent:#2563eb;
    --accent-soft:rgba(37,99,235,.08);
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    min-height:100vh;
    font:14px/1.45 'Inter', system-ui,Segoe UI,Roboto,sans-serif;
    background:linear-gradient(180deg,#f8fafc 0%,#ffffff 50%,#f3f5f9 100%);
    color:var(--ink);
  }
  .wrap{
    max-width:900px;
    margin:36px auto;
    padding:0 16px 40px;
  }
  h1{
    margin:0 0 12px;
    font-size:26px;
    color:var(--ink);
  }
  .hero{
    margin:0 -4px 20px;
    padding:14px 16px;
    border-radius:14px;
    background:linear-gradient(135deg,#ecf2ff,#f8fafc);
    border:1px solid rgba(37,99,235,.2);
    box-shadow:0 14px 35px rgba(15,23,42,.08);
  }
  .hero p{
    margin:0;
    font-size:14px;
    color:#111827;
  }
  .hero-strong{
    font-weight:600;
  }
  .card{
    background:var(--card);
    border:1px solid var(--ring);
    border-radius:18px;
    padding:22px 20px 24px;
    box-shadow:0 10px 30px rgba(15,23,42,.08);
  }

  /* Drag & Drop Box */
  .dropzone-label{
    display:block;
    border-radius:18px;
    border:2px dashed #9ca3af;
    background:#e5e7eb;
    padding:42px 24px;
    text-align:center;
    cursor:pointer;
    transition:background .2s ease, border-color .2s ease, transform .15s ease, box-shadow .15s ease;
  }
  .dropzone-label:hover{
    background:#d4d4d8;
    border-color:#4b5563;
    transform:translateY(-1px);
    box-shadow:0 14px 30px rgba(15,23,42,.12);
  }
  .dropzone-label.is-dragover{
    background:#d1d5db;
    border-color:#111827;
    box-shadow:0 18px 40px rgba(15,23,42,.2);
  }
  .dropzone-icon{
    font-size:36px;
    margin-bottom:6px;
  }
  .dropzone-title{
    font-size:16px;
    font-weight:600;
    margin-bottom:4px;
  }
  .dropzone-sub{
    font-size:13px;
    color:var(--muted);
    margin-bottom:10px;
  }
  .dropzone-chip{
    display:inline-block;
    margin-top:6px;
    padding:6px 10px;
    font-size:11px;
    border-radius:999px;
    border:1px solid rgba(15,23,42,.18);
    background:rgba(255,255,255,.7);
    color:#111827;
  }

  .note{
    margin-top:14px;
    font-size:12px;
    color:var(--muted);
  }

  /* File list */
  .file-list-wrap{
    margin-top:20px;
    border-top:1px solid var(--ring);
    padding-top:16px;
  }
  .file-list-title{
    font-size:14px;
    font-weight:600;
    margin-bottom:8px;
  }
  .file-empty{
    font-size:12px;
    color:var(--muted);
  }
  .file-list{
    list-style:none;
    padding:0;
    margin:0;
  }
  .file-item{
    padding:10px 12px;
    border-radius:10px;
    background:#f9fafb;
    border:1px solid #e5e7eb;
    display:flex;
    flex-direction:column;
    gap:2px;
    margin-bottom:8px;
  }
  .file-name{
    font-size:13px;
    font-weight:600;
    color:#111827;
    word-break:break-all;
  }
  .file-meta{
    font-size:11px;
    color:var(--muted);
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .file-meta span::before{
    content:"â€¢ ";
  }

  /* Actions row */
  .actions{
    margin-top:18px;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    justify-content:space-between;
  }
  .buttons{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .btn{
    appearance:none;
    border:none;
    outline:none;
    font-family:inherit;
    font-size:13px;
    font-weight:500;
    padding:8px 16px;
    border-radius:999px;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:6px;
    transition:background .15s ease, box-shadow .15s ease, transform .1s ease;
  }
  .btn:active{
    transform:translateY(1px);
    box-shadow:none;
  }
  .btn-primary{
    background:var(--accent);
    color:#f9fafb;
    box-shadow:0 8px 18px rgba(37,99,235,.35);
  }
  .btn-primary:hover{
    background:#1d4ed8;
  }
  .btn-ghost{
    background:#f3f4f6;
    color:#111827;
    border:1px solid #e5e7eb;
  }
  .btn-ghost:hover{
    background:#e5e7eb;
  }

  .status-line{
    font-size:12px;
    color:var(--muted);
    display:flex;
    align-items:center;
    gap:6px;
    min-height:18px;
  }
  .status-pill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:18px;
    height:18px;
    border-radius:999px;
    font-size:11px;
    font-weight:600;
    padding:0 6px;
    background:#f3f4f6;
    color:#4b5563;
  }
  .status-pill.ok{
    background:#dcfce7;
    color:#166534;
  }
  .status-pill.err{
    background:#fee2e2;
    color:#b91c1c;
  }
  .status-pill.run{
    background:var(--accent-soft);
    color:#1d4ed8;
  }

  #fileInput{ display:none; }
</style>
</head>
<body>
<div class="wrap">
  <h1>DB pipeline</h1>

  <div class="hero">
    <p>
      Upload your <span class="hero-strong">9 ESAF raw files</span>, then click
      <span class="hero-strong">Play</span> to auto-build the
      <span class="hero-strong">Final MIS â€“ Summary sheet</span>.
      Once itâ€™s ready, click <span class="hero-strong">Download</span> to save the Excel.
    </p>
  </div>

  <div class="card">
    <label for="fileInput" class="dropzone-label" id="dropzone">
      <div class="dropzone-icon">ðŸ“‚</div>
      <div class="dropzone-title">Drag &amp; drop files here</div>
      <div class="dropzone-sub">ESAF CSV files (all 9 at once)</div>
      <div class="dropzone-chip">Or click to browse</div>
    </label>

    <input id="fileInput" type="file" multiple accept=".csv,.xlsx,.xls,.xlsb"/>

    <div class="note">
      Step 1: Add all ESAF raw files. Step 2: Click <strong>Play</strong> to generate the MIS Summary. Step 3: Click <strong>Download</strong>.
    </div>

    <div class="file-list-wrap">
      <div class="file-list-title">Imported files</div>
      <div id="fileEmpty" class="file-empty">No files added yet.</div>
      <ul id="fileList" class="file-list"></ul>
    </div>

    <div class="actions">
      <div class="buttons">
        <button id="btnPlay" class="btn btn-primary" type="button">â–¶ Play (Generate)</button>
        <button id="btnDownload" class="btn btn-ghost" type="button">â¬‡ Download Excel</button>
      </div>
      <div class="status-line">
        <span id="statusPill" class="status-pill">IDLE</span>
        <span id="statusText">Waiting for filesâ€¦</span>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== CONSTANTS =====
  const PRODUCT_NAME_BY_SCHEME = {
    "104207": "IGL",
    "604001": "FIG",
    "204207": "IGL",
    "81402":  "VVY",
    "80401":  "MEL"
  };

  // ===== UTIL =====
  function formatSize(bytes){
    if (bytes == null || isNaN(bytes)) return '0 B';
    const units = ['B','KB','MB','GB'];
    let i = 0, num = bytes;
    while (num >= 1024 && i < units.length - 1){
      num /= 1024;
      i++;
    }
    return num.toFixed(num >= 10 || i === 0 ? 0 : 1) + ' ' + units[i];
  }
  function formatDate(d){
    if (!(d instanceof Date) || isNaN(d.getTime())) return 'Unknown date';
    return d.toLocaleString('en-IN', {
      year:'numeric', month:'short', day:'2-digit',
      hour:'2-digit', minute:'2-digit'
    });
  }
  function formatAsOnDate(){
    const d = new Date();
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    return `${dd}-${mm}-${yyyy}`;
  }
  function setStatus(mode, text){
    const pill = document.getElementById('statusPill');
    const label = document.getElementById('statusText');
    pill.classList.remove('ok','err','run');
    if (mode === 'ok') pill.classList.add('ok');
    else if (mode === 'err') pill.classList.add('err');
    else if (mode === 'run') pill.classList.add('run');
    pill.textContent =
      mode === 'ok' ? 'OK' :
      mode === 'err' ? 'ERR' :
      mode === 'run' ? 'RUN' : 'IDLE';
    label.textContent = text || '';
  }

  // Only read ONE file as workbook (the ClientDisbursementDetail one)
  function readFileAsWorkbook(file){
    return new Promise((resolve, reject) => {
      const ext = (file.name.split('.').pop() || '').toLowerCase();
      const reader = new FileReader();
      reader.onerror = () => reject(reader.error);

      if (ext === 'csv'){
        reader.onload = e => {
          try{
            const text = e.target.result;
            const wb = XLSX.read(text, { type:'string' });
            resolve(wb);
          }catch(err){
            reject(err);
          }
        };
        reader.readAsText(file);
      }else{
        reader.onload = e => {
          try{
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type:'array' });
            resolve(wb);
          }catch(err){
            reject(err);
          }
        };
        reader.readAsArrayBuffer(file);
      }
    });
  }

  function buildSummarySheet(disbRows, asOnDate){
    const headers = [
      'Sl No','BCName','TerritoryName','ClusterName','DivisionName','Region',
      'BranchCategoryID','BranchID','BranchName','CenterID','CenterName',
      'CreditOffcierName','MeetingDay','CenterLocation','ClientID','ClientName',
      'ClientType','JoinedDate','Address','PhoneNo','SchemeID/ProductID',
      'Product Name','Client id','LoanApplDate','LoanSancDate','AccountID',
      'LoanSeries','LoanDisbDate','DisbAmount','Amount','InterestRate',
      'ProcessingFee','ServiceTax','DocumentFee','InsuranceFee','LoanPurpose',
      'Sector','DisbursmentMode','ProfileCIFID','OperativeAccount','ValueDate',
      'Status'
    ];
    const aoa = [headers];
    let sl = 1;
    for (const row of disbRows){
      let branchId = row['BranchID'];
      if (branchId == null) branchId = '';
      else branchId = String(branchId).split('.')[0];

      const schemeRaw = row['SchemeID/ProductID'];
      const schemeKey = schemeRaw == null ? '' : String(schemeRaw);
      const productName = PRODUCT_NAME_BY_SCHEME[schemeKey] || '';

      const loanApplId = row['LoanApplID'] || row['LoanApplId'] || row['LoanAppID'] || '';

      const disbAmtNum = Number(row['DisbAmount'] || 0);
      const amtCr = disbAmtNum ? disbAmtNum / 10000000 : 0;

      const statusText = 'Disbursed Till ' + asOnDate;

      aoa.push([
        sl++,
        row['BCName'] || '',
        row['TerritoryName'] || '',
        row['ClusterName'] || '',
        row['DivisionName'] || '',
        '',
        row['BranchCategoryID'] || '',
        branchId,
        row['BranchName'] || '',
        row['CenterID'] || '',
        row['CenterName'] || '',
        row['CreditOffcierName'] || '',
        row['MeetingDay'] || '',
        row['CenterLocation'] || '',
        row['ClientID'] || '',
        row['ClientName'] || '',
        row['ClientType'] || '',
        row['JoinedDate'] || '',
        row['Address'] || '',
        row['PhoneNo'] || '',
        row['SchemeID/ProductID'] || '',
        productName,
        loanApplId,
        row['LoanApplDate'] || '',
        row['LoanSancDate'] || '',
        row['AccountID'] || '',
        row['LoanSeries'] || '',
        row['LoanDisbDate'] || '',
        disbAmtNum,
        amtCr,
        row['InterestRate'] || '',
        row['ProcessingFee'] || '',
        row['ServiceTax'] || '',
        row['DocumentFee'] || '',
        row['InsuranceFee'] || '',
        row['LoanPurpose'] || '',
        row['Sector'] || '',
        row['DisbursmentMode'] || '',
        row['ProfileCIFID'] || '',
        row['OperativeAccount'] || '',
        row['ValueDate'] || '',
        statusText
      ]);
    }
    return aoa;
  }

  // ===== STATE =====
  const fileInput   = document.getElementById('fileInput');
  const dropzone    = document.getElementById('dropzone');
  const fileList    = document.getElementById('fileList');
  const fileEmpty   = document.getElementById('fileEmpty');
  const btnPlay     = document.getElementById('btnPlay');
  const btnDownload = document.getElementById('btnDownload');

  let currentFiles = [];
  let finalBlob = null;
  let lastSummaryCount = 0;

  function renderFiles(fileListLike){
    const files = Array.from(fileListLike || []);
    currentFiles = files;
    fileList.innerHTML = '';

    if (!files.length){
      fileEmpty.style.display = 'block';
      setStatus('idle','Waiting for filesâ€¦');
      return;
    }

    files.sort((a, b) => a.name.localeCompare(b.name));
    fileEmpty.style.display = 'none';

    files.forEach(file => {
      const li = document.createElement('li');
      li.className = 'file-item';

      const nameEl = document.createElement('div');
      nameEl.className = 'file-name';
      nameEl.textContent = file.name;

      const metaEl = document.createElement('div');
      metaEl.className = 'file-meta';

      const type = file.type || (file.name.split('.').pop() || '').toUpperCase() || 'Unknown';
      const size = formatSize(file.size);
      const date = formatDate(new Date(file.lastModified));

      const typeSpan = document.createElement('span');
      typeSpan.textContent = 'Type: ' + type;
      const sizeSpan = document.createElement('span');
      sizeSpan.textContent = 'Size: ' + size;
      const dateSpan = document.createElement('span');
      dateSpan.textContent = 'Last modified: ' + date;

      metaEl.appendChild(typeSpan);
      metaEl.appendChild(sizeSpan);
      metaEl.appendChild(dateSpan);

      li.appendChild(nameEl);
      li.appendChild(metaEl);
      fileList.appendChild(li);
    });

    setStatus('idle', `Ready. ${files.length} file(s) selected.`);
  }

  fileInput.addEventListener('change', e => renderFiles(e.target.files));

  ['dragenter','dragover'].forEach(eventName => {
    dropzone.addEventListener(eventName, e => {
      e.preventDefault();
      e.stopPropagation();
      dropzone.classList.add('is-dragover');
    });
  });
  ['dragleave','drop'].forEach(eventName => {
    dropzone.addEventListener(eventName, e => {
      e.preventDefault();
      e.stopPropagation();
      if (eventName === 'dragleave' && !dropzone.contains(e.relatedTarget)) {
        dropzone.classList.remove('is-dragover');
      }
      if (eventName === 'drop') {
        dropzone.classList.remove('is-dragover');
        const dt = e.dataTransfer;
        if (dt && dt.files && dt.files.length) {
          renderFiles(dt.files);
        }
      }
    });
  });

  // ===== PLAY =====
  btnPlay.addEventListener('click', async () => {
    if (!currentFiles.length){
      setStatus('err','Add all raw files first, then click Play.');
      return;
    }

    setStatus('run','Looking for ClientDisbursementDetail fileâ€¦');
    finalBlob = null;
    lastSummaryCount = 0;

    try{
      const disbFile = currentFiles.find(f =>
        /ClientDisbursementDetail/i.test(f.name)
      );

      if (!disbFile){
        setStatus('err','No file with "ClientDisbursementDetail" in the name. Check file names.');
        return;
      }

      setStatus('run',`Reading ${disbFile.name}â€¦`);

      const wb = await readFileAsWorkbook(disbFile);
      const sheetName = wb.SheetNames[0];
      if (!sheetName){
        setStatus('err','Disbursement file has no sheet.');
        return;
      }
      const ws = wb.Sheets[sheetName];
      const disbRows = XLSX.utils.sheet_to_json(ws, { defval: "" });

      if (!disbRows.length){
        setStatus('err','Disbursement file has no data rows.');
        return;
      }

      const asOn = formatAsOnDate();
      const summaryAOA = buildSummarySheet(disbRows, asOn);

      const wbOut = XLSX.utils.book_new();
      const wsSummary = XLSX.utils.aoa_to_sheet(summaryAOA);
      XLSX.utils.book_append_sheet(wbOut, wsSummary, 'Summary');

      const wbArray = XLSX.write(wbOut, { bookType:'xlsx', type:'array' });
      finalBlob = new Blob(
        [wbArray],
        { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }
      );
      lastSummaryCount = disbRows.length;

      setStatus('ok', `Final Excel ready â€“ Summary: ${lastSummaryCount} rows. Click Download.`);
    }catch(err){
      console.error(err);
      setStatus('err','Error while processing: ' + (err && err.message ? err.message : String(err)));
    }
  });

  // ===== DOWNLOAD =====
  btnDownload.addEventListener('click', () => {
    if (!finalBlob){
      setStatus('err','No file ready. Click Play to generate MIS first.');
      return;
    }
    const asOn = formatAsOnDate();
    const filename = `NLPL-ESAF BC MIS as on${asOn}.xlsx`;

    const url = URL.createObjectURL(finalBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    setStatus('ok', `Downloaded "${filename}" with ${lastSummaryCount} rows.`);
  });

  setStatus('idle','Waiting for filesâ€¦');
</script>
</body>
</html>
