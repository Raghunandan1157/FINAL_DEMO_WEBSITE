<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Disbursement ‚Äî Branch / DM / Region (Paste/Upload ‚Üí CSV/PNG/PDF)</title>

<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js"></script>
<!-- jsPDF (for PDF export) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
  :root{
    --bg:#ffffff;
    --ink:#0f172a;
    --muted:#475569;
    --card:#ffffff;
    --ring:#e2e8f0;
    --brand:#2563eb;
    --brand-dark:#1d4ed8;
    --surface:#f8fafc;
    --border-soft:#dbe1f5;
  }
  body{
    margin:0;
    min-height:100vh;
    font:14px/1.45 'Inter', system-ui,Segoe UI,Roboto,sans-serif;
    background:linear-gradient(180deg,#f8fafc 0%,#ffffff 50%,#f3f5f9 100%);
    color:var(--ink);
  }
  .wrap{
    max-width:1100px;
    margin:36px auto;
    padding:0 16px 40px;
  }
  .card{
    background:var(--card);
    border:1px solid var(--ring);
    border-radius:18px;
    padding:20px 22px 16px;
    box-shadow:0 10px 30px rgba(15,23,42,.08);
    transition:border-color .2s ease, background .2s ease, box-shadow .2s ease;
  }
  .card.dragging{
    border-color:var(--brand);
    background:linear-gradient(135deg,#eef2ff,#f9fafb);
    box-shadow:0 16px 32px rgba(37,99,235,.25);
  }
  h1{
    margin:0;
    font-size:26px;
    color:var(--ink);
  }
  .hero{
    margin:0 -6px 18px;
    padding:16px 18px;
    border-radius:14px;
    background:linear-gradient(135deg,#ecf2ff,#f8fafc);
    border:1px solid rgba(37,99,235,.2);
    box-shadow:0 14px 35px rgba(15,23,42,.08);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:18px;
    flex-wrap:wrap;
  }
  .hero p{
    margin:0;
    color:#111827;
    font-size:15px;
    max-width:640px;
  }
  .hero-summary{
    display:flex;
    gap:16px;
    flex-wrap:wrap;
  }
  .hero-summary span{
    display:flex;
    flex-direction:column;
    font-size:13px;
    color:#475569;
  }
  .hero-summary strong{
    font-size:18px;
    color:var(--ink);
  }
  .row{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
  }
  .toolbar{
    padding:18px;
    border-radius:20px;
    background:linear-gradient(135deg,#ffffff,#f6f9ff);
    border:1px solid rgba(37,99,235,.15);
    box-shadow:0 20px 35px rgba(15,23,42,.08);
    display:flex;
    gap:20px;
    flex-wrap:wrap;
    align-items:center;
  }
  button{
    border:0;
    border-radius:14px;
    padding:10px 16px;
    font-weight:600;
    font-size:14px;
    color:#fff;
    background:linear-gradient(135deg,var(--brand),var(--brand-dark));
    cursor:pointer;
    transition:transform .2s ease,var(--shadow-transition,box-shadow) .25s ease,filter .2s ease;
    box-shadow:0 18px 25px rgba(37,99,235,.2);
  }
  button:hover{
    transform:translateY(-2px);
    box-shadow:0 20px 30px rgba(37,99,235,.3);
  }
  button:active{
    transform:translateY(0);
    box-shadow:0 12px 18px rgba(37,99,235,.25);
  }
  button:focus-visible{
    outline:2px solid var(--brand-dark);
    outline-offset:2px;
  }
  button.mono{
    background:linear-gradient(135deg,#1f2937,#111827);
    box-shadow:0 18px 25px rgba(15,23,42,.25);
  }
  .note{
    color:var(--muted);
    font-size:13px;
  }
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    font-size:14px;
    background:var(--surface);
  }
  th,td{
    border-bottom:1px solid var(--border-soft);
    padding:10px 8px;
  }
  thead th{
    position:sticky;
    top:0;
    background:#f1f5f9;
    z-index:1;
    color:var(--ink);
    text-align:left;
  }
  tbody tr:hover{
    background:#eef2ff;
  }
  .err{color:#dc2626}
  .ok{color:#16a34a}
  .muted{color:var(--muted)}
  .mini{font-size:12px; color:var(--muted)}

  .col-target { background:#fff7ed; color:#111; }
  .col-ach    { background:#e8f5e9; color:#111; }
  .col-pct    { background:#fffbeb; color:#111; }
  thead th.col-target, thead th.col-ach, thead th.col-pct{ position:sticky; top:0; }

  .total-row td{ font-weight:700; }

  #actionsMain{
    display:none;
    margin-top:10px;
    gap:10px;
  }
  .download-grid{
    display:grid;
    grid-template-columns: repeat(3, minmax(0,1fr));
    gap:16px;
  }
  @media (max-width:900px){
    .download-grid{grid-template-columns:1fr}
    .split{grid-template-columns:1fr}
  }
  .dl-block{
    border:1px solid var(--border-soft);
    border-radius:16px;
    padding:14px 16px 18px;
    background:var(--surface);
    display:flex;
    flex-direction:column;
    gap:10px;
    box-shadow:0 10px 24px rgba(15,23,42,.06);
  }
  .dl-title{
    font-weight:700;
    color:#0f172a;
    font-size:15px;
  }
  .dl-buttons{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .dl-buttons button{
    flex:1 1 auto;
    min-width:90px;
    font-size:13px;
    padding:8px 14px;
    border-radius:12px;
  }
  .split{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
  }

  select{
    width:100%;
    padding:10px;
    border-radius:10px;
    background:#f5f7fb;
    border:1px solid var(--border-soft);
    font:inherit;
    color:var(--ink);
    transition:border-color .2s ease;
  }
  select:focus{
    outline:none;
    border-color:var(--brand-dark);
    box-shadow:0 0 0 3px rgba(37,99,235,.15);
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Disbursement ‚Äî Branch / DM / Region</h1>
  <div class="hero">
    <p>Drop files or paste the updated disbursement sheet, and we will instantly show branch, district, and region insights while keeping downloads quick.</p>
    <div class="hero-summary">
      <span><strong>Multiple views</strong> Branch / DM / Region exports ready</span>
      <span><strong>Fast exports</strong> CSV, PNG, and PDF in one tap</span>
      <span><strong>Smart mapping</strong> Column auto-detect plus overrides</span>
    </div>
  </div>

  <div class="card" id="mainCard">
    <div class="row toolbar" style="align-items:flex-end">
      <div style="flex:2 1 640px">
        <div class="row">
          <button id="pasteBtn">üìã Paste Data (process only)</button>
          <button id="uploadBtn" class="mono">Upload Data Excel/CSV</button>
          <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" style="display:none"/>
        </div>

        <div class="note" style="margin-top:6px" id="msg"></div>
        <div class="note" style="margin-top:4px">
          Drag &amp; drop Excel/CSV files on this card or use ‚ÄúUpload Data Excel/CSV‚Äù. Only file names, sizes, and types will be shown.
        </div>

        <!-- actionsMain kept but always hidden by JS -->
        <div id="actionsMain" class="row" style="margin-top:10px">
          <span class="mini muted" style="align-self:center">Preview:</span>
          <button id="prevBranch">Branch</button>
          <button id="prevDM">District (DM)</button>
          <button id="prevRegion">Region</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Downloads (kept but always hidden) -->
  <div class="card" id="downloadsCard" style="display:none; margin-top:12px">
    <div class="download-grid">
      <div class="dl-block">
        <div class="dl-title">Branch</div>
        <div class="dl-buttons">
          <button id="csvBranch">‚¨áÔ∏è CSV</button>
          <button id="pngBranch">üñºÔ∏è PNG</button>
          <button id="pdfBranch">üìÑ PDF</button>
        </div>
        <div class="mini muted">Uses preloaded Branch targets (uploading a Branch Target CSV will override).</div>
      </div>

      <div class="dl-block">
        <div class="dl-title">District (DM)</div>
        <div class="dl-buttons">
          <button id="csvDM">‚¨áÔ∏è CSV</button>
          <button id="pngDM">üñºÔ∏è PNG</button>
          <button id="pdfDM">üìÑ PDF</button>
        </div>
      </div>

      <div class="dl-block">
        <div class="dl-title">Region</div>
        <div class="dl-buttons">
          <button id="csvRegion">‚¨áÔ∏è CSV</button>
          <button id="pngRegion">üñºÔ∏è PNG</button>
          <button id="pdfRegion">üìÑ PDF</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Two stacked previews -->
  <div class="split" style="margin-top:14px">
    <div class="card">
      <div class="mini muted" style="margin-bottom:6px">Preview (Copy #1 ‚Äî on top)</div>
      <div style="max-height:360px;overflow:auto"><table id="topTable"></table></div>
    </div>
    <div class="card">
      <div class="mini muted" style="margin-bottom:6px">Preview (Copy #2)</div>
      <div style="max-height:360px;overflow:auto"><table id="outTable"></table></div>
    </div>
  </div>
</div>

<script>
/*
  All heavy logic removed.
  Now:
  - Drag & drop files on the first card, or
  - Use the Upload button
  ‚Üí It will ONLY show file name / size / type in the two preview tables.
*/

const mainCard = document.getElementById('mainCard');
const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');
const pasteBtn = document.getElementById('pasteBtn');
const msg = document.getElementById('msg');
const topTable = document.getElementById('topTable');
const outTable = document.getElementById('outTable');
const downloadsCard = document.getElementById('downloadsCard');
const actionsMain = document.getElementById('actionsMain');

// Hide advanced areas forever (no logic)
downloadsCard.style.display = 'none';
actionsMain.style.display = 'none';

// Render files in both tables
function renderFiles(files) {
  if (!files || files.length === 0) {
    topTable.innerHTML = '';
    outTable.innerHTML = '';
    msg.textContent = 'No files.';
    return;
  }

  const header = `
    <thead>
      <tr>
        <th>File name</th>
        <th>Size (KB)</th>
        <th>Type</th>
      </tr>
    </thead>
  `;

  const body = Array.from(files).map(f => {
    const sizeKB = (f.size / 1024).toFixed(1);
    const type = f.type || '‚Äî';
    return `
      <tr>
        <td>${f.name}</td>
        <td style="text-align:right">${sizeKB}</td>
        <td>${type}</td>
      </tr>
    `;
  }).join('');

  const tableHTML = header + `<tbody>${body}</tbody>`;
  topTable.innerHTML = tableHTML;
  outTable.innerHTML = tableHTML;

  msg.innerHTML = `<span class="ok">${files.length} file(s) loaded.</span> Drag and drop again or upload to replace.`;
}

// Handle file list (from drop or input)
function handleFileList(fileList) {
  if (!fileList || fileList.length === 0) {
    renderFiles([]);
    return;
  }
  renderFiles(fileList);
}

// Upload button ‚Üí open file picker
uploadBtn.addEventListener('click', () => fileInput.click());

// File picker change
fileInput.addEventListener('change', (e) => {
  const files = e.target.files;
  handleFileList(files);
  fileInput.value = '';
});

// Simple paste info (no processing)
pasteBtn.addEventListener('click', async () => {
  try {
    if (!(navigator.clipboard && window.isSecureContext)) {
      throw new Error('Clipboard API not available. Use HTTPS/localhost or drag & drop files instead.');
    }
    msg.textContent = 'Clipboard read requested‚Ä¶ (no processing, just info).';
    const text = await navigator.clipboard.readText();
    if (!text || !text.trim()) {
      msg.innerHTML = '<span class="err">Clipboard is empty.</span>';
    } else {
      const lines = text.split(/\r?\n/).filter(Boolean);
      msg.innerHTML = `<span class="ok">Clipboard text detected.</span> Lines: ${lines.length}. (No processing; use drag & drop or upload to list files.)`;
    }
  } catch (err) {
    msg.innerHTML = '<span class="err">Paste failed:</span> ' + (err.message || err);
    console.error(err);
  }
});

// Drag & drop on the main card
['dragenter','dragover'].forEach(evtName => {
  mainCard.addEventListener(evtName, (e) => {
    e.preventDefault();
    e.stopPropagation();
    mainCard.classList.add('dragging');
    msg.textContent = 'Drop files here to list them.';
  });
});

['dragleave','drop'].forEach(evtName => {
  mainCard.addEventListener(evtName, (e) => {
    e.preventDefault();
    e.stopPropagation();
    mainCard.classList.remove('dragging');
  });
});

mainCard.addEventListener('drop', (e) => {
  const dt = e.dataTransfer;
  if (!dt) return;
  const files = dt.files;
  handleFileList(files);
});

// Initial message
msg.innerHTML = 'Drag and drop Excel/CSV files on this card or use ‚ÄúUpload Data Excel/CSV‚Äù. Only file names, sizes, and types will be shown.';
</script>
</body>
</html>
