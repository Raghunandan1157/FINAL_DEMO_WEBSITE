<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Raise Your Concern — Login</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background: #fff;
      font-family: system-ui, sans-serif;
      color: #111827;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .scene {
      perspective: 1000px;
    }
    .card {
      width: 320px;
      height: 280px;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.8s;
    }
    .card.flip {
      transform: rotateY(180deg);
    }
    .face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 1rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      padding: 1.5rem;
    }
    .back {
      transform: rotateY(180deg);
    }
    .welcome-btn {
      color: #6b21a8;
      font-weight: 600;
      cursor: pointer;
      transition: color 0.3s;
    }
    .welcome-btn:hover {
      color: #8b5cf6;
    }
    .otp-grid{
      display:flex;
      gap:.75rem;
      justify-content:center;
      width:100%;
    }
    .otp-input{
      width:60px;
      height:60px;
      border:1px solid #e5e7eb;
      border-radius:0.75rem;
      text-align:center;
      font-size:1.25rem;
      font-weight:600;
      text-transform:uppercase;
      transition:border-color .2s, box-shadow .2s;
    }
    .otp-input:focus{
      outline:none;
      border-color:#8b5cf6;
      box-shadow:0 0 0 2px rgba(139,92,246,0.25);
    }
    @media (max-width: 400px){
      .otp-input{ width:48px; height:56px; }
    }
  </style>
</head>
<body>
  <div class="scene">
    <div id="loginCard" class="card">
      
      <!-- FRONT: BOE -->
      <div class="face front">
        <div class="welcome-btn" id="welcomeBtn">WELCOME</div>
        <h2 class="text-xl font-semibold">Raise Your Concern</h2>
        <input id="username" value="BOE" readonly
          class="border border-gray-300 rounded px-3 py-2 w-full text-center font-medium bg-gray-50" />
        <div class="otp-grid" data-otp="boe">
          <input type="text" inputmode="text" maxlength="1" autocomplete="off"
            class="otp-input" aria-label="Branch code digit 1" />
          <input type="text" inputmode="text" maxlength="1" autocomplete="off"
            class="otp-input" aria-label="Branch code digit 2" />
          <input type="text" inputmode="text" maxlength="1" autocomplete="off"
            class="otp-input" aria-label="Branch code digit 3" />
          <input type="text" inputmode="text" maxlength="1" autocomplete="off"
            class="otp-input" aria-label="Branch code digit 4" />
        </div>
        <p id="branchCodeHint" class="text-xs text-gray-500 text-center leading-tight">
          Enter the Branch Code displayed in your profile to continue.
        </p>
        <button id="loginBtn" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition">
          Login
        </button>
        <div id="loginStatus" class="text-xs text-center text-gray-500 h-4"></div>
      </div>

      <!-- BACK: DEPT HEAD -->
      <div class="face back">
        <div class="welcome-btn" id="backBtn">WELCOME</div>
        <h2 class="text-xl font-semibold">Department Head Login</h2>
        <input id="usernameDH" value="DEPT HEAD" readonly
          class="border border-gray-300 rounded px-3 py-2 w-full text-center font-medium bg-gray-50" />
        <div class="otp-grid" data-otp="dept">
          <input type="text" inputmode="text" maxlength="1" autocomplete="off"
            class="otp-input" aria-label="Department password character 1" />
          <input type="text" inputmode="text" maxlength="1" autocomplete="off"
            class="otp-input" aria-label="Department password character 2" />
        </div>
        <button id="loginBtnDH" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 transition">
          Login
        </button>
        <div id="deptStatus" class="text-xs text-center text-gray-500 h-4"></div>
      </div>

    </div>
  </div>

  <script>
    // --- UI Elements ---
    const card = document.getElementById("loginCard");
    const welcomeBtn = document.getElementById("welcomeBtn");
    const backBtn = document.getElementById("backBtn");
    const branchCodeHint = document.getElementById("branchCodeHint");
    const loginBtn = document.getElementById("loginBtn");
    const loginStatus = document.getElementById("loginStatus");
    const deptStatus = document.getElementById("deptStatus");
    const boeInputs = Array.from(document.querySelectorAll('[data-otp="boe"] input'));
    const deptInputs = Array.from(document.querySelectorAll('[data-otp="dept"] input'));
    let loginInFlight = false;

    const STATUS_CLASSES = {
      info: "text-gray-500",
      warn: "text-amber-600",
      error: "text-red-500",
      success: "text-green-600"
    };

    const setLoginStatus = (message = "", tone = "info") => {
      if (!loginStatus) return;
      const toneClass = STATUS_CLASSES[tone] || STATUS_CLASSES.info;
      loginStatus.className = `text-xs text-center h-4 ${toneClass}`;
      loginStatus.textContent = message;
    };

    const setDeptStatus = (message = "", tone = "info") => {
      if (!deptStatus) return;
      const toneClass = STATUS_CLASSES[tone] || STATUS_CLASSES.info;
      deptStatus.className = `text-xs text-center h-4 ${toneClass}`;
      deptStatus.textContent = message;
    };

    const setLoginLoading = (isLoading) => {
      if (!loginBtn) return;
      loginBtn.disabled = isLoading;
      loginBtn.classList.toggle("opacity-70", isLoading);
      loginBtn.classList.toggle("cursor-not-allowed", isLoading);
      loginBtn.textContent = isLoading ? "Checking…" : "Login";
    };
    setLoginStatus("", "info");

    // Flip animation for WELCOME button
    welcomeBtn.onclick = () => card.classList.add("flip");
    backBtn.onclick = () => card.classList.remove("flip");

    const otpValue = (inputs) => inputs.map((input) => input.value.trim().toUpperCase()).join("");
    const resetOtp = (inputs) => inputs.forEach((input) => (input.value = ""));

    const wireOtp = (inputs) => {
      inputs.forEach((input, idx) => {
        input.addEventListener("input", (event) => {
          const sanitized = event.target.value.replace(/[^a-zA-Z0-9]/g, "").slice(-1).toUpperCase();
          event.target.value = sanitized;
          if (sanitized && idx < inputs.length - 1) {
            inputs[idx + 1].focus();
            inputs[idx + 1].select();
          }
        });
        input.addEventListener("keydown", (event) => {
          if (event.key === "Backspace" && !input.value && idx > 0) {
            inputs[idx - 1].focus();
            inputs[idx - 1].select();
          }
          if (event.key === "ArrowLeft" && idx > 0) {
            inputs[idx - 1].focus();
            inputs[idx - 1].select();
          }
          if (event.key === "ArrowRight" && idx < inputs.length - 1) {
            inputs[idx + 1].focus();
            inputs[idx + 1].select();
          }
        });
        input.addEventListener("focus", () => input.select());
      });
    };
    wireOtp(boeInputs);
    wireOtp(deptInputs);

    const getStoredPayload = () => {
      try {
        const raw = localStorage.getItem("nlpl_profile_payload");
        return raw ? JSON.parse(raw) : null;
      } catch (err) {
        console.warn("Unable to parse stored payload", err);
        return null;
      }
    };

    const getStoredBranchCode = () => {
      const payload = getStoredPayload();
      const branchCode = (payload?.profile?.["Branch Code"] || payload?.branch?.code || "")
        .toString()
        .trim()
        .toUpperCase();
      return { branchCode, payload };
    };

    const hydrateBranchCodeHint = () => {
      if (!branchCodeHint) return;
      const fallbackText = "Enter the Branch Code displayed in your profile to continue.";
      branchCodeHint.textContent = fallbackText;
      const { branchCode } = getStoredBranchCode();
      if (branchCode) {
        branchCodeHint.textContent = `Use Branch Code ${branchCode} exactly as shown in profile.html`;
      }
    };
    hydrateBranchCodeHint();

    const focusFirstOtp = (inputs) => inputs[0]?.focus();
    focusFirstOtp(boeInputs);

    // --- BOE Login ---
    loginBtn.onclick = () => {
      if (loginInFlight) return;
      const enteredCode = otpValue(boeInputs);
      if (enteredCode.length !== boeInputs.length) {
        setLoginStatus("Enter all four characters of your Branch Code.", "warn");
        focusFirstOtp(boeInputs);
        return;
      }

      const { branchCode } = getStoredBranchCode();
      if (!branchCode) {
        setLoginStatus("No profile data found. Open profile.html first.", "error");
        return;
      }
      if (enteredCode !== branchCode) {
        setLoginStatus("Branch Code mismatch. Match the code shown in profile.html.", "warn");
        resetOtp(boeInputs);
        focusFirstOtp(boeInputs);
        return;
      }

      loginInFlight = true;
      setLoginLoading(true);
      setLoginStatus("Access granted. Redirecting…", "success");

      setTimeout(() => {
        window.location.href = "Branch Ticket Desk.html?branch=" + encodeURIComponent(branchCode);
      }, 400);
    };

    window.addEventListener("pagehide", () => {
      loginInFlight = false;
      setLoginLoading(false);
    });

    // --- DEPT HEAD Login ---
    document.getElementById("loginBtnDH").onclick = () => {
      const enteredCode = otpValue(deptInputs);
      if (enteredCode.length !== deptInputs.length) {
        setDeptStatus("Enter both characters of the CO code.", "warn");
        focusFirstOtp(deptInputs);
        return;
      }
      if (enteredCode !== "CO") {
        setDeptStatus("Invalid code. Use CO.", "error");
        resetOtp(deptInputs);
        focusFirstOtp(deptInputs);
        return;
      }
      setDeptStatus("Welcome, Department Head.", "success");
      setTimeout(() => {
        window.location.href = "Department Head Console.html";
      }, 300);
    };
  </script>
</body>
</html>
