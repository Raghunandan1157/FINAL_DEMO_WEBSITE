<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Raise Your Concern — Access Gateway</title>

  <!-- Tailwind CSS (utility only, keeps parity with other screens) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --ink:#0f172a;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#7c3aed;
      --accent-2:#a855f7;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto;
      color:var(--ink);
      background:var(--bg);
    }
    .screen{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:clamp(1.5rem,5vw,3rem);
      background:
        radial-gradient(circle at 20% 20%,rgba(124,58,237,.15),transparent 55%),
        radial-gradient(circle at 80% 0%,rgba(15,118,210,.14),transparent 60%),
        var(--bg);
    }
    .card{
      width:min(460px,100%);
      background:#fff;
      border:1px solid var(--line);
      border-radius:1.5rem;
      padding:2.25rem;
      box-shadow:0 25px 60px rgba(15,23,42,.12);
      display:flex;
      flex-direction:column;
      gap:1.25rem;
    }
    .eyebrow{
      text-transform:uppercase;
      font-size:.78rem;
      letter-spacing:.2em;
      color:var(--muted);
    }
    h1{
      font-size:1.8rem;
      margin:0;
      font-weight:700;
      letter-spacing:-.02em;
    }
    p{
      margin:0;
      color:var(--muted);
      line-height:1.5;
    }
    .otp-grid{
      display:flex;
      gap:.75rem;
      justify-content:center;
      width:100%;
    }
    .otp-input{
      width:64px;
      height:64px;
      border:1px solid var(--line);
      border-radius:0.85rem;
      text-align:center;
      font-size:1.35rem;
      font-weight:600;
      text-transform:uppercase;
      transition:border-color .2s, box-shadow .2s;
    }
    .otp-input:focus{
      outline:none;
      border-color:#c4b5fd;
      box-shadow:0 0 0 3px rgba(124,58,237,.25);
    }
    .cta{
      width:100%;
      padding:0.95rem 1rem;
      border:none;
      border-radius:999px;
      font-weight:600;
      font-size:1rem;
      cursor:pointer;
      color:#fff;
      background:linear-gradient(120deg,var(--accent),var(--accent-2));
      box-shadow:0 15px 35px rgba(124,58,237,.35);
      transition:opacity .2s,transform .1s;
    }
    .cta:disabled{
      opacity:.6;
      cursor:not-allowed;
      box-shadow:none;
    }
    .cta.ghost{
      background:#f8fafc;
      color:var(--ink);
      border:1px solid var(--line);
      box-shadow:none;
    }
    .status{
      min-height:1.25rem;
      font-size:.85rem;
      text-align:center;
    }
    .status.warn{color:#b45309}
    .status.error{color:#dc2626}
    .status.success{color:#15803d}
    .profile-card{
      display:flex;
      gap:1rem;
      align-items:center;
      padding:1rem;
      border:1px dashed var(--line);
      border-radius:1.25rem;
      background:#f8fafc;
    }
    .avatar{
      width:56px;
      height:56px;
      border-radius:999px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      display:grid;
      place-items:center;
      font-weight:700;
      color:#fff;
      font-size:1.2rem;
    }
    .meta{
      font-size:.9rem;
      color:var(--muted);
    }
    .hidden{display:none !important;}
    @media(max-width:540px){
      .card{padding:1.75rem;border-radius:1.25rem;}
      .otp-input{width:56px;height:56px;}
      .screen{padding:1.5rem;}
    }
  </style>
</head>
<body>
  <main class="screen">
    <!-- Error / missing session -->
    <section id="stateError" class="card hidden">
      <div class="eyebrow">Session required</div>
      <h1 id="errorTitle">Sign in again</h1>
      <p id="errorText">We couldn't find your NLPL workspace data. Please sign in from the main portal and return to this screen.</p>
      <a class="cta ghost" href="../nlpl.html">Back to login</a>
    </section>

    <!-- Branch verification -->
    <section id="stateBranch" class="card hidden">
      <div class="eyebrow">Branch ticket desk</div>
      <h1>Verify your Branch ID</h1>
      <p id="branchHint">Enter the Branch ID shown in your profile to continue.</p>
      <div class="otp-grid" data-otp="branch">
        <input type="text" inputmode="text" maxlength="1" autocomplete="off" class="otp-input" aria-label="Branch code digit 1" />
        <input type="text" inputmode="text" maxlength="1" autocomplete="off" class="otp-input" aria-label="Branch code digit 2" />
        <input type="text" inputmode="text" maxlength="1" autocomplete="off" class="otp-input" aria-label="Branch code digit 3" />
        <input type="text" inputmode="text" maxlength="1" autocomplete="off" class="otp-input" aria-label="Branch code digit 4" />
      </div>
      <div class="status" id="branchStatus"></div>
      <button id="branchBtn" class="cta">Continue to Branch Ticket Desk</button>
    </section>

    <!-- Department head handoff -->
    <section id="stateDept" class="card hidden">
      <div class="eyebrow">Department head</div>
      <h1>Workspace access granted</h1>
      <p>You're signed in via the corporate backend. Review your profile below and continue to the Department Head Console.</p>
      <div class="profile-card">
        <div class="avatar" id="deptAvatar">DH</div>
        <div>
          <div class="text-lg font-semibold" id="deptName">—</div>
          <div class="meta" id="deptRole">—</div>
          <div class="meta">Employee ID <span class="font-semibold text-indigo-600" id="deptEmpId">—</span></div>
        </div>
      </div>
      <div class="meta">Workspace: <span class="font-semibold text-slate-900" id="deptWorkspace">—</span></div>
      <div class="status success" id="deptStatus">Authenticated via Employee ID.</div>
      <button id="deptContinue" class="cta">Open Department Head Console</button>
    </section>
  </main>

  <script>
    (function(){
      const branchCard = document.getElementById("stateBranch");
      const deptCard = document.getElementById("stateDept");
      const errorCard = document.getElementById("stateError");
      const branchStatus = document.getElementById("branchStatus");
      const branchHint = document.getElementById("branchHint");
      const branchBtn = document.getElementById("branchBtn");
      const branchInputs = Array.from(document.querySelectorAll('[data-otp="branch"] input'));
      const deptContinue = document.getElementById("deptContinue");
      const deptName = document.getElementById("deptName");
      const deptRole = document.getElementById("deptRole");
      const deptEmpId = document.getElementById("deptEmpId");
      const deptWorkspace = document.getElementById("deptWorkspace");
      const deptAvatar = document.getElementById("deptAvatar");
      const deptStatus = document.getElementById("deptStatus");
      const errorTitle = document.getElementById("errorTitle");
      const errorText = document.getElementById("errorText");
      let branchInFlight = false;

      const STATUS_CLASSES = {
        info: "status",
        warn: "status warn",
        error: "status error",
        success: "status success"
      };

      function toggle(card){
        [branchCard, deptCard, errorCard].forEach(el=>{
          if(!el) return;
          el.classList.toggle("hidden", el !== card);
        });
      }
      function showErrorView(title, message){
        if(errorTitle && title) errorTitle.textContent = title;
        if(errorText && message) errorText.textContent = message;
        toggle(errorCard);
      }

      function setBranchStatus(message = "", tone = "info"){
        if(!branchStatus) return;
        branchStatus.className = STATUS_CLASSES[tone] || STATUS_CLASSES.info;
        branchStatus.textContent = message;
      }

      function setBranchLoading(isLoading){
        if(!branchBtn) return;
        branchBtn.disabled = isLoading;
        branchBtn.textContent = isLoading ? "Checking…" : "Continue to Branch Ticket Desk";
      }

      function setDeptDetails(payload){
        const name = (payload?.name || payload?.profile?.["Name"] || "Department Head").trim();
        const role = (payload?.role || payload?.profile?.["Designation"] || "Department Head").trim();
        const emp = (payload?.empId || payload?.profile?.["Employee ID"] || "—").trim();
        const workspace = (payload?.branch?.name || payload?.profile?.["Branch Name"] || "Corporate Office").trim();
        deptName.textContent = name || "Department Head";
        deptRole.textContent = role || "Department Head";
        deptEmpId.textContent = emp || "—";
        deptWorkspace.textContent = workspace || "Corporate Office";
        if(deptStatus){
          deptStatus.textContent = `Signed in as ${name || "Department Head"}.`;
        }
        const initials = name ? initialsFrom(name) : (emp ? initialsFrom(emp) : "DH");
        deptAvatar.textContent = initials || "DH";
      }

      function initialsFrom(str){
        return (str || "")
          .split(/\s+/)
          .filter(Boolean)
          .slice(0,2)
          .map(part => part[0]?.toUpperCase() || "")
          .join("") || "DH";
      }

      function otpValue(inputs){
        return inputs.map(input => input.value.trim().toUpperCase()).join("");
      }

      function resetOtp(inputs){
        inputs.forEach(input => input.value = "");
      }

      function focusFirstOtp(inputs){
        if(inputs[0]) inputs[0].focus();
      }

      function wireOtp(inputs){
        inputs.forEach((input, idx) => {
          input.addEventListener("input", event => {
            const sanitized = event.target.value.replace(/[^a-zA-Z0-9]/g, "").slice(-1).toUpperCase();
            event.target.value = sanitized;
            if(sanitized && idx < inputs.length - 1){
              inputs[idx + 1].focus();
              inputs[idx + 1].select();
            }
          });
          input.addEventListener("keydown", event => {
            if(event.key === "Backspace" && !input.value && idx > 0){
              inputs[idx - 1].focus();
              inputs[idx - 1].select();
            }
            if(event.key === "ArrowLeft" && idx > 0){
              inputs[idx - 1].focus();
              inputs[idx - 1].select();
            }
            if(event.key === "ArrowRight" && idx < inputs.length - 1){
              inputs[idx + 1].focus();
              inputs[idx + 1].select();
            }
          });
          input.addEventListener("focus", () => input.select());
        });
      }
      wireOtp(branchInputs);

      function getStoredPayload(){
        try{
          const raw = localStorage.getItem("nlpl_profile_payload");
          return raw ? JSON.parse(raw) : null;
        }catch(err){
          console.warn("Unable to parse stored payload", err);
          return null;
        }
      }

      function getStoredBranchCode(payload){
        const raw = payload?.profile?.["Branch Code"] || payload?.branch?.code || "";
        return raw.toString().trim().toUpperCase();
      }

      const payload = getStoredPayload();
      if(!payload){
        showErrorView("Sign in again","We couldn't find your NLPL workspace data. Please sign in from the main portal and return to this screen.");
        return;
      }
      const isDeptHead = Boolean(payload?.access?.deptHead);
      const allowEmailRoutes = payload?.access?.emailLogin !== false || isDeptHead;
      if(!allowEmailRoutes){
        showErrorView("Email login required","This desk is available only when you sign in using your NLPL email ID.");
        return;
      }

      if(isDeptHead){
        setDeptDetails(payload);
        toggle(deptCard);
        deptContinue?.addEventListener("click", ()=>{
          window.location.href = "Department Head Console.html";
        });
        return;
      }

      toggle(branchCard);
      const branchCode = getStoredBranchCode(payload);
      if(branchHint){
        branchHint.textContent = branchCode
          ? `Type Branch ID ${branchCode} exactly as it appears in your profile.`
          : "Branch ID missing. Open profile.html first so we can fetch it.";
      }
      if(!branchCode){
        setBranchStatus("No branch data found. Open profile.html first.", "error");
        branchBtn.disabled = true;
      }

      focusFirstOtp(branchInputs);
      branchBtn?.addEventListener("click", ()=>{
        if(branchInFlight || branchBtn.disabled) return;
        const entered = otpValue(branchInputs);
        if(entered.length !== branchInputs.length){
          setBranchStatus("Enter all characters of your Branch ID.", "warn");
          focusFirstOtp(branchInputs);
          return;
        }
        if(!branchCode){
          setBranchStatus("Branch data unavailable.", "error");
          return;
        }
        if(entered !== branchCode){
          setBranchStatus("Branch ID mismatch. Match the code shown in your profile.", "warn");
          resetOtp(branchInputs);
          focusFirstOtp(branchInputs);
          return;
        }
        branchInFlight = true;
        setBranchLoading(true);
        setBranchStatus("Access granted. Redirecting…", "success");
        setTimeout(()=>{
          window.location.href = "Branch Ticket Desk.html?branch=" + encodeURIComponent(branchCode);
        }, 350);
      });

      window.addEventListener("pagehide", ()=>{
        branchInFlight = false;
        setBranchLoading(false);
      });
    })();
  </script>
</body>
</html>
