<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Corporate Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    :root{
      --brand:#0a84ff; --ink:#0e1a2b; --muted:#6a7485;
      --bg:#f5f7fb; --card:#ffffff; --line:#e6e9f0;
    }
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px rgba(2,14,36,.06)}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
    .mini{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:.75rem .9rem}
    .pill{display:inline-flex;align-items:center;gap:.5rem;border:1px dashed var(--line);border-radius:999px;padding:.5rem .9rem;background:#fff}
    .overlay{position:fixed;inset:0;background:rgba(2,14,36,.55);backdrop-filter:blur(6px);display:none;z-index:50}
    .sheet{background:#fff;max-width:960px;margin:5vh auto;border-radius:20px;border:1px solid var(--line);box-shadow:0 30px 60px rgba(2,14,36,.2)}
  </style>
  <style>
    @media (max-width: 640px){
      header{flex-direction:column;align-items:flex-start;gap:.75rem;}
      .kpi{grid-template-columns:1fr;}
      .mini{padding:.65rem .8rem;}
      main{padding-inline:1rem;}
    }
  </style>
</head>
<body>

  <main class="max-w-6xl mx-auto p-6 md:p-10 space-y-8">
    <!-- Title -->
    <header class="flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Corporate Profile</h1>

      <!-- Extract Template button -->
      <button type="button" id="extract-template"
              class="px-4 py-2 rounded-md text-white bg-[var(--brand)] shadow hover:opacity-95"
              aria-label="Extract Template">
        Extract Template
      </button>
    </header>

    <!-- Settings -->
    <section class="card p-6 flex flex-wrap gap-4 items-end">
      <div class="flex flex-col gap-1 min-w-[150px]">
        <label for="profile-year" class="text-xs font-semibold text-[var(--muted)] uppercase tracking-wide">Year</label>
        <select id="profile-year" class="border border-[var(--line)] rounded-md px-3 py-2 bg-white text-sm">
          <option value="">All</option>
        </select>
      </div>
      <div class="flex flex-col gap-1 min-w-[150px]">
        <label for="profile-month" class="text-xs font-semibold text-[var(--muted)] uppercase tracking-wide">Month</label>
        <select id="profile-month" class="border border-[var(--line)] rounded-md px-3 py-2 bg-white text-sm">
          <option value="">All</option>
        </select>
      </div>
      <div class="flex flex-col gap-1 min-w-[200px]">
        <label for="profile-metric" class="text-xs font-semibold text-[var(--muted)] uppercase tracking-wide">Parameter</label>
        <select id="profile-metric" class="border border-[var(--line)] rounded-md px-3 py-2 bg-white text-sm"></select>
      </div>
      <div class="text-xs text-[var(--muted)] ml-auto" id="profile-status">Loading dataset…</div>
    </section>

    <!-- BOE Spotlight -->
    <section class="card p-6">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="text-xs font-semibold text-[var(--muted)] uppercase tracking-wide">Branch Ops Executive</p>
          <p class="text-2xl md:text-3xl font-semibold mt-1" id="boe-name">—</p>
          <p class="text-sm text-[var(--muted)] mt-1">Branch Code <span class="font-medium" id="boe-code">—</span></p>
        </div>
        <div class="text-left md:text-right">
          <p class="text-xs text-[var(--muted)]">Designation</p>
          <p class="text-xl font-semibold" id="boe-designation">—</p>
          <p class="text-xs text-[var(--muted)] mt-3">Branch Email</p>
          <p class="font-medium break-all" id="boe-email">—</p>
        </div>
      </div>
      <div class="mt-4 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">District</div>
          <div class="mt-1 font-medium" id="boe-district">—</div>
        </div>
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Region</div>
          <div class="mt-1 font-medium" id="boe-region">—</div>
        </div>
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">State</div>
          <div class="mt-1 font-medium" id="boe-state">—</div>
        </div>
      </div>
    </section>

    <!-- Achievement (2 fields only) -->
    <section class="card p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Achievement</h2>
        <span class="text-xs text-[var(--muted)]">Highlight standout results</span>
      </div>
      <div class="mt-4 grid sm:grid-cols-2 gap-4">
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Disbursement</div>
          <div class="mt-1 font-medium" id="ach-disbursement">—</div>
        </div>
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Collection</div>
          <div class="mt-1 font-medium" id="ach-collection">—</div>
        </div>
      </div>
    </section>

    <!-- Identity Box -->
    <section class="card p-6">
      <h2 class="text-lg font-semibold">Identity</h2>
      <div class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Name</div>
          <div class="mt-1 font-medium" id="field-name">—</div>
        </div>
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Employee ID</div>
          <div class="mt-1 font-medium" id="field-emp">—</div>
        </div>
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Designation</div>
          <div class="mt-1 font-medium" id="field-designation">—</div>
        </div>
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Level</div>
          <div class="mt-1 font-medium" id="field-level">—</div>
        </div>
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Branch Name</div>
          <div class="mt-1 font-medium" id="field-branch-name">—</div>
        </div>
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Branch Code</div>
          <div class="mt-1 font-medium" id="field-branch-code">—</div>
        </div>
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Branch Email ID</div>
          <div class="mt-1 font-medium" id="field-branch-email">—</div>
        </div>
      </div>
    </section>

    <!-- Personal Stats -->
    <section class="grid md:grid-cols-3 gap-6">
      <div class="card p-6">
        <h3 class="text-sm font-semibold">Days in Company</h3>
        <div class="mt-3 text-2xl font-bold" id="field-days">—</div>
      </div>
      <div class="card p-6">
        <h3 class="text-sm font-semibold">Birthdate</h3>
        <div class="mt-3 text-2xl font-bold" id="field-birthdate">—</div>
      </div>
      <div class="card p-6">
        <h3 class="text-sm font-semibold">Wedding Anniversary</h3>
        <div class="mt-3 text-2xl font-bold" id="field-anniversary">—</div>
      </div>
    </section>

    <!-- Key Operations -->
    <section class="space-y-4">
      <h2 class="text-lg font-semibold">Key Operations</h2>
      <div class="grid md:grid-cols-2 xl:grid-cols-4 gap-6">
        <!-- Disbursement -->
        <button id="btn-disb" class="card p-5 text-left hover:shadow-lg transition open-panel" data-target="#panel-disb">
          <div class="text-sm text-[var(--muted)]">Disbursement</div>
          <div class="kpi mt-3">
            <div class="mini">
              <div class="text-xs text-[var(--muted)]">Accounts</div>
              <div class="mt-1 font-semibold" id="disb-accounts">—</div>
            </div>
            <div class="mini">
              <div class="text-xs text-[var(--muted)]">Amount</div>
              <div class="mt-1 font-semibold" id="disb-amount">—</div>
            </div>
          </div>
        </button>

        <!-- Regular Collection -->
        <button id="btn-reg" class="card p-5 text-left hover:shadow-lg transition open-panel" data-target="#panel-reg"
                data-percent="">
          <div class="text-sm text-[var(--muted)]">Regular Collection</div>
          <div class="kpi mt-3">
            <div class="mini">
              <div class="text-xs text-[var(--muted)]">Accounts</div>
              <div class="mt-1 font-semibold" id="reg-accounts">—</div>
            </div>
            <div class="mini">
              <div class="text-xs text-[var(--muted)]">% Collected</div>
              <div class="mt-1 font-semibold" id="reg-pct">—</div>
            </div>
          </div>
        </button>

        <!-- NPA Collection -->
        <button id="btn-npa" class="card p-5 text-left hover:shadow-lg transition open-panel" data-target="#panel-npa"
                data-percent="">
          <div class="text-sm text-[var(--muted)]">NPA Collection</div>
          <div class="kpi mt-3">
            <div class="mini">
              <div class="text-xs text-[var(--muted)]">Accounts</div>
              <div class="mt-1 font-semibold" id="npa-accounts">—</div>
            </div>
            <div class="mini">
              <div class="text-xs text-[var(--muted)]">% Collected</div>
              <div class="mt-1 font-semibold" id="npa-pct">—</div>
            </div>
          </div>
        </button>

        <!-- FTOD Collection -->
        <button id="btn-ftod" class="card p-5 text-left hover:shadow-lg transition open-panel" data-target="#panel-ftod"
                data-percent="">
          <div class="text-sm text-[var(--muted)]">FTOD Collection</div>
          <div class="kpi mt-3">
            <div class="mini">
              <div class="text-xs text-[var(--muted)]">Accounts</div>
              <div class="mt-1 font-semibold" id="ftod-accounts">—</div>
            </div>
            <div class="mini">
              <div class="text-xs text-[var(--muted)]">% Collected</div>
              <div class="mt-1 font-semibold" id="ftod-pct">—</div>
            </div>
          </div>
        </button>
      </div>
    </section>

    <!-- Productivity -->
    <section class="card p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Productivity</h2>
        <span class="text-xs text-[var(--muted)]">Auto-calculates when percentages are provided</span>
      </div>
      <div class="mt-3 text-3xl font-bold" id="productivity">—</div>
    </section>

    <!-- Performance Table (placeholder exactly as requested) -->
    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4">Performance (Placeholder)</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm border border-[var(--line)] rounded-lg overflow-hidden">
          <thead class="bg-gray-50">
            <tr>
              <th class="text-left p-3 border-b border-[var(--line)]">Column 1</th>
              <th class="text-left p-3 border-b border-[var(--line)]">Column 2</th>
            </tr>
          </thead>
          <tbody>
            <tr class="odd:bg-white even:bg-gray-50">
              <td class="p-3 border-b border-[var(--line)]">Row 1</td>
              <td class="p-3 border-b border-[var(--line)]">Row 1</td>
            </tr>
            <tr class="odd:bg-white even:bg-gray-50">
              <td class="p-3">Row 2</td>
              <td class="p-3">Row 2</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Data Snapshot -->
    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4">Data Snapshot</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm border border-[var(--line)] rounded-lg overflow-hidden" id="profile-data-table">
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Overlays -->
  <div id="panel-disb" class="overlay" aria-hidden="true">
    <div class="sheet mx-4 p-6 md:p-8">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">Disbursement — Pipeline</h3>
        <button class="px-3 py-2 text-sm rounded-md bg-gray-100 hover:bg-gray-200 close-panel">Close</button>
      </div>
      <div class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <span class="pill">Sanction Pending</span>
        <span class="pill">KYC Pending</span>
        <span class="pill">QC Review</span>
        <span class="pill">Disbursement Pending</span>
        <span class="pill">Booked</span>
      </div>
    </div>
  </div>

  <div id="panel-reg" class="overlay" aria-hidden="true">
    <div class="sheet mx-4 p-6 md:p-8">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">Regular Collection — Breakdown</h3>
        <button class="px-3 py-2 text-sm rounded-md bg-gray-100 hover:bg-gray-200 close-panel">Close</button>
      </div>
      <div class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <span class="pill">Due Today</span>
        <span class="pill">Collected</span>
        <span class="pill">Overdue</span>
        <span class="pill">Roll-forward</span>
        <span class="pill">Exceptions</span>
      </div>
    </div>
  </div>

  <div id="panel-npa" class="overlay" aria-hidden="true">
    <div class="sheet mx-4 p-6 md:p-8">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">NPA Collection — Status</h3>
        <button class="px-3 py-2 text-sm rounded-md bg-gray-100 hover:bg-gray-200 close-panel">Close</button>
      </div>
      <div class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <span class="pill">90+ Bucket</span>
        <span class="pill">Follow-ups</span>
        <span class="pill">Promises to Pay</span>
        <span class="pill">Recoveries</span>
        <span class="pill">Settlements</span>
      </div>
    </div>
  </div>

  <div id="panel-ftod" class="overlay" aria-hidden="true">
    <div class="sheet mx-4 p-6 md:p-8">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">FTOD Collection — Status</h3>
        <button class="px-3 py-2 text-sm rounded-md bg-gray-100 hover:bg-gray-200 close-panel">Close</button>
      </div>
      <div class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <span class="pill">FTOD Cases</span>
        <span class="pill">Recovered</span>
        <span class="pill">Pending</span>
        <span class="pill">Escalations</span>
        <span class="pill">Exceptions</span>
      </div>
    </div>
  </div>

  <script>
    // Open/close panels
    document.querySelectorAll('.open-panel').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.target;
        const el = document.querySelector(id);
        if(el){ el.style.display = 'block'; el.setAttribute('aria-hidden','false'); }
      });
    });
    document.querySelectorAll('.close-panel').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const overlay = btn.closest('.overlay');
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden','true');
      });
    });
    document.querySelectorAll('.overlay').forEach(ov=>{
      ov.addEventListener('click', (e)=>{ if(e.target === ov){ ov.style.display='none'; ov.setAttribute('aria-hidden','true'); } });
    });
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){ document.querySelectorAll('.overlay').forEach(o=>{o.style.display='none'; o.setAttribute('aria-hidden','true');}); }
    });

    // Productivity: simple average of available percentages (placeholder logic).
    function asNum(v){ const n = parseFloat(v); return isNaN(n)?null:n; }
    function computeProductivity(){
      const reg = asNum(document.getElementById('btn-reg').dataset.percent);
      const npa = asNum(document.getElementById('btn-npa').dataset.percent);
      const ftod = asNum(document.getElementById('btn-ftod').dataset.percent);
      const arr = [reg,npa,ftod].filter(v=>v!==null);
      const out = document.getElementById('productivity');
      if(arr.length===0){ out.textContent='—'; return; }
      const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
      out.textContent = avg.toFixed(2) + ' %';
    }
    computeProductivity();

    // ------- Extract Template (CSV) -------
    const TEMPLATE_HEADERS = [
      "Sl. no.",
      "year",
      "month",
      "Name",
      "Employee ID",
      "Designation",
      "Branch Name",
      "Branch Code",
      "Branch Email ID",
      "Days in Company",
      "Birthdate (YYYY-MM-DD)",
      "Wedding Anniversary (YYYY-MM-DD)",
      "Disbursement - Accounts",
      "Disbursement - Amount",
      "Disbursement - Sanction Pending",
      "Disbursement - KYC Pending",
      "Disbursement - QC Review",
      "Disbursement - Disbursement Pending",
      "Disbursement - Booked",
      "Regular Collection - Accounts",
      "Regular Collection - % Collected",
      "Regular Collection - Due Today",
      "Regular Collection - Collected",
      "Regular Collection - Overdue",
      "Regular Collection - Roll-forward",
      "Regular Collection - Exceptions",
      "NPA Collection - Accounts",
      "NPA Collection - % Collected",
      "NPA Collection - 90+ Bucket",
      "NPA Collection - Follow-ups",
      "NPA Collection - Promises to Pay",
      "NPA Collection - Recoveries",
      "NPA Collection - Settlements",
      "FTOD Collection - Accounts",
      "FTOD Collection - % Collected",
      "FTOD Collection - FTOD Cases",
      "FTOD Collection - Recovered",
      "FTOD Collection - Pending",
      "FTOD Collection - Escalations",
      "FTOD Collection - Exceptions",
      "Performance - Column 1",
      "Performance - Column 2"
    ];

    function toCsvRow(arr){
      // CSV quoting: wrap in " and escape inner " as ""
      return arr.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',');
    }

    document.getElementById('extract-template').addEventListener('click', () => {
      const header = toCsvRow(TEMPLATE_HEADERS);
      const csv = header + '\r\n'; // header row only, template style
      // Prepend BOM so Excel opens UTF-8 correctly
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "Corporate_Profile_Template.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
    // -------------------------------------
  </script>
  <script>
    (function(){
      const SUPABASE_URL = "https://zovnmmdfthpbubrorsgh.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvdm5tbWRmdGhwYnVicm9yc2doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NzE3ODgsImV4cCI6MjA3NzE0Nzc4OH0.92BH2sjUOgkw6iSRj1_4gt0p3eThg3QT4VK-Q4EdmBE";
      const TABLE_NAME = "database";
      const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      const DATA_COLS = {
        sl_no: ["Sl.no","Sl. no","sl_no"],
        year: ["Year","year"],
        month: ["Month","month"],
        name: ["Name","Employee Name"],
        employee_id: ["Employee ID","Emp ID"],
        designation: ["Designation"],
        level: ["Level"],
        state: ["State"],
        branch_code: ["Branch Code"],
        branch_name: ["Branch Name"],
        branch_email: ["Branch Email ID","Branch email"],
        district: ["District"],
        region: ["Region"],
        disbursement_account: ["Disbursement - Account","Disbursement – Account","Disbursement - Accounts"],
        disbursement_amount: ["Disbursement - Amount","Disbursement – Amount"],
        active_accounts: ["Active Accounts"],
        total_portfolio_amount: ["Total Portfolio – Amount"],
        regular_portfolio_account: ["Regular Portfolio – Account"],
        regular_portfolio_amount: ["Regular Portfolio – Amount"],
        par1_plus_account: ["1+ PAR – Account"],
        par1_plus_amount: ["1+ PAR – Amount"],
        npa_account: ["NPA – Account"],
        npa_amount: ["NPA – Amount"],
        ftod_account: ["FTOD – Account"],
        ftod_amount: ["FTOD – Amount"],
        audit_rating: ["Audit Rating"],
        regular_demand_pct: ["Regular Demand vs Collection %","Regular Collection - % Collected"],
        npa_percent: ["NPA Collection - % Collected","NPA %"],
        ftod_percent: ["FTOD Collection - % Collected","FTOD %"],
        days_in_company: ["Days in Company"],
        birthdate: ["Birthdate","Birthdate (YYYY-MM-DD)","Birthday"],
        wedding_anniversary: ["Wedding Anniversary","Wedding Anniversary (YYYY-MM-DD)","Wedding anniversary"],
        work_anniversary: ["Work Anniversary","Date of Joining","Work Anniversary (YYYY-MM-DD)"]
      };

      const SNAPSHOT_FIELDS = [
        { key:'sl_no', label:'Sl. No.' },
        { key:'year', label:'Year' },
        { key:'month', label:'Month' },
        { key:'name', label:'Name' },
        { key:'employee_id', label:'Employee ID' },
        { key:'designation', label:'Designation' },
        { key:'level', label:'Level' },
        { key:'state', label:'State' },
        { key:'branch_code', label:'Branch Code' },
        { key:'branch_name', label:'Branch Name' },
        { key:'district', label:'District' },
        { key:'region', label:'Region' },
        { key:'disbursement_account', label:'Disbursement Accounts' },
        { key:'disbursement_amount', label:'Disbursement Amount' },
        { key:'active_accounts', label:'Active Accounts' },
        { key:'total_portfolio_amount', label:'Total Portfolio Amount' },
        { key:'regular_portfolio_account', label:'Regular Portfolio Accounts' },
        { key:'regular_portfolio_amount', label:'Regular Portfolio Amount' },
        { key:'par1_plus_account', label:'1+ PAR Accounts' },
        { key:'par1_plus_amount', label:'1+ PAR Amount' },
        { key:'npa_account', label:'NPA Accounts' },
        { key:'npa_amount', label:'NPA Amount' },
        { key:'ftod_account', label:'FTOD Accounts' },
        { key:'ftod_amount', label:'FTOD Amount' },
        { key:'audit_rating', label:'Audit Rating' }
      ];

      const METRIC_OPTIONS = [
        { key:'disbursement_amount', label:'Disbursement Amount' },
        { key:'disbursement_account', label:'Disbursement Accounts' },
        { key:'regular_portfolio_amount', label:'Regular Portfolio Amount' },
        { key:'regular_portfolio_account', label:'Regular Portfolio Accounts' },
        { key:'npa_amount', label:'NPA Amount' },
        { key:'ftod_amount', label:'FTOD Amount' },
        { key:'regular_demand_pct', label:'Regular Demand vs Collection %' }
      ];

      const MONTH_ORDER = ["January","February","March","April","May","June","July","August","September","October","November","December"];

      const selectors = {
        yearSelect: document.getElementById('profile-year'),
        monthSelect: document.getElementById('profile-month'),
        metricSelect: document.getElementById('profile-metric'),
        status: document.getElementById('profile-status'),
        snapshotBody: document.querySelector('#profile-data-table tbody')
      };

      METRIC_OPTIONS.forEach(opt=>{
        const option = document.createElement('option');
        option.value = opt.key;
        option.textContent = opt.label;
        selectors.metricSelect.appendChild(option);
      });

      const loginPayload = (() => {
        const raw = localStorage.getItem('nlpl_profile_payload');
        if (!raw) return null;
        try { return JSON.parse(raw); } catch { return null; }
      })();

      const fallbackRow = buildFallbackRow(loginPayload);
      const defaultBranchCodeRaw = (fallbackRow?.branch_code || '').toString().trim();
      const defaultBranchCode = defaultBranchCodeRaw.toLowerCase();
      const storedEmployeeIdRaw = (loginPayload?.empId || fallbackRow?.employee_id || localStorage.getItem('nlpl_employee_id') || '').toString().trim();
      const focusEmployeeId = sanitizeId(storedEmployeeIdRaw);

      let rows = [];
      const state = { year:'', month:'', metric: METRIC_OPTIONS[0].key };

      selectors.metricSelect.value = state.metric;

      fetchData();

      selectors.yearSelect.addEventListener('change', e => {
        state.year = e.target.value;
        render();
      });
      selectors.monthSelect.addEventListener('change', e => {
        state.month = e.target.value;
        render();
      });
      selectors.metricSelect.addEventListener('change', e => {
        state.metric = e.target.value;
        render();
      });

      function fetchData(){
        selectors.status.textContent = 'Fetching data…';
        let query = sb.from(TABLE_NAME).select('*').limit(1500);
        if (storedEmployeeIdRaw){
          query = query.ilike('employee_id', storedEmployeeIdRaw);
        } else if (defaultBranchCodeRaw){
          query = query.ilike('branch_code', defaultBranchCodeRaw);
        }
        query.then(({ data, error })=>{
          if (error) throw error;
          rows = Array.isArray(data) ? data : [];
          populateFilters();
          render();
          selectors.status.textContent = `Loaded ${rows.length} rows`;
        }).catch(err=>{
          console.warn('Profile dataset error', err);
          selectors.status.textContent = 'Unable to load dataset, using cached values.';
          renderProfile(fallbackRow);
          renderSnapshot(fallbackRow);
        });
      }

      function populateFilters(){
        const years = Array.from(new Set(rows.map(r => (canonicalValue(r,'year') || '').toString().trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
        selectors.yearSelect.innerHTML = '<option value="">All</option>' + years.map(y=>`<option value="${y}">${y}</option>`).join('');
        selectors.yearSelect.value = state.year;
        const months = Array.from(new Set(rows.map(r => (canonicalValue(r,'month') || '').toString().trim()).filter(Boolean)))
          .sort((a,b)=>MONTH_ORDER.indexOf(a) - MONTH_ORDER.indexOf(b));
        selectors.monthSelect.innerHTML = '<option value="">All</option>' + months.map(m=>`<option value="${m}">${m}</option>`).join('');
        selectors.monthSelect.value = state.month;
      }

      function canonicalValue(row, key){
        if (!row) return null;
        if (row[key] !== undefined && row[key] !== null && row[key] !== '') return row[key];
        const aliases = DATA_COLS[key] || [];
        for (const alias of aliases){
          if (row[alias] !== undefined && row[alias] !== null && row[alias] !== '') return row[alias];
        }
        return null;
      }

      function numericValue(row, key){
        const raw = canonicalValue(row, key);
        if (raw === null || raw === undefined || raw === '') return NaN;
        const cleaned = String(raw).replace(/,/g,'').replace(/%/g,'');
        const num = Number(cleaned);
        return Number.isFinite(num) ? num : NaN;
      }

      function percentValue(row, key){
        const raw = canonicalValue(row, key);
        if (raw === null || raw === undefined || raw === '') return '—';
        const num = parseFloat(String(raw).replace(/%/g,''));
        if (!Number.isFinite(num)) return '—';
        const value = num <= 1 ? num * 100 : num;
        return value.toFixed(2).replace(/\.00$/,'') + '%';
      }

      function formatDisplay(value){
        if (value === null || value === undefined || value === '') return '—';
        if (typeof value === 'number') return Number.isFinite(value) ? value.toLocaleString() : '—';
        const num = Number(String(value).replace(/,/g,''));
        if (Number.isFinite(num)) return num.toLocaleString();
        return String(value);
      }

      const DAY_MS = 24 * 60 * 60 * 1000;

      function sanitizeId(value){
        return String(value || '').replace(/[^a-zA-Z0-9]/g,'').toUpperCase();
      }

      function parseDateParts(value){
        if (value === null || value === undefined || value === '') return null;
        if (value instanceof Date && !Number.isNaN(value.getTime())){
          return {
            date: value,
            hasYear: true,
            yearValue: value.getFullYear(),
            month: value.getMonth() + 1,
            day: value.getDate()
          };
        }
        let str = String(value || '').trim();
        if (!str) return null;
        const iso = Date.parse(str);
        if (!Number.isNaN(iso)){
          const parsed = new Date(iso);
          return {
            date: parsed,
            hasYear: true,
            yearValue: parsed.getFullYear(),
            month: parsed.getMonth() + 1,
            day: parsed.getDate()
          };
        }
        str = str.replace(/[\s.-]+/g,'/');
        const parts = str.split('/');
        if (parts.length < 2) return null;
        let [p1,p2,p3] = parts;
        let n1 = parseInt(p1, 10);
        let n2 = parseInt(p2, 10);
        let n3 = p3 !== undefined ? parseInt(p3, 10) : NaN;
        if (Number.isNaN(n1) || Number.isNaN(n2)) return null;
        let day = n1;
        let month = n2;
        if (n1 > 12 && n2 <= 12){ day = n1; month = n2; }
        else if (n2 > 12 && n1 <= 12){ day = n2; month = n1; }
        else { day = n1; month = n2; }
        const hasYear = !Number.isNaN(n3);
        let year = hasYear ? n3 : (new Date().getFullYear());
        if (hasYear && year < 100){ year += year > 30 ? 1900 : 2000; }
        day = Math.min(31, Math.max(1, day));
        month = Math.min(12, Math.max(1, month));
        const date = new Date(year, month - 1, day);
        if (Number.isNaN(date.getTime())) return null;
        return {
          date,
          hasYear,
          yearValue: hasYear ? year : null,
          month,
          day
        };
      }

      function formatDateHuman(date){
        if (!date || Number.isNaN(date.getTime())) return null;
        return date.toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' });
      }

      function thisYearOccurrence(parts){
        if (!parts) return null;
        const now = new Date();
        const occ = new Date(now.getFullYear(), parts.month - 1, parts.day);
        return Number.isNaN(occ.getTime()) ? null : occ;
      }

      function describeDaysInCompany(row){
        const joinParts = parseDateParts(canonicalValue(row,'work_anniversary'));
        if (!joinParts){
          const fallback = canonicalValue(row,'days_in_company');
          return fallback ? formatDisplay(fallback) : '—';
        }
        const today = new Date();
        const diffDays = Math.max(0, Math.floor((today - joinParts.date) / DAY_MS));
        const joinedLabel = formatDateHuman(joinParts.date);
        const base = diffDays.toLocaleString() + ' days';
        return joinedLabel ? `${base} · Joined ${joinedLabel}` : base;
      }

      function computeAgeFromDate(date){
        if (!date || Number.isNaN(date.getTime())) return null;
        const today = new Date();
        let age = today.getFullYear() - date.getFullYear();
        const hasHadBirthday = (today.getMonth() > date.getMonth()) || (today.getMonth() === date.getMonth() && today.getDate() >= date.getDate());
        if (!hasHadBirthday) age -= 1;
        return Number.isFinite(age) ? age : null;
      }

      function describeBirthday(row){
        const parts = parseDateParts(canonicalValue(row,'birthdate'));
        if (!parts) return '—';
        const pieces = [];
        const dobLabel = formatDateHuman(parts.date);
        if (dobLabel) pieces.push(dobLabel);
        if (parts.hasYear){
          const age = computeAgeFromDate(parts.date);
          if (Number.isFinite(age)) pieces.push(`Age ${age}`);
        }
        const thisYear = thisYearOccurrence(parts);
        if (thisYear){
          pieces.push(`This year: ${formatDateHuman(thisYear)}`);
        }
        return pieces.length ? pieces.join(' · ') : '—';
      }

      function describeWeddingAnniversary(row){
        const parts = parseDateParts(canonicalValue(row,'wedding_anniversary'));
        if (!parts) return '—';
        const pieces = [];
        const annLabel = formatDateHuman(parts.date);
        if (annLabel) pieces.push(annLabel);
        const thisYear = thisYearOccurrence(parts);
        if (thisYear){
          pieces.push(`This year: ${formatDateHuman(thisYear)}`);
        }
        return pieces.length ? pieces.join(' · ') : '—';
      }

      function buildFallbackRow(payload){
        if (!payload) return null;
        const profile = payload.profile || {};
        const branch = payload.branch || {};
        return {
          name: payload.name || profile['Name'],
          employee_id: payload.empId || profile['Employee ID'],
          designation: profile['Designation'] || payload.role,
          level: profile['Level'],
          branch_name: profile['Branch Name'] || branch.name,
          branch_code: profile['Branch Code'] || branch.code,
          branch_email: profile['Branch Email ID'] || branch.email || payload.email,
          district: profile['District'] || branch.district,
          region: profile['Region'] || branch.region,
          state: profile['State'] || branch.state,
          disbursement_amount: profile['Disbursement - Amount'],
          disbursement_account: profile['Disbursement - Accounts'],
          regular_demand_pct: profile['Regular Collection - % Collected'],
          npa_amount: profile['NPA - Amount'],
          ftod_amount: profile['FTOD - Amount'],
          ftod_percent: profile['FTOD - Percentage'],
          npa_percent: profile['NPA - Percentage'],
          active_accounts: profile['Active Accounts'],
          total_portfolio_amount: profile['Total Portfolio – Amount'],
          regular_portfolio_account: profile['Regular Portfolio – Account'],
          regular_portfolio_amount: profile['Regular Portfolio – Amount'],
          par1_plus_account: profile['1+ PAR – Account'],
          par1_plus_amount: profile['1+ PAR – Amount'],
          ftod_account: profile['FTOD – Account'],
          audit_rating: profile['Audit Rating'],
          year: profile['Year'],
          month: profile['Month'],
          sl_no: profile['Sl.no'],
          npa_account: profile['NPA – Account'],
          birthdate: profile['Birthdate'],
          wedding_anniversary: profile['Wedding Anniversary'],
          work_anniversary: profile['Work Anniversary']
        };
      }

      function filterRows(){
        let filtered = rows.slice();
        if (focusEmployeeId){
          filtered = filtered.filter(r => sanitizeId(canonicalValue(r,'employee_id')) === focusEmployeeId);
        } else if (defaultBranchCode){
          filtered = filtered.filter(r => (canonicalValue(r,'branch_code') || '').toString().trim().toLowerCase() === defaultBranchCode);
        }
        if (state.year){
          filtered = filtered.filter(r => (canonicalValue(r,'year') || '').toString().trim() === state.year);
        }
        if (state.month){
          const target = state.month.toLowerCase();
          filtered = filtered.filter(r => (canonicalValue(r,'month') || '').toString().trim().toLowerCase() === target);
        }
        return filtered;
      }

      function pickTopRow(rows, metricKey){
        const scored = rows.map(r => ({ row:r, value:numericValue(r, metricKey) }))
          .filter(entry => Number.isFinite(entry.value));
        if (scored.length){
          scored.sort((a,b)=>b.value - a.value);
          return scored[0].row;
        }
        return rows[0] || null;
      }

      function render(){
        const filtered = filterRows();
        const target = pickTopRow(filtered, state.metric) || fallbackRow;
        renderProfile(target);
        renderSnapshot(target);
        selectors.status.textContent = filtered.length
          ? `Showing ${filtered.length} record(s)`
          : 'Showing cached profile';
      }

      function setDerivedText(id, value){
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = value && value !== '—' ? value : '—';
      }

      function setText(id, value){
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = formatDisplay(value);
      }

      function renderProfile(row){
        const data = row || fallbackRow;
        setText('field-name', canonicalValue(data,'name'));
        setText('field-emp', canonicalValue(data,'employee_id'));
        setText('field-designation', canonicalValue(data,'designation'));
        setText('field-level', canonicalValue(data,'level'));
        setText('field-branch-name', canonicalValue(data,'branch_name'));
        setText('field-branch-code', canonicalValue(data,'branch_code'));
        setText('field-branch-email', canonicalValue(data,'branch_email'));

        setText('boe-name', canonicalValue(data,'name'));
        setText('boe-designation', canonicalValue(data,'designation'));
        setText('boe-code', canonicalValue(data,'branch_code'));
        setText('boe-email', canonicalValue(data,'branch_email'));
        setText('boe-district', canonicalValue(data,'district'));
        setText('boe-region', canonicalValue(data,'region'));
        setText('boe-state', canonicalValue(data,'state'));

        setDerivedText('field-days', describeDaysInCompany(data));
        setDerivedText('field-birthdate', describeBirthday(data));
        setDerivedText('field-anniversary', describeWeddingAnniversary(data));

        setText('ach-disbursement', canonicalValue(data,'disbursement_amount') || canonicalValue(data,'disbursement_account'));
        setText('ach-collection', percentValue(data,'regular_demand_pct'));

        setText('disb-accounts', canonicalValue(data,'disbursement_account'));
        setText('disb-amount', canonicalValue(data,'disbursement_amount'));
        setText('reg-accounts', canonicalValue(data,'regular_portfolio_account'));
        document.getElementById('reg-pct').textContent = percentValue(data,'regular_demand_pct');
        setText('npa-accounts', canonicalValue(data,'npa_account'));
        document.getElementById('npa-pct').textContent = percentValue(data,'npa_percent');
        setText('ftod-accounts', canonicalValue(data,'ftod_account'));
        document.getElementById('ftod-pct').textContent = percentValue(data,'ftod_percent');

        setCollectionPercents(data);
      }

      function setCollectionPercents(data){
        const reg = numericValue(data,'regular_demand_pct');
        const npa = numericValue(data,'npa_percent');
        const ftod = numericValue(data,'ftod_percent');
        document.getElementById('btn-reg').dataset.percent = Number.isFinite(reg) ? (reg <= 1 ? reg * 100 : reg) : '';
        document.getElementById('btn-npa').dataset.percent = Number.isFinite(npa) ? (npa <= 1 ? npa * 100 : npa) : '';
        document.getElementById('btn-ftod').dataset.percent = Number.isFinite(ftod) ? (ftod <= 1 ? ftod * 100 : ftod) : '';
        computeProductivity();
      }

      function renderSnapshot(row){
        const data = row || fallbackRow;
        if (!data){
          selectors.snapshotBody.innerHTML = '<tr><td class="p-3 text-center text-[var(--muted)]" colspan="2">No profile data available.</td></tr>';
          return;
        }
        selectors.snapshotBody.innerHTML = SNAPSHOT_FIELDS.map(field => {
          const value = field.key === 'audit_rating'
            ? percentValue(data,'audit_rating')
            : formatDisplay(canonicalValue(data, field.key));
          return `
          <tr class="odd:bg-white even:bg-gray-50">
            <td class="p-3 border-b border-[var(--line)] font-medium">${field.label}</td>
            <td class="p-3 border-b border-[var(--line)]">${value}</td>
          </tr>`;
        }).join('');
      }
    })();
  </script>
</body>
</html>
