<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Corporate Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --brand:#0a84ff; --ink:#0e1a2b; --muted:#6a7485;
      --bg:#f5f7fb; --card:#ffffff; --line:#e6e9f0;
    }
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 24px rgba(2,14,36,.06)}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
    .mini{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:.75rem .9rem}
    .pill{display:inline-flex;align-items:center;gap:.5rem;border:1px dashed var(--line);border-radius:999px;padding:.5rem .9rem;background:#fff}
    .overlay{position:fixed;inset:0;background:rgba(2,14,36,.55);backdrop-filter:blur(6px);display:none;z-index:50}
    .sheet{background:#fff;max-width:960px;margin:5vh auto;border-radius:20px;border:1px solid var(--line);box-shadow:0 30px 60px rgba(2,14,36,.2)}
  </style>
  <style>
    @media (max-width: 640px){
      header{flex-direction:column;align-items:flex-start;gap:.75rem;}
      .kpi{grid-template-columns:1fr;}
      .mini{padding:.65rem .8rem;}
      main{padding-inline:1rem;}
    }
  </style>
</head>
<body>

  <main class="max-w-6xl mx-auto p-6 md:p-10 space-y-8">
    <!-- Title -->
    <header class="flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Corporate Profile</h1>

      <!-- Extract Template button -->
      <button type="button" id="extract-template"
              class="px-4 py-2 rounded-md text-white bg-[var(--brand)] shadow hover:opacity-95"
              aria-label="Extract Template">
        Extract Template
      </button>
    </header>

    <!-- Achievement (2 fields only) -->
    <section class="card p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Achievement</h2>
        <span class="text-xs text-[var(--muted)]">Highlight standout results</span>
      </div>
      <div class="mt-4 grid sm:grid-cols-2 gap-4">
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Disbursement</div>
          <div class="mt-1 font-medium" id="ach-disbursement">—</div>
        </div>
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Collection</div>
          <div class="mt-1 font-medium" id="ach-collection">—</div>
        </div>
      </div>
    </section>

    <!-- Identity Box -->
    <section class="card p-6">
      <h2 class="text-lg font-semibold">Identity</h2>
      <div class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Name</div>
          <div class="mt-1 font-medium" id="field-name">—</div>
        </div>
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Employee ID</div>
          <div class="mt-1 font-medium" id="field-emp">—</div>
        </div>
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Designation</div>
          <div class="mt-1 font-medium" id="field-designation">—</div>
        </div>
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Branch Name</div>
          <div class="mt-1 font-medium" id="field-branch-name">—</div>
        </div>
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Branch Code</div>
          <div class="mt-1 font-medium" id="field-branch-code">—</div>
        </div>
        <div class="mini">
          <div class="text-xs text-[var(--muted)]">Branch Email ID</div>
          <div class="mt-1 font-medium" id="field-branch-email">—</div>
        </div>
      </div>
    </section>

    <!-- Personal Stats -->
    <section class="grid md:grid-cols-3 gap-6">
      <div class="card p-6">
        <h3 class="text-sm font-semibold">Days in Company</h3>
        <div class="mt-3 text-2xl font-bold" id="field-days">—</div>
      </div>
      <div class="card p-6">
        <h3 class="text-sm font-semibold">Birthdate</h3>
        <div class="mt-3 text-2xl font-bold" id="field-birthdate">—</div>
      </div>
      <div class="card p-6">
        <h3 class="text-sm font-semibold">Wedding Anniversary</h3>
        <div class="mt-3 text-2xl font-bold" id="field-anniversary">—</div>
      </div>
    </section>

    <!-- Key Operations -->
    <section class="space-y-4">
      <h2 class="text-lg font-semibold">Key Operations</h2>
      <div class="grid md:grid-cols-2 xl:grid-cols-4 gap-6">
        <!-- Disbursement -->
        <button id="btn-disb" class="card p-5 text-left hover:shadow-lg transition open-panel" data-target="#panel-disb">
          <div class="text-sm text-[var(--muted)]">Disbursement</div>
          <div class="kpi mt-3">
            <div class="mini">
              <div class="text-xs text-[var(--muted)]">Accounts</div>
              <div class="mt-1 font-semibold">—</div>
            </div>
            <div class="mini">
              <div class="text-xs text-[var(--muted)]">Amount</div>
              <div class="mt-1 font-semibold">—</div>
            </div>
          </div>
        </button>

        <!-- Regular Collection -->
        <button id="btn-reg" class="card p-5 text-left hover:shadow-lg transition open-panel" data-target="#panel-reg"
                data-percent="">
          <div class="text-sm text-[var(--muted)]">Regular Collection</div>
          <div class="kpi mt-3">
            <div class="mini">
              <div class="text-xs text-[var(--muted)]">Accounts</div>
              <div class="mt-1 font-semibold">—</div>
            </div>
            <div class="mini">
              <div class="text-xs text-[var(--muted)]">% Collected</div>
              <div class="mt-1 font-semibold" id="reg-pct">—</div>
            </div>
          </div>
        </button>

        <!-- NPA Collection -->
        <button id="btn-npa" class="card p-5 text-left hover:shadow-lg transition open-panel" data-target="#panel-npa"
                data-percent="">
          <div class="text-sm text-[var(--muted)]">NPA Collection</div>
          <div class="kpi mt-3">
            <div class="mini">
              <div class="text-xs text-[var(--muted)]">Accounts</div>
              <div class="mt-1 font-semibold">—</div>
            </div>
            <div class="mini">
              <div class="text-xs text-[var(--muted)]">% Collected</div>
              <div class="mt-1 font-semibold" id="npa-pct">—</div>
            </div>
          </div>
        </button>

        <!-- FTOD Collection -->
        <button id="btn-ftod" class="card p-5 text-left hover:shadow-lg transition open-panel" data-target="#panel-ftod"
                data-percent="">
          <div class="text-sm text-[var(--muted)]">FTOD Collection</div>
          <div class="kpi mt-3">
            <div class="mini">
              <div class="text-xs text-[var(--muted)]">Accounts</div>
              <div class="mt-1 font-semibold">—</div>
            </div>
            <div class="mini">
              <div class="text-xs text-[var(--muted)]">% Collected</div>
              <div class="mt-1 font-semibold" id="ftod-pct">—</div>
            </div>
          </div>
        </button>
      </div>
    </section>

    <!-- Productivity -->
    <section class="card p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Productivity</h2>
        <span class="text-xs text-[var(--muted)]">Auto-calculates when percentages are provided</span>
      </div>
      <div class="mt-3 text-3xl font-bold" id="productivity">—</div>
    </section>

    <!-- Performance Table (placeholder exactly as requested) -->
    <section class="card p-6">
      <h2 class="text-lg font-semibold mb-4">Performance (Placeholder)</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm border border-[var(--line)] rounded-lg overflow-hidden">
          <thead class="bg-gray-50">
            <tr>
              <th class="text-left p-3 border-b border-[var(--line)]">Column 1</th>
              <th class="text-left p-3 border-b border-[var(--line)]">Column 2</th>
            </tr>
          </thead>
          <tbody>
            <tr class="odd:bg-white even:bg-gray-50">
              <td class="p-3 border-b border-[var(--line)]">Row 1</td>
              <td class="p-3 border-b border-[var(--line)]">Row 1</td>
            </tr>
            <tr class="odd:bg-white even:bg-gray-50">
              <td class="p-3">Row 2</td>
              <td class="p-3">Row 2</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Overlays -->
  <div id="panel-disb" class="overlay" aria-hidden="true">
    <div class="sheet mx-4 p-6 md:p-8">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">Disbursement — Pipeline</h3>
        <button class="px-3 py-2 text-sm rounded-md bg-gray-100 hover:bg-gray-200 close-panel">Close</button>
      </div>
      <div class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <span class="pill">Sanction Pending</span>
        <span class="pill">KYC Pending</span>
        <span class="pill">QC Review</span>
        <span class="pill">Disbursement Pending</span>
        <span class="pill">Booked</span>
      </div>
    </div>
  </div>

  <div id="panel-reg" class="overlay" aria-hidden="true">
    <div class="sheet mx-4 p-6 md:p-8">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">Regular Collection — Breakdown</h3>
        <button class="px-3 py-2 text-sm rounded-md bg-gray-100 hover:bg-gray-200 close-panel">Close</button>
      </div>
      <div class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <span class="pill">Due Today</span>
        <span class="pill">Collected</span>
        <span class="pill">Overdue</span>
        <span class="pill">Roll-forward</span>
        <span class="pill">Exceptions</span>
      </div>
    </div>
  </div>

  <div id="panel-npa" class="overlay" aria-hidden="true">
    <div class="sheet mx-4 p-6 md:p-8">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">NPA Collection — Status</h3>
        <button class="px-3 py-2 text-sm rounded-md bg-gray-100 hover:bg-gray-200 close-panel">Close</button>
      </div>
      <div class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <span class="pill">90+ Bucket</span>
        <span class="pill">Follow-ups</span>
        <span class="pill">Promises to Pay</span>
        <span class="pill">Recoveries</span>
        <span class="pill">Settlements</span>
      </div>
    </div>
  </div>

  <div id="panel-ftod" class="overlay" aria-hidden="true">
    <div class="sheet mx-4 p-6 md:p-8">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-semibold">FTOD Collection — Status</h3>
        <button class="px-3 py-2 text-sm rounded-md bg-gray-100 hover:bg-gray-200 close-panel">Close</button>
      </div>
      <div class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <span class="pill">FTOD Cases</span>
        <span class="pill">Recovered</span>
        <span class="pill">Pending</span>
        <span class="pill">Escalations</span>
        <span class="pill">Exceptions</span>
      </div>
    </div>
  </div>

  <script>
    // Open/close panels
    document.querySelectorAll('.open-panel').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.dataset.target;
        const el = document.querySelector(id);
        if(el){ el.style.display = 'block'; el.setAttribute('aria-hidden','false'); }
      });
    });
    document.querySelectorAll('.close-panel').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const overlay = btn.closest('.overlay');
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden','true');
      });
    });
    document.querySelectorAll('.overlay').forEach(ov=>{
      ov.addEventListener('click', (e)=>{ if(e.target === ov){ ov.style.display='none'; ov.setAttribute('aria-hidden','true'); } });
    });
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){ document.querySelectorAll('.overlay').forEach(o=>{o.style.display='none'; o.setAttribute('aria-hidden','true');}); }
    });

    // Productivity: simple average of available percentages (placeholder logic).
    function asNum(v){ const n = parseFloat(v); return isNaN(n)?null:n; }
    function computeProductivity(){
      const reg = asNum(document.getElementById('btn-reg').dataset.percent);
      const npa = asNum(document.getElementById('btn-npa').dataset.percent);
      const ftod = asNum(document.getElementById('btn-ftod').dataset.percent);
      const arr = [reg,npa,ftod].filter(v=>v!==null);
      const out = document.getElementById('productivity');
      if(arr.length===0){ out.textContent='—'; return; }
      const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
      out.textContent = avg.toFixed(2) + ' %';
    }
    computeProductivity();

    // ------- Extract Template (CSV) -------
    const TEMPLATE_HEADERS = [
      "Sl. no.",
      "year",
      "month",
      "Name",
      "Employee ID",
      "Designation",
      "Branch Name",
      "Branch Code",
      "Branch Email ID",
      "Days in Company",
      "Birthdate (YYYY-MM-DD)",
      "Wedding Anniversary (YYYY-MM-DD)",
      "Disbursement - Accounts",
      "Disbursement - Amount",
      "Disbursement - Sanction Pending",
      "Disbursement - KYC Pending",
      "Disbursement - QC Review",
      "Disbursement - Disbursement Pending",
      "Disbursement - Booked",
      "Regular Collection - Accounts",
      "Regular Collection - % Collected",
      "Regular Collection - Due Today",
      "Regular Collection - Collected",
      "Regular Collection - Overdue",
      "Regular Collection - Roll-forward",
      "Regular Collection - Exceptions",
      "NPA Collection - Accounts",
      "NPA Collection - % Collected",
      "NPA Collection - 90+ Bucket",
      "NPA Collection - Follow-ups",
      "NPA Collection - Promises to Pay",
      "NPA Collection - Recoveries",
      "NPA Collection - Settlements",
      "FTOD Collection - Accounts",
      "FTOD Collection - % Collected",
      "FTOD Collection - FTOD Cases",
      "FTOD Collection - Recovered",
      "FTOD Collection - Pending",
      "FTOD Collection - Escalations",
      "FTOD Collection - Exceptions",
      "Performance - Column 1",
      "Performance - Column 2"
    ];

    function toCsvRow(arr){
      // CSV quoting: wrap in " and escape inner " as ""
      return arr.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',');
    }

    document.getElementById('extract-template').addEventListener('click', () => {
      const header = toCsvRow(TEMPLATE_HEADERS);
      const csv = header + '\r\n'; // header row only, template style
      // Prepend BOM so Excel opens UTF-8 correctly
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "Corporate_Profile_Template.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
    // -------------------------------------
  </script>
  <script>
    (function(){
      const formatValue = (val, fallback='—')=>{
        if(val === null || val === undefined || val === '') return fallback;
        if(typeof val === 'number' && isFinite(val)) return val.toLocaleString();
        return String(val);
      };
      const setText = (id, value, fallback)=>{
        const el = document.getElementById(id);
        if(!el) return;
        el.textContent = formatValue(value, fallback);
      };
      try{
        const raw = localStorage.getItem('nlpl_profile_payload');
        if(!raw){
          setText('field-name','Login required','Login required');
          return;
        }
        const payload = JSON.parse(raw);
        const profile = payload.profile || {};
        const branch = payload.branch || {};

        setText('field-name', payload.name || profile['Name']);
        setText('field-emp', payload.empId || profile['Employee ID']);
        setText('field-designation', profile['Designation'] || payload.role);
        setText('field-branch-name', profile['Branch Name'] || branch.name);
        setText('field-branch-code', profile['Branch Code'] || branch.code);
        setText('field-branch-email', profile['Branch Email ID'] || branch.email);

        setText('field-days', profile['Days in Company']);
        setText('field-birthdate', profile['Birthdate (YYYY-MM-DD)']);
        setText('field-anniversary', profile['Wedding Anniversary (YYYY-MM-DD)']);

        const disbVal = profile["Disbursement - Amount"] ?? profile["Disbursement - Accounts"];
        const collVal = profile["Regular Collection - % Collected"] ?? profile["Regular Collection - Accounts"];
        setText('ach-disbursement', disbVal);
        setText('ach-collection', collVal);
      }catch(err){
        console.warn('Unable to hydrate profile view', err);
      }
    })();
  </script>
</body>
</html>
