<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NLPL — Blank Shell</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --ink:#0b1220; --muted:#6b7280; --line:#e5e7eb; --active:#111827; --ring:#93c5fd; }
    html,body{height:100%}
    body{ background:#ffffff; color:var(--ink); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; }
    .nav-item[aria-current="page"]{ color:var(--active); background:#f8fafc; }
    .nav-item[aria-current="page"] .bar{ opacity:1; }
    .bar{ opacity:.12; }
    .focus-ring:focus{ outline:2px solid var(--ring); outline-offset:2px; border-radius:8px; }

    .pill{font-size:12px;padding:.25rem .5rem;border:1px solid var(--line);border-radius:999px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; border:1px solid var(--line); border-bottom-width:2px; padding:.2rem .45rem; border-radius:6px; background:#f9fafb}

    /* Shortcut assign UI */
    .assign-box{
      min-height:38px;
      border:1px dashed var(--line);
      border-radius:10px;
      display:flex;align-items:center;justify-content:flex-start;
      padding:.5rem .75rem; cursor:pointer;
    }
    .assign-box:hover{ background:#f8fafc }
    .assign-hint{ color:var(--muted); font-size:12px }

    /* Toast */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; z-index:50;
      background:#111827; color:white; border-radius:12px;
      box-shadow:0 12px 28px rgba(0,0,0,.22);
      padding:.75rem 1rem; display:flex; align-items:center; gap:.6rem;
    }
    .toast.hidden{ display:none }
    .dot{ width:8px;height:8px;border-radius:999px;background:#22c55e; box-shadow:0 0 0 6px rgba(34,197,94,.18) }

    /* Loader + empty states for partials */
    .partial-box{ border:1px dashed var(--line); border-radius:12px; padding:1rem; background:#f8fafc }

    /* Iframe wrapper */
    .partial-frame{
      width:100%; border:0; border-radius:12px; background:#fff;
      /* default height before auto-resize kicks in */
      height:70vh;
      box-shadow:0 1px 0 rgba(0,0,0,.02);
    }
  </style>
</head>
<body>
  <div class="min-h-screen grid grid-cols-[260px_1fr]">
    <!-- Sidebar -->
    <aside class="border-r border-[var(--line)]">
      <div class="h-full flex flex-col">
        <div class="px-5 pt-5 pb-4">
          <div class="text-lg font-semibold tracking-tight">NLPL</div>
          <div class="text-sm text-[var(--muted)]">Workspace</div>
        </div>

        <!-- Nav -->
        <nav class="px-2 space-y-1" role="navigation" aria-label="Sidebar">
          <button class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-[var(--muted)] hover:bg-slate-50 focus-ring"
                  data-target="profile">
            <span class="bar w-1 h-6 rounded bg-slate-900/70"></span>
            <span>Profile</span>
          </button>

          <button class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-[var(--muted)] hover:bg-slate-50 focus-ring"
                  data-target="branch-location">
            <span class="bar w-1 h-6 rounded bg-slate-900/70"></span>
            <span>Branch Location</span>
          </button>

          <button class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-[var(--muted)] hover:bg-slate-50 focus-ring"
                  data-target="nlpl-at-a-glance">
            <span class="bar w-1 h-6 rounded bg-slate-900/70"></span>
            <span>NLPL at a Glance</span>
          </button>

          <button class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-[var(--muted)] hover:bg-slate-50 focus-ring"
                  data-target="raise-your-concern">
            <span class="bar w-1 h-6 rounded bg-slate-900/70"></span>
            <span>Raise your concern</span>
          </button>

          <button class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-[var(--muted)] hover:bg-slate-50 focus-ring"
                  data-target="notification">
            <span class="bar w-1 h-6 rounded bg-slate-900/70"></span>
            <span>Notification</span>
          </button>

          <button class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm text-[var(--muted)] hover:bg-slate-50 focus-ring"
                  data-target="settings">
            <span class="bar w-1 h-6 rounded bg-slate-900/70"></span>
            <span>Settings</span>
          </button>
        </nav>

        <div class="mt-auto p-4 text-[11px] text-[var(--muted)]">
          <!-- empty footer area -->
        </div>
      </div>
    </aside>

    <!-- Main content -->
    <main class="p-6">
      <header class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <h1 id="page-title" class="text-xl font-semibold tracking-tight">Profile</h1>
        <div class="flex items-center gap-3">
          <div class="text-right text-sm text-[var(--muted)] leading-tight">
            <div class="font-semibold text-[var(--ink)]" data-user-name>—</div>
            <div data-user-branch>—</div>
          </div>
          <button id="nlplLogout" class="px-3 py-1.5 rounded-lg border border-[var(--line)] hover:bg-slate-50 text-sm">Sign out</button>
        </div>
      </header>

      <!-- Views (containers to host iframes for routes; settings is internal) -->
      <section data-view="profile" class="block"></section>
      <section data-view="branch-location" class="hidden"></section>
      <section data-view="nlpl-at-a-glance" class="hidden"></section>
      <section data-view="raise-your-concern" class="hidden"></section>
      <section data-view="notification" class="hidden"></section>

      <!-- SETTINGS — stays internal -->
      <section data-view="settings" class="hidden">
        <div class="space-y-6">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold tracking-tight">Settings</h2>
            <button id="scan-device" class="px-3 py-1.5 rounded-lg border border-[var(--line)] hover:bg-slate-50 text-sm">Scan & Detect</button>
          </div>

          <div class="grid gap-4 md:grid-cols-2">
            <!-- Device summary -->
            <div class="p-4 border border-[var(--line)] rounded-xl">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold">Device summary</h3>
                <span id="device-badge" class="pill">Unknown</span>
              </div>
              <dl id="device-dl" class="mt-3 grid grid-cols-1 gap-2 text-sm text-[var(--muted)]">
                <!-- filled by JS -->
              </dl>
            </div>

            <!-- Section Shortcuts (assign) -->
            <div class="p-4 border border-[var(--line)] rounded-xl">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold">Section Shortcuts</h3>
                <button id="reset-all" class="px-3 py-1.5 rounded-lg border border-[var(--line)] hover:bg-slate-50 text-sm">Reset All</button>
              </div>
              <p class="text-sm text-[var(--muted)] mt-1">
                Click the blank space next to a section, then press your shortcut. It saves instantly. (Esc cancels)
              </p>
              <ul id="shortcut-list" class="mt-3 space-y-2 text-sm">
                <!-- rows populated by JS -->
              </ul>
              <p class="assign-hint mt-2">Note: Some browser/system shortcuts can’t be overridden.</p>
            </div>
          </div>
        </div>
      </section>
      <!-- /SETTINGS -->
    </main>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden">
    <span class="dot"></span>
    <span id="toast-text">Press your shortcut…</span>
    <span class="text-[12px] opacity-80">(Esc to cancel)</span>
  </div>

  <script>
    (function(){
      const sessionPayload = (()=> {
        const raw = localStorage.getItem('nlpl_profile_payload');
        if(!raw) return null;
        try{
          return JSON.parse(raw);
        }catch(err){
          console.warn('Invalid NLPL payload', err);
          return null;
        }
      })();
      if(!sessionPayload){
        window.location.replace('../index.html');
        return;
      }

      const userNameSlot = document.querySelector('[data-user-name]');
      const userBranchSlot = document.querySelector('[data-user-branch]');
      if(userNameSlot){
        const parts = [sessionPayload.name, sessionPayload.empId].filter(Boolean);
        userNameSlot.textContent = parts.length ? parts.join(' · ') : 'NLPL User';
      }
      if(userBranchSlot){
        const branchName = sessionPayload.branch?.name || sessionPayload.profile?.["Branch Name"] || '';
        userBranchSlot.textContent = branchName ? `Branch: ${branchName}` : '';
      }
      document.getElementById('nlplLogout')?.addEventListener('click', ()=>{
        localStorage.removeItem('nlpl_profile_payload');
        localStorage.removeItem('nlpl_user_name');
        localStorage.removeItem('nlpl_user_id');
        window.location.replace('../index.html');
      });

      const links = Array.from(document.querySelectorAll('.nav-item'));
      const views = Array.from(document.querySelectorAll('[data-view]'));
      const title = document.getElementById('page-title');

      // External files for each route (loaded in isolated iframes)
      const FILE_MAP = {
        'profile': 'profile.html',
        'branch-location': 'location.html',
        'nlpl-at-a-glance': 'nlpl-at-a-glance.html',
        'raise-your-concern': 'raise-your-concern.html',
        'notification': 'notification.html',
        // 'settings' -> stays internal
      };

      function titleFor(route){
        switch(route){
          case 'profile': return 'Profile';
          case 'branch-location': return 'Branch Location';
          case 'nlpl-at-a-glance': return 'NLPL at a Glance';
          case 'raise-your-concern': return 'Raise your concern';
          case 'notification': return 'Notification';
          case 'settings': return 'Settings';
          default: return 'Profile';
        }
      }

      function setActiveButton(route){
        links.forEach(btn=>{
          const isActive = btn.dataset.target === route;
          btn.setAttribute('aria-current', isActive ? 'page' : 'false');
        });
      }

      function showOnly(route){
        views.forEach(v=>{
          v.classList.toggle('hidden', v.dataset.view !== route);
          v.classList.toggle('block', v.dataset.view === route);
        });
      }

      function containerFor(route){
        return document.querySelector('[data-view="'+route+'"]');
      }

      // Create an iframe for the route, auto-resize height, and isolate styles
      async function loadPartial(route){
        const file = FILE_MAP[route];
        if(!file) return; // settings or unknown
        const el = containerFor(route);
        if(!el) return;

        // Show a small loading state
        el.innerHTML = '<div class="partial-box text-sm text-[var(--muted)]">Loading <strong>'+file+'</strong>…</div>';

        // Check existence quickly to give graceful "missing" state
        try{
          const res = await fetch(file, { cache: 'no-store' });
          if(!res.ok){
            el.innerHTML = '<div class="partial-box text-sm">"<strong>'+file+'</strong>" missing.</div>';
            return;
          }
        }catch(e){
          el.innerHTML = '<div class="partial-box text-sm">"<strong>'+file+'</strong>" missing.</div>';
          return;
        }

        // Mount iframe (isolation: no CSS bleed)
        const iframe = document.createElement('iframe');
        iframe.className = 'partial-frame';
        // Allow scripts, same-origin for sizing, popups for Google Maps links
        iframe.setAttribute('sandbox','allow-scripts allow-same-origin allow-popups allow-forms');
        // bust cache during dev
        iframe.src = file + '?v=' + Date.now();

        // Auto-size routine (poll a bit; also on load)
        function resize(){
          try{
            const doc = iframe.contentDocument;
            if(!doc) return;
            const h = Math.max(
              doc.body?.scrollHeight || 0,
              doc.documentElement?.scrollHeight || 0,
              600
            );
            // cap to something sensible so it doesn't get absurdly tall
            iframe.style.height = Math.min(h, 2200) + 'px';
          }catch(_){}
        }
        iframe.addEventListener('load', ()=>{
          resize();
          // Re-run a few times as content lays out / map initializes
          let ticks = 0;
          const t = setInterval(()=>{
            resize();
            if(++ticks > 20) clearInterval(t);
          }, 250);
        });

        el.innerHTML = '';
        el.appendChild(iframe);
      }

      function activate(route){
        const known = ['profile','branch-location','nlpl-at-a-glance','raise-your-concern','notification','settings'];
        if(!known.includes(route)) route = 'profile';

        setActiveButton(route);
        showOnly(route);
        title.textContent = titleFor(route);
        history.replaceState(null, '', '#'+route);

        if(route !== 'settings'){
          loadPartial(route);
        }
      }

      // Initial route respects URL hash if present
      const startRoute = (location.hash || '').replace('#','') || 'profile';
      activate(startRoute);

      // Click handlers
      links.forEach(btn=>{
        btn.addEventListener('click', ()=> activate(btn.dataset.target));
      });

      /* ---------- SETTINGS: Device scan ---------- */
      const deviceDl = document.getElementById('device-dl');
      const deviceBadge = document.getElementById('device-badge');
      function getGPUInfo(){
        try{
          const canvas = document.createElement('canvas');
          const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
          if(!gl) return {};
          const ext = gl.getExtension('WEBGL_debug_renderer_info');
          if(!ext) return {};
          return {
            vendor: gl.getParameter(ext.UNMASKED_VENDOR_WEBGL),
            renderer: gl.getParameter(ext.UNMASKED_RENDERER_WEBGL),
          };
        }catch(e){ return {}; }
      }
      function guessLaptop(os, gpuRenderer){
        if(/mac/i.test(os)){
          if(/apple/i.test(gpuRenderer)) return 'MacBook (Apple Silicon)';
          if(/intel/i.test(gpuRenderer)) return 'MacBook (Intel)';
          return 'Mac (model unknown)';
        }
        if(/win/i.test(os)) return 'Windows laptop/desktop';
        if(/linux|ubuntu|debian|fedora|arch/i.test(os)) return 'Linux machine';
        if(/crios|cros|chromebook/i.test(navigator.userAgent)) return 'Chromebook';
        return 'Unknown device';
      }
      function scanDevice(){
        const mem = navigator.deviceMemory ? navigator.deviceMemory + ' GB' : '—';
        const threads = navigator.hardwareConcurrency || '—';
        const ua = navigator.userAgent;
        const os = (function(){
          if(/Windows/i.test(ua)) return 'Windows';
          if(/Mac OS X|Macintosh/i.test(ua)) return 'macOS';
          if(/Android/i.test(ua)) return 'Android';
          if(/iPhone|iPad|iOS/i.test(ua)) return 'iOS';
          if(/Linux/i.test(ua)) return 'Linux';
          return 'Unknown';
        })();
        const gpu = getGPUInfo();
        const screenInfo = `${window.screen.width}×${window.screen.height} @ ${window.devicePixelRatio || 1}x`;
        const guessed = guessLaptop(os, (gpu.renderer || ''));

        deviceBadge.textContent = guessed;
        deviceDl.innerHTML = `
          <div><span class="text-[var(--ink)] font-medium">OS:</span> ${os}</div>
          <div><span class="text-[var(--ink)] font-medium">Browser vendor:</span> ${navigator.vendor || '—'}</div>
          <div><span class="text-[var(--ink)] font-medium">CPU threads:</span> ${threads}</div>
          <div><span class="text-[var(--ink)] font-medium">Memory:</span> ${mem}</div>
          <div><span class="text-[var(--ink)] font-medium">GPU vendor:</span> ${gpu.vendor || '—'}</div>
          <div><span class="text-[var(--ink)] font-medium">GPU renderer:</span> ${gpu.renderer || '—'}</div>
          <div><span class="text-[var(--ink)] font-medium">Screen:</span> ${screenInfo}</div>
          <div><span class="text-[var(--ink)] font-medium">User-Agent:</span> <span class="break-all">${ua}</span></div>
        `;
      }
      document.getElementById('scan-device')?.addEventListener('click', scanDevice);
      scanDevice(); // prefill once

      /* ---------- SETTINGS: Shortcut assign ---------- */
      const shortcutList = document.getElementById('shortcut-list');
      const toast = document.getElementById('toast');
      const toastText = document.getElementById('toast-text');

      // Sidebar sections
      const sectionButtons = Array.from(document.querySelectorAll('.nav-item'));
      const sections = sectionButtons.map(b => ({
        key: b.dataset.target,
        label: b.querySelector('span:nth-child(2)').textContent.trim()
      }));

      const STORE_KEY = 'nlpl.keymap.v1';
      function loadKeymap(){
        try{ return JSON.parse(localStorage.getItem(STORE_KEY) || '{}'); }catch(e){ return {}; }
      }
      function saveKeymap(map){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(map)); }catch(e){} }

      // Build UI
      let keymap = loadKeymap();
      function formatCombo(obj){
        if(!obj) return '';
        const parts = [];
        if(obj.meta) parts.push('⌘');
        if(obj.ctrl) parts.push('Ctrl');
        if(obj.alt) parts.push('Alt');
        if(obj.shift) parts.push('Shift');
        parts.push(humanKeyFromCode(obj.code));
        return parts.map(p=>`<span class="kbd">${p}</span>`).join(' ');
      }
      function humanKeyFromCode(code){
        if(!code) return '';
        if(/^Key[A-Z]$/.test(code)) return code.slice(3);
        if(/^Digit[0-9]$/.test(code)) return code.slice(5);
        const dict = {
          Space:'Space', Enter:'Enter', Escape:'Esc', Tab:'Tab', Backspace:'Backspace',
          Minus:'-', Equal:'=', Backquote:'`', BracketLeft:'[', BracketRight:']',
          Backslash:'\\', Semicolon:';', Quote:"'", Comma:',', Period:'.', Slash:'/',
          ArrowUp:'↑', ArrowDown:'↓', ArrowLeft:'←', ArrowRight:'→'
        };
        return dict[code] || code;
      }
      function renderShortcutRows(){
        shortcutList.innerHTML = sections.map(s=>{
          const assigned = keymap[s.key];
          return `
            <li class="flex items-center gap-3">
              <div class="min-w-0 grow">
                <div class="font-medium">${s.label}</div>
                <div class="text-[11px] text-[var(--muted)]">${s.key}</div>
              </div>
              <button class="assign-box text-left w-64 shrink-0" data-assign="${s.key}">
                ${assigned ? `<div class="flex items-center gap-1">${formatCombo(assigned)}</div>`
                           : `<span class="assign-hint">Click to assign…</span>`}
              </button>
            </li>
          `;
        }).join('');

        // add listeners
        shortcutList.querySelectorAll('[data-assign]').forEach(btn=>{
          btn.addEventListener('click', ()=> startCapture(btn.dataset.assign));
        });
      }
      renderShortcutRows();

      // Toast helpers
      function showToast(msg){
        toastText.innerHTML = msg;
        toast.classList.remove('hidden');
      }
      function hideToast(){ toast.classList.add('hidden'); }

      // Capture flow
      let capturingRoute = null;
      function startCapture(route){
        capturingRoute = route;
        const s = sections.find(x=>x.key===route);
        showToast(`Press your shortcut for <strong>${s ? s.label : route}</strong>…`);
      }
      function isModifierOnly(e){
        return (e.key === 'Shift' || e.key === 'Control' || e.key === 'Alt' || e.key === 'Meta');
      }
      function comboFromEvent(e){
        return { ctrl:e.ctrlKey, meta:e.metaKey, alt:e.altKey, shift:e.shiftKey, code:e.code };
      }
      function validCombo(c){
        const hasMod = c.ctrl || c.meta || c.alt;
        const real = c.code && !['ShiftLeft','ShiftRight','ControlLeft','ControlRight','AltLeft','AltRight','MetaLeft','MetaRight'].includes(c.code);
        return hasMod && real;
      }
      function equalCombo(a,b){
        return a && b && a.ctrl===b.ctrl && a.meta===b.meta && a.alt===b.alt && a.shift===b.shift && a.code===b.code;
      }

      // Global keydown: capture OR trigger shortcuts
      document.addEventListener('keydown', (e)=>{
        const tag = document.activeElement && document.activeElement.tagName;
        const editing = (document.activeElement && document.activeElement.isContentEditable) || ['INPUT','TEXTAREA','SELECT'].includes(tag);

        // Capture mode
        if(capturingRoute){
          if(e.key === 'Escape'){ capturingRoute = null; hideToast(); return; }
          if(isModifierOnly(e)) return;
          const combo = comboFromEvent(e);
          if(!validCombo(combo)){
            showToast('Please include Ctrl/⌘/Alt + a key');
            return;
          }
          e.preventDefault();
          // Remove same combo from any other route
          for(const r in keymap){ if(equalCombo(keymap[r], combo)) delete keymap[r]; }
          keymap[capturingRoute] = combo;
          saveKeymap(keymap);
          renderShortcutRows();
          showToast(`Saved: ${formatCombo(combo)} → <strong>${capturingRoute}</strong>`);
          setTimeout(()=> hideToast(), 1200);
          capturingRoute = null;
          return;
        }

        // Normal mode: fire shortcuts
        if(editing) return;
        const pressed = comboFromEvent(e);
        for(const route in keymap){
          if(equalCombo(keymap[route], pressed)){
            e.preventDefault();
            activate(route);
            break;
          }
        }
      });

      // Reset All button
      document.getElementById('reset-all')?.addEventListener('click', ()=>{
        keymap = {};
        saveKeymap(keymap);
        renderShortcutRows();
        showToast('All shortcuts reset.');
        setTimeout(()=> hideToast(), 1000);
      });

      // Hash navigation
      window.addEventListener('hashchange', ()=>{
        const route = (location.hash || '').replace('#','') || 'profile';
        activate(route);
      });
    })();
  </script>
</body>
</html>
