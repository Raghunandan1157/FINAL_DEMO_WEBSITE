<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Branch Matrix (Print-Ready)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{ --ink:#0e1a2b; --muted:#6a7485; --grid:#e5e9f3; --line:#d6dbe6; --paper:#ffffff; --bg:#f5f7fb; }
  body{ margin:0; background:var(--bg); color:var(--ink); font-family: "Inter","Segoe UI",Roboto,system-ui,-apple-system,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif; }
  .wrap{max-width:1123px; margin:18px auto; padding:0 10px;}
  .sheet{ background:var(--paper); border:1px solid var(--line); border-radius:14px; padding:16px; }

  .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
  .header-left{ display:flex; align-items:center; gap:12px; min-width:0; }
  .logo{ width:56px; height:auto; display:block; object-fit:contain; cursor:pointer; } /* clickable logo */
  .header h1{ font-size:22px; font-weight:800; margin:0; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .badge{ font-size:12px; color:#334155; background:#f1f5ff; border:1px solid #dbe6ff; padding:.25rem .6rem; border-radius:999px; font-weight:700; }

  .toolbar{ display:flex; justify-content:flex-end; gap:10px; margin:10px 0 14px; position:sticky; top:8px; z-index:10; }
  .btn{ appearance:none; border:none; border-radius:10px; padding:10px 14px; font-weight:800; background:#111827; color:#fff; cursor:pointer; box-shadow:0 6px 16px rgba(0,0,0,.18); }
  .btn:active{ transform:translateY(1px); }

  .table-grid { border-collapse: separate; border-spacing: 0; width:100%; font-size:13px; }
  .table-grid th, .table-grid td { border-right: 1px solid var(--grid); border-bottom: 1px solid var(--grid); padding:.55rem .6rem; text-align:left; }
  .table-grid tr:first-child th, .table-grid tr:first-child td { border-top: 1px solid var(--grid); }
  .table-grid tr td:first-child, .table-grid tr th:first-child { border-left: 1px solid var(--grid); }
  .table-head{ background:#f8fbff; }

  @page { size: A4 landscape; margin: 10mm; }
  @media print{
    body{ background:#fff !important; }
    .toolbar{ display:none !important; }
    .wrap{ max-width:none; margin:0; padding:0; }
    .sheet{ border:none; border-radius:0; padding:0; }
    .table-grid thead{ display:table-header-group; }
    .table-grid tfoot{ display:table-footer-group; }
    .table-grid th, .table-grid td{ font-size:11.5px !important; padding:6px 8px !important; border-color:#d0d5dd !important; }
    .table-head{ background:#f8fafc !important; }
    .logo{ width:56px; height:auto; }
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="toolbar">
    <button class="btn" id="dlPrint" title="Print A4 (Landscape)">Print</button>
  </div>

  <div class="sheet">
    <div class="header">
      <div class="header-left">
        <img src="Official Logo.jpg" alt="Logo" class="logo" title="Go back" />
        <h1 id="hdrTitle">Branch (0000)</h1>
      </div>
      <span class="badge" id="matrixBadge">Preparing…</span>
    </div>

    <div class="overflow-auto">
      <table class="table-grid">
        <thead>
          <tr class="table-head">
            <th>Parameters</th>
            <th id="mxThB">Available Month</th>
            <th id="mxThC">Available Month</th>
            <th>Difference (C − B)</th>
          </tr>
        </thead>
        <tbody id="mxBody"></tbody>
      </table>
    </div>
    <p id="matrixStatus" class="mt-2 text-[12px] text-slate-600"></p>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SUPABASE_URL = "https://zovnmmdfthpbubrorsgh.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvdm5tbWRmdGhwYnVicm9yc2doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NzE3ODgsImV4cCI6MjA3NzE0Nzc4OH0.92BH2sjUOgkw6iSRj1_4gt0p3eThg3QT4VK-Q4EdmBE";
const TABLE_NAME   = "NLPL_FINAL_TABLE";
const ROW_LIMIT    = 5000;

/* ===== UTIL ===== */
const MONTHS_LONG = ['January','February','March','April','May','June','July','August','September','October','November','December'];
function getQueryParams(){
  const params = {}; const s = window.location.search; if(!s) return params;
  s.substring(1).split('&').forEach(p=>{ const [k,v] = p.split('='); params[decodeURIComponent(k)] = decodeURIComponent(v||''); });
  return params;
}
const params = getQueryParams();
const branchNameQP = params.name || params.branch || '';
const branchCodeQP = params.id || params.code || '0000';

const norm = (s)=> (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'');
const quoteIdent = (col)=> `"${String(col||'').replace(/"/g,'""')}"`;
const needsQuotes = (c)=> /[^a-z0-9_]/i.test(c);
const quoteForFilter = (c)=> needsQuotes(c) ? `"${String(c||'').replace(/"/g,'""')}"` : c;
const el = (sel)=> document.querySelector(sel);
const loadJSON = (k, d)=>{ try{ return JSON.parse(sessionStorage.getItem(k) ?? localStorage.getItem(k) ?? 'null') ?? d; }catch{ return d; } };

/* Keys used by your Month Tools */
const SKEY_COLS         = 'nlpl.columns';
const SKEY_BRANCH_COL   = 'nlpl.branch.col';
const SKEY_AVAIL_MONTHS = 'nlpl.avail.months';
const SKEY_MAP_A_ROWS   = 'nlpl.mappingsArows';

/* ===== Supabase ===== */
let supabaseClient = null;
function ensureClient(){ if(!supabaseClient){ supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } }

/* ===== Column helpers ===== */
function smartMatchTitleToColumn(desired, cols){
  if (!desired) return '';
  if (cols.includes(desired)) return desired;
  const nDesired = norm(desired);
  for (const c of cols){ if (norm(c) === nDesired) return c; }
  const tokens = (desired.toLowerCase().match(/[a-z0-9]+/g) || []);
  let best='', score=0;
  for (const c of cols){
    const lc=c.toLowerCase(); let s=0; tokens.forEach(t=>{ if(lc.includes(t)) s++; });
    if (s>score){ score=s; best=c; }
  }
  return score?best:'';
}
function pickMonthColumn(cols){
  const exact = cols.find(c => c.toLowerCase() === 'month'); if (exact) return exact;
  const cands = cols.filter(c=>{
    const n = norm(c);
    return /(^|[^a-z])month([^a-z]|$)/.test(n) || n.includes('mnth') || n==='mth' || n.endsWith('month') || n.startsWith('month');
  });
  if (cands.length) cands.sort((a,b)=>a.length-b.length);
  return cands[0] || '';
}
function pickBranchNameColumn(cols){
  const aliases = ['Branch Name','branch name','branch_name','branch','Branch','BranchName'];
  for (const a of aliases){ const pick = smartMatchTitleToColumn(a, cols); if (pick) return pick; }
  const nCols = cols.map(c=>({raw:c, n:norm(c)}));
  const hit = nCols.find(o=>o.n.includes('branch') && o.n.includes('name'));
  return hit ? hit.raw : '';
}

/* ===== Data fetch ===== */
async function fetchColumnsRobust(){
  ensureClient();
  try{
    const { data } = await supabaseClient.from(TABLE_NAME).select('*').limit(1);
    if (data && data.length){ return Object.keys(data[0]); }
  }catch(e){}
  return [];
}
async function computeAvailableMonths(cols){
  ensureClient();
  const monthCol = pickMonthColumn(cols);
  if (!monthCol) return [];
  const { data, error } = await supabaseClient.from(TABLE_NAME).select(quoteIdent(monthCol)).limit(ROW_LIMIT);
  if (error || !data) return [];
  const seen = new Set();
  const idxOf = (v)=>{
    if (typeof v === 'number'){ const n=Math.floor(v); return (n>=1&&n<=12)?n:null; }
    const s = String(v||'').toLowerCase();
    const map = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,july:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12};
    for (const k in map){ if (s.includes(k)) return map[k]; }
    const m = parseInt(s,10); return (!isNaN(m)&&m>=1&&m<=12)?m:null;
  };
  for (const row of data){ const idx = idxOf(row[monthCol]); if (idx!=null) seen.add(idx); }
  return Array.from(seen).sort((a,b)=>a-b).map(i => MONTHS_LONG[i-1]);
}

/* ===== Matrix UI ===== */
const DEFAULT_PARAMS = [
  'Disbursement Vol – Amt','Total POS','Regular Collection %','FTOD Addition – Accounts',
  'FTOD PAR Addition','Incremental 1+ PAR','Incremental NPA','Total NPA Collections – Accounts',
  'Total NPA Collections – Amount','Total Collections – Accounts','Total Collections – Amount','Branch Code'
];
function fillMatrixSkeleton(paramCols){
  const body = document.getElementById('mxBody'); body.innerHTML = '';
  for (let i=0;i<12;i++){
    const label = paramCols[i] || '—';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${label}</td>
      <td id="mxB_${i+1}"><span class="text-slate-400">—</span></td>
      <td id="mxC_${i+1}"><span class="text-slate-400">—</span></td>
      <td id="mxD_${i+1}"><span class="text-slate-400">—</span></td>`;
    body.appendChild(tr);
  }
}

/* ===== Formatting helpers (Indian system) ===== */
function isRegularCollectionLabel(label){
  const s = (label || '').toLowerCase();
  return s.includes('regular') && s.includes('collection') || s.includes('collection efficiency') || s === 'ce';
}
function isIdentifierLabel(label){
  const s = (label || '').toLowerCase();
  return s.includes('code') || s.includes(' id') || s.endsWith(' id') || s.includes('account no') || s.includes('mobile') || s.includes('phone');
}
function withPercent(val){
  if (val === null || val === undefined || val === '') return val;
  const str = String(val).trim();
  if (str.endsWith('%')) return str;
  const n = Number(str.replace(/,/g,'')); 
  if (!isNaN(n)) return n.toFixed(2) + ' %';
  return str + ' %';
}
function toNumber(v){
  if (v === null || v === undefined || v === '') return NaN;
  const n = parseFloat(String(v).replace(/[^0-9.\-]/g,''));
  return isNaN(n) ? NaN : n;
}
function fmtNumIndian(n){
  if (!isFinite(n)) return '—';
  const isInt = Math.abs(n % 1) < 1e-9;
  return isInt
    ? Number(Math.round(n)).toLocaleString('en-IN')
    : Number(n).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function fmtIndianMaybe(v){
  const n = toNumber(v);
  if (isFinite(n)) return fmtNumIndian(n);
  return v;
}

/* Reverse-logic rows for Difference color:
   - FTOD Addition – Accounts
   - FTOD PAR Addition
   - Incremental 1+ PAR
   - Incremental NPA
*/
function isReverseDiffLabel(label){
  const s = (label || '').toLowerCase();
  const n = s.replace(/[\u2013\u2014]/g,'-');
  if (n.includes('ftod') && n.includes('addition') && (n.includes('account') || n.includes('accounts'))) return true;
  if (n.includes('ftod') && n.includes('par') && n.includes('addition')) return true;
  if (n.includes('incremental') && n.includes('par') && (n.includes('1+') || n.includes('1 +') || n.includes('1 plus') || n.includes('1par'))) return true;
  if (n.includes('incremental') && n.includes('npa')) return true;
  return false;
}

/* ===== Main fill ===== */
async function refreshMatrix(){
  const badge = document.getElementById('matrixBadge');
  const status = document.getElementById('matrixStatus');
  const thB = document.getElementById('mxThB'); const thC = document.getElementById('mxThC');

  try{
    badge.textContent = 'Preparing…'; status.textContent = '';

    ensureClient();
    let cols = loadJSON(SKEY_COLS, null);
    if (!cols || !cols.length){ cols = await fetchColumnsRobust(); }

    if (!cols || !cols.length){
      badge.textContent = 'No columns'; status.textContent = 'Could not discover columns.';
      fillMatrixSkeleton(new Array(12).fill('')); return;
    }

    // Months (prefer from Month Tools session)
    let months = loadJSON(SKEY_AVAIL_MONTHS, null);
    if (!months || !months.length){ months = await computeAvailableMonths(cols); }
    const mB = months?.[0] || 'Available Month';
    const mC = months?.[1] || 'Available Month';
    thB.textContent = mB; thC.textContent = mC;

    // Parameters (prefer session mapping; fallback to defaults)
    let paramCols = loadJSON(SKEY_MAP_A_ROWS, null);
    if (!paramCols || !paramCols.length){
      paramCols = DEFAULT_PARAMS.map(desired => smartMatchTitleToColumn(desired, cols) || desired);
    }
    fillMatrixSkeleton(paramCols);

    // Branch
    const branchVal = (branchNameQP || '').trim();
    if (!branchVal){
      badge.textContent = 'Waiting for branch…';
      status.textContent = 'Pass ?name=YourBranch&id=0000 in URL to load data.';
      return;
    }

    // Title & badge
    el("#hdrTitle").textContent = `${branchVal} (${branchCodeQP})`;

    const branchColSaved = loadJSON(SKEY_BRANCH_COL, '') || '';
    const branchCol = branchColSaved || pickBranchNameColumn(cols);
    const monthCol  = pickMonthColumn(cols);
    if (!branchCol || !monthCol){
      badge.textContent = 'Missing mapping';
      status.textContent = `Could not identify ${!monthCol?'Month':'Branch Name'} column.`; return;
    }

    // Month index
    const monthIndexFromValue = (v)=>{
      if (typeof v === 'number'){ const n=Math.floor(v); return (n>=1&&n<=12)?n:null; }
      const s = String(v||'').toLowerCase();
      const map = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,july:7,jul:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12};
      for (const k in map){ if (s.includes(k)) return map[k]; }
      const d = new Date(s); if (!isNaN(d.getTime())) return d.getMonth()+1;
      const m = parseInt(s,10); return (!isNaN(m)&&m>=1&&m<=12)?m:null;
    };
    const miB = monthIndexFromValue(mB), miC = monthIndexFromValue(mC);
    if (!miB && !miC){
      badge.textContent = 'Pick months';
      status.textContent = 'Month Tools did not provide months yet (need two).'; return;
    }

    const metricsUnique = Array.from(new Set(paramCols.filter(Boolean)));
    if (!metricsUnique.length){
      badge.textContent = 'Pick parameters';
      status.textContent = 'No Parameter columns could be mapped.'; return;
    }

    const selectList = [quoteIdent(monthCol), quoteIdent(branchCol), ...metricsUnique.map(quoteIdent)].join(',');
    badge.textContent = 'Fetching…';

    const { data, error } = await supabaseClient.from(TABLE_NAME)
      .select(selectList)
      .eq(quoteForFilter(branchCol), branchVal)
      .limit(ROW_LIMIT);

    if (error){ throw error; }

    // Group by month index (last row per month wins)
    const byMonth = new Map();
    for (const row of (data||[])){
      const idx = monthIndexFromValue(row[monthCol]);
      if (idx!=null) byMonth.set(idx, row);
    }

    for (let i=0;i<12;i++){
      const label = paramCols[i];
      const metric = label; // column name or fallback label
      const cellB = document.getElementById(`mxB_${i+1}`);
      const cellC = document.getElementById(`mxC_${i+1}`);
      const cellD = document.getElementById(`mxD_${i+1}`);

      const vb = (metric && miB && byMonth.get(miB)) ? byMonth.get(miB)[metric] : null;
      const vc = (metric && miC && byMonth.get(miC)) ? byMonth.get(miC)[metric] : null;

      // Display: percentages keep %, identifiers untouched, else Indian commas
      const isPct = isRegularCollectionLabel(label);
      const isId  = isIdentifierLabel(label);

      const vbDisp = (vb===null || vb===undefined || vb==='') ? null
                     : isPct ? withPercent(vb)
                     : isId  ? String(vb)
                     : fmtIndianMaybe(vb);

      const vcDisp = (vc===null || vc===undefined || vc==='') ? null
                     : isPct ? withPercent(vc)
                     : isId  ? String(vc)
                     : fmtIndianMaybe(vc);

      cellB.innerHTML = vbDisp == null ? '<span class="text-slate-400">—</span>' : String(vbDisp);
      cellC.innerHTML = vcDisp == null ? '<span class="text-slate-400">—</span>' : String(vcDisp);

      // Difference (C - B) with reverse color logic for specific rows, Indian format for numbers
      const nb = toNumber(vb);
      const nc = toNumber(vc);
      let diffSpan = '<span class="text-slate-400">—</span>';
      if (isFinite(nb) && isFinite(nc)){
        const diff = nc - nb;
        const pretty = isPct ? (withPercent(diff)) : fmtNumIndian(diff);
        const reverse = isReverseDiffLabel(label);
        const cls = reverse
          ? (diff > 0 ? 'text-red-600 font-semibold' : diff < 0 ? 'text-green-600 font-semibold' : 'text-slate-600')
          : (diff > 0 ? 'text-green-600 font-semibold' : diff < 0 ? 'text-red-600 font-semibold' : 'text-slate-600');
        diffSpan = `<span class="${cls}">${pretty}</span>`;
      }
      cellD.innerHTML = diffSpan;
    }

    // Badge text
    badge.textContent = `live data - ${branchVal}`;
    status.textContent = ''; // no footer line

  }catch(e){
    document.getElementById('matrixBadge').textContent = 'Error';
    document.getElementById('matrixStatus').textContent = (e?.message || String(e));
  }
}

/* ===== Boot ===== */
document.getElementById("dlPrint").addEventListener("click", () => window.print());
window.addEventListener("load", ()=> refreshMatrix());
window.addEventListener("focus", ()=> refreshMatrix());

// Click logo to go back (with safe fallback)
window.addEventListener("load", () => {
  const logo = document.querySelector('.logo');
  if (!logo) return;
  logo.addEventListener('click', () => {
    if (window.history.length > 1) {
      window.history.back();
    } else if (document.referrer) {
      window.location.href = document.referrer;
    } else {
      // fallback to current folder root
      window.location.href = './';
    }
  });
});
</script>
</body>
</html>
