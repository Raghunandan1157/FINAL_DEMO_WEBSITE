<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>NavaChetana Livelihoods ‚Äì Dashboard</title>

  <!-- Fonts & libs -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/odometer.js/0.4.8/themes/odometer-theme-default.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/odometer.js/0.4.8/odometer.min.js"></script>

  <style>
    :root{
      --brand:#1f3a93;
      --text-primary:#202124;
      --text-secondary:#5f6368;
      --card-bg:#ffffff;
      --page-bg:#f7f9fc;
      --border-radius:.75rem;
      --box-shadow:0 2px 6px rgba(0,0,0,.08);
      --blink-bg:#fff7d5;
      --up-bg:#2e7d32;
      --down-bg:#c62828;

      /* matrix vars */
      --ink:#0e1a2b; --muted:#6a7485; --grid:#e5e9f3; --line:#d6dbe6;
      --paper:#ffffff; --bg:#f7f9fc; --good:#16a34a; --bad:#dc2626;
    }

    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;color:var(--text-primary);background:var(--page-bg)}

    /* Header */
    header{
      background:var(--card-bg);
      padding:1rem 1.5rem;
      display:flex;justify-content:space-between;align-items:center;
      box-shadow:0 2px 4px rgba(0,0,0,.05);
      position:sticky;top:0;z-index:10;
    }
    .logo-area{display:flex;align-items:center;cursor:pointer}
    .logo-img{
      width:40px;height:40px;border-radius:.5rem;object-fit:cover;
      box-shadow:0 1px 2px rgba(0,0,0,.15);margin-right:.75rem;
    }
    .logo-text{display:flex;flex-direction:column;line-height:1.2}
    .logo-text .name{font-weight:600;font-size:1.05rem}
    .logo-text .tagline{font-size:.75rem;color:var(--text-secondary)}

    /* Layout */
    #dashboard-container{
      display:flex;flex-direction:row;align-items:flex-start;
      max-width:960px;margin:0 auto;padding:2rem 1rem 3rem;
    }

    /* Sidebar */
    #side-nav{width:180px;margin-right:1.5rem;display:flex;flex-direction:column;gap:.75rem}
    .side-nav-btn{
      background:#0d2a59;color:#fff;padding:.8rem 1rem;border:none;border-radius:var(--border-radius);
      font-weight:600;font-size:.9rem;cursor:pointer;transition:.2s ease;
    }
    .side-nav-btn:hover{background:#183f84;transform:translateY(-2px)}

    /* Content */
    #content-area{flex-grow:1;position:relative}
    #content-area h1{font-size:1.6rem;margin:0 0 1.5rem;text-align:center;font-weight:600;color:#1a1a1a}

    .cards{display:grid;gap:1.25rem;grid-template-columns:repeat(3,1fr)}
    .card{
      background:var(--card-bg);border-radius:var(--border-radius);
      padding:1rem 1.25rem 1.25rem;box-shadow:var(--box-shadow);
      display:flex;flex-direction:column;position:relative;min-height:130px;
    }
    .card-icon{width:48px;height:48px;border-radius:.8rem;display:flex;align-items:center;justify-content:center;margin-bottom:.75rem;color:#fff}
    .card-icon svg{width:24px;height:24px;fill:#fff}
    .label{font-size:.8rem;font-weight:500;color:var(--text-secondary);margin-bottom:.3rem;display:flex;align-items:center;gap:.5rem}
    .value{font-size:1.45rem;font-weight:600;display:flex;align-items:baseline;flex-wrap:wrap;font-family:"Roboto Mono",Menlo,Consolas,monospace;font-variant-numeric:tabular-nums;line-height:1.2}
    .value .currency{margin-right:2px;font-size:1rem;font-weight:500;color:#1a1a1a}
    .odometer{display:inline-block;line-height:1.2;font-size:1.45rem;font-weight:600;color:#1a1a1a}

    .change-indicator{
      position:absolute;top:.6rem;right:.6rem;padding:.15rem .45rem;border-radius:.4rem;
      font-size:.7rem;font-weight:600;color:#fff;line-height:1.2;opacity:0;transform:translateY(-6px) scale(.9);
      transition:opacity .15s ease,transform .15s ease;pointer-events:none;white-space:nowrap;
    }
    .change-up{background:var(--up-bg)} .change-down{background:var(--down-bg)}
    .change-indicator.show{opacity:1;transform:translateY(0) scale(1)}

    @keyframes blinkCard{0%,100%{background:var(--card-bg)}40%{background:var(--blink-bg)}}
    .blink{animation:blinkCard 1s ease-out}
    @media (prefers-reduced-motion: reduce){ .blink{animation:none} .change-indicator{transition:none} }

    .last-updated{margin-top:1.5rem;font-size:.8rem;color:var(--text-secondary);display:flex;align-items:center;flex-wrap:wrap;line-height:1.4}
    .last-updated svg{width:16px;height:16px;margin-right:.4rem;fill:var(--text-secondary)}

    /* Matrix wrapper (replaces old Financial Overview) */
    .matrix{
      margin-top:2rem;background:var(--card-bg);padding:1.25rem 1.5rem;border-radius:var(--border-radius);box-shadow:var(--box-shadow);
      color:var(--ink);
    }
    .mx-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .mx-title{font-size:1.05rem;font-weight:700;margin:0}
    .mx-badge{
      font-size:.75rem;color:#334155;background:#f1f5ff;border:1px solid #dbe6ff;padding:.25rem .6rem;border-radius:999px;font-weight:700;
      display:inline-flex;align-items:center;gap:.4rem;white-space:nowrap;
    }
    .mx-btn{appearance:none;border:none;border-radius:10px;padding:.45rem .7rem;font-weight:800;background:#111827;color:#fff;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.18)}
    .mx-btn:active{transform:translateY(1px)}

    .table-grid { border-collapse: separate; border-spacing: 0; width:100%; font-size:13px; }
    .table-grid th, .table-grid td { border-right: 1px solid var(--grid); border-bottom: 1px solid var(--grid); padding:.55rem .6rem; text-align:left; }
    .table-grid tr:first-child th, .table-grid tr:first-child td { border-top: 1px solid var(--grid); }
    .table-grid tr td:first-child, .table-grid tr th:first-child { border-left: 1px solid var(--grid); }
    .table-head{ background:#f8fbff; }
    .status-line{margin-top:.5rem;font-size:.78rem;color:#475569}

    /* Skeleton shimmer */
    .skl{position:relative;overflow:hidden;border-radius:6px;background:#eef2f7;min-height:12px}
    .skl::after{
      content:"";position:absolute;inset:0;transform:translateX(-100%);
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.8),transparent);
      animation:shimmer 1.15s linear infinite;
    }
    @keyframes shimmer{100%{transform:translateX(100%)}}

    .spin{position:relative;padding-left:18px}
    .spin::before{
      content:"";position:absolute;left:0;top:50%;width:12px;height:12px;margin-top:-6px;border-radius:50%;
      border:2px solid #90a4ae;border-top-color:#1e293b;animation:rot 1s linear infinite;
    }
    @keyframes rot{to{transform:rotate(360deg)}}

    @media (max-width:900px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:600px){
      #dashboard-container{flex-direction:column}
      #side-nav{flex-direction:row;justify-content:center;width:100%;margin-bottom:1rem}
      .side-nav-btn{flex:1;text-align:center}
      .cards{grid-template-columns:1fr}
    }

    footer{text-align:center;color:var(--text-secondary);font-size:.85rem;padding:1.25rem 0 2rem}

    /* Overlays */
    .overlay{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;background:var(--page-bg);padding:3rem 2rem;z-index:1000;overflow-y:auto}
    .overlay-title{font-size:2rem;font-weight:700;margin-bottom:1.25rem;color:#1a1a1a;text-align:center;width:100%}
    .overlay-actions{display:flex;align-items:center;gap:.75rem;width:100%;max-width:700px;margin-bottom:1.5rem}
    .overlay-search-input{flex:1;padding:.7rem 1rem;border-radius:.5rem;border:1px solid #ccc;font-size:1rem}
    .overlay-btn{padding:.7rem 1.1rem;background:var(--brand);color:#fff;border:none;border-radius:.5rem;font-weight:600;cursor:pointer}
    .overlay-close{background:#0d2a59}
    .overlay-grid{width:100%;max-width:1100px;display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .overlay-item{background:#0d2a59;color:#fff;padding:1rem 1.25rem;border-radius:1rem;cursor:pointer;transition:transform .15s ease,box-shadow .15s ease,background-color .15s ease;box-shadow:0 4px 10px rgba(0,0,0,.12);display:flex;flex-direction:column;gap:.25rem}
    .overlay-item:hover{background:#183f84;transform:translateY(-3px);box-shadow:0 6px 12px rgba(0,0,0,.15)}

    /* ===== PRINT: only logo + matrix title + table ===== */
    @media print{
      @page { size: A4 landscape; margin: 10mm; }
      body{ background:#fff; }
      /* Hide everything, then selectively reveal */
      body *{ visibility:hidden !important; }
      header, header *{ visibility:visible !important; }
      #matrixWrap, #matrixWrap *{ visibility:visible !important; }
      /* Clean up: don't show cards, badges, buttons, footer, overlays, status text */
      .cards, .last-updated, footer, .overlay, .overlay *{ display:none !important; }
      .mx-badge, .mx-btn, .status-line{ display:none !important; }
      /* Make header static in print */
      header{ position:static !important; box-shadow:none !important; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-area" id="logoArea" title="Go back">
      <!-- Uses your local file -->
      <img class="logo-img" src="Official logo.jpg" alt="NavaChetana Livelihoods logo" />
      <div class="logo-text">
        <span class="name">NavaChetana Livelihoods</span>
        <span class="tagline">Dashboard</span>
      </div>
    </div>
  </header>

  <div id="dashboard-container">
    <!-- Sidebar -->
    <nav id="side-nav">
      <button class="side-nav-btn" id="btn-region">Region</button>
      <button class="side-nav-btn" id="btn-branch">Branch</button>
    </nav>

    <!-- Main content -->
    <div id="content-area">
      <h1>Dashboard</h1>

      <!-- KPI cards stay as-is -->
      <div class="cards">
        <!-- TOTAL OUTSTANDING -->
        <div class="card" data-key="totalPAR">
          <div class="card-icon" style="background:#ef5350">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M1 21h22L12 2 1 21z"/><path d="M13 16h-2v2h2v-2zm0-6h-2v4h2V10z" fill="#fff"/></svg>
          </div>
          <span class="label">TOTAL OUTSTANDING</span>
          <span class="value"><span class="currency">‚Çπ</span><span class="odometer" id="num-totalPAR">0</span></span>
        </div>

        <!-- 1+ PAR -->
        <div class="card" data-key="onePlusPAR">
          <div class="card-icon" style="background:#fb8c00">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M1 21h22L12 2 1 21z"/><path d="M13 16h-2v2h2v-2zm0-6h-2v4h2V10z" fill="#fff"/></svg>
          </div>
          <span class="label">1+ PAR</span>
          <span class="value"><span class="currency">‚Çπ</span><span class="odometer" id="num-onePlusPAR">0</span></span>
        </div>

        <!-- NPA PAR -->
        <div class="card" data-key="npaCollection">
          <div class="card-icon" style="background:#42a5f5">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="16" height="16" rx="3" ry="3" fill="#fff" fill-opacity="0.2"/><rect x="4" y="4" width="16" height="16" rx="3" ry="3" stroke="#fff" stroke-width="1" fill="none"/></svg>
          </div>
          <span class="label">NPA PAR</span>
          <span class="value"><span class="currency">‚Çπ</span><span class="odometer" id="num-npaCollection">0</span></span>
        </div>

        <!-- NPA Collection -->
        <div class="card" data-key="collection">
          <div class="card-icon" style="background:#66bb6a">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 3c-1.2 0-2.2.7-2.7 1.7l-1 2C7.5 7.3 7 8.1 7 9v1c0 .3.1.5.2.7C6.2 11.7 6 12.8 6 14c0 4.4 3.6 8 8 8s8-3.6 8-8c0-1.2-.2-2.3-.7-3.3.1-.2.1-.4.1-.7V9c0-.9-.5-1.7-1.3-2.3l-1-2C14.2 3.7 13.2 3 12 3zm0 2c.3 0 .5.2.7.5l.3.5-.3.5c-.2.3-.4.5-.7.5s-.5-.2-.7-.5l-.3-.5.3-.5c.2-.3.4-.5.7-.5zm0 6c1.7 0 3 1.3 3 3s-1.3 3-3 3-3-1.3-3-3 1.3-3 3-3z" fill="#fff"/></svg>
          </div>
          <span class="label">NPA COLLECTION</span>
          <span class="value"><span class="currency">‚Çπ</span><span class="odometer" id="num-collection">0</span></span>
        </div>

        <!-- Disbursement Status -->
        <div class="card" data-key="dbStatus">
          <div class="card-icon" style="background:#ab47bc">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><ellipse cx="12" cy="5" rx="7" ry="3" fill="#fff" fill-opacity="0.2"/><path d="M5 5v14a7 3 0 0014 0V5" fill="none" stroke="#fff" stroke-width="1.2" stroke-linejoin="round"/></svg>
          </div>
          <span class="label">DISBURSEMENT STATUS</span>
          <span class="value"><span class="currency">‚Çπ</span><span class="odometer" id="num-dbStatus">0</span></span>
        </div>

        <!-- FTOD -->
        <div class="card" data-key="ftodStatus">
          <div class="card-icon" style="background:#5c6bc0">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 6a6 6 0 100 12 6 6 0 000-12zm1 6V9h-2v5h5v-2h-3z" fill="#fff"/></svg>
          </div>
          <span class="label">FTOD</span>
          <span class="value"><span class="currency">‚Çπ</span><span class="odometer" id="num-ftodStatus">0</span></span>
        </div>
      </div>

      <div class="last-updated">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 11h5v-2h-7V6h-2v7h4v2z"/></svg>
        <span id="lastUpdated">Last updated on ‚Ä¶</span>
      </div>

      <!-- üîÅ Company Matrix (replaces old Financial Overview box) -->
      <div class="matrix" id="matrixWrap">
        <div class="mx-header">
          <h2 class="mx-title" id="mxTitle">NLPL - Oct-25 Month Highlights ( Amount in Cr)</h2>
          <div style="display:flex;align-items:center;gap:.5rem">
            <button class="mx-btn" id="btnPrint" title="Print A4 (Landscape)">Print</button>
            <span class="mx-badge spin" id="hdrBadge">Loading‚Ä¶</span>
          </div>
        </div>

        <div class="overflow">
          <table class="table-grid" id="finalTable" aria-live="polite">
            <thead>
              <tr class="table-head">
                <th>Parameters</th>
                <th id="thB">Prev Month</th>
                <th id="thC">Current Month</th>
                <th>Difference</th>
              </tr>
            </thead>
            <tbody id="finalBody"></tbody>
          </table>
        </div>
        <p id="statusLine" class="status-line"></p>
      </div>
    </div>
  </div>

  <footer>¬©Ô∏è <span id="footerYear"></span> NavaChetana Livelihoods</footer>

  <!-- Branch overlay -->
  <div id="overlay-branch" class="overlay" aria-modal="true" role="dialog">
    <div class="overlay-title" id="overlay-title-branch">BRANCH</div>
    <div class="overlay-actions">
      <input type="text" id="overlay-search-input-branch" class="overlay-search-input" placeholder="Search name or code‚Ä¶" aria-label="Search branch" />
      <button id="overlay-search-button-branch" class="overlay-btn">Search</button>
      <button id="overlay-close-branch" class="overlay-btn overlay-close" title="Close">Close</button>
    </div>
    <div id="overlay-grid-branch" class="overlay-grid"></div>
  </div>

  <!-- Region overlay -->
  <div id="overlay-region" class="overlay" aria-modal="true" role="dialog">
    <div class="overlay-title" id="overlay-title-region">REGION (0)</div>
    <div class="overlay-actions">
      <input type="text" id="overlay-search-input-region" class="overlay-search-input" placeholder="Search region‚Ä¶" aria-label="Search region" />
      <button id="overlay-search-button-region" class="overlay-btn">Search</button>
      <button id="overlay-close-region" class="overlay-btn overlay-close" title="Close">Close</button>
    </div>
    <div id="overlay-grid-region" class="overlay-grid"></div>
  </div>

  <!-- Metrics logic (cards + header behaviours) -->
  <script>
    (function(){
      const SUPABASE_URL = 'https://zovnmmdfthpbubrorsgh.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvdm5tbWRmdGhwYnVicm9yc2doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NzE3ODgsImV4cCI6MjA3NzE0Nzc4OH0.92BH2sjUOgkw6iSRj1_4gt0p3eThg3QT4VK-Q4EdmBE';
      const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      function metricNameToKey(name){
        return {
          'total_par':'totalPAR','one_plus_par':'onePlusPAR','npa_collection':'npaCollection',
          'collection':'collection','db_status':'dbStatus','ftod_status':'ftodStatus'
        }[name] || null;
      }

      const defaultValues = {
        totalPAR:10000000, onePlusPAR:2500000, npaCollection:3200000,
        collection:5000000, dbStatus:4800000, ftodStatus:1500000,
        lastUpdated:'October 27, 2025 ‚Äì 12:30 PM'
      };

      const prevValues = { totalPAR:null, onePlusPAR:null, npaCollection:null, collection:null, dbStatus:null, ftodStatus:null };
      const odometers = {};
      const lastUpdatedElem = document.getElementById('lastUpdated');
      const footerYear = document.getElementById('footerYear');

      function formatCurrencyVal(n){
        return n.toLocaleString('en-IN',{style:'currency',currency:'INR',minimumFractionDigits:0,maximumFractionDigits:0});
      }

      function updateOdometer(key,val){
        const el = document.getElementById('num-'+key);
        if(!odometers[key]){
          odometers[key] = new Odometer({ el, value: val, format:'(,ddd)'});
        }else{
          odometers[key].update(val);
        }
      }

      function animateChange(key,oldVal,newVal){
        if(oldVal===null) return; // no flash on first paint
        const card = document.querySelector('.card[data-key="'+key+'"]');
        const diff = newVal - oldVal;
        let indicator = card.querySelector('.change-indicator');
        if(!indicator){
          indicator = document.createElement('span');
          indicator.classList.add('change-indicator');
          card.appendChild(indicator);
        }
        if(diff>0){ indicator.classList.remove('change-down'); indicator.classList.add('change-up'); indicator.textContent = '‚ñ≤ '+formatCurrencyVal(diff); }
        else if(diff<0){ indicator.classList.remove('change-up'); indicator.classList.add('change-down'); indicator.textContent = '‚ñº '+formatCurrencyVal(Math.abs(diff)); }
        else{ indicator.textContent = ''; }
        indicator.classList.add('show'); card.classList.add('blink');
        setTimeout(()=>{ indicator.classList.remove('show'); card.classList.remove('blink'); }, 900);
      }

      function istNowString(){
        try{
          const now = new Date();
          const fmt = new Intl.DateTimeFormat('en-IN', { timeZone:'Asia/Kolkata', dateStyle:'medium', timeStyle:'short' });
          return fmt.format(now);
        }catch{ return new Date().toLocaleString(); }
      }

      async function fetchData(){
        try{
          const { data, error } = await supabaseClient.from('financial_metrics').select('metric_name, metric_value');
          if(error) throw error;

          const values = { ...defaultValues };
          data.forEach(row => { const k = metricNameToKey(row.metric_name); if(k) values[k] = Number(row.metric_value) || 0; });

          Object.keys(values).forEach(k => { if(k!=='lastUpdated') localStorage.setItem(k, String(values[k])); });
          const stamp = 'Live ‚Ä¢ ' + istNowString();
          values.lastUpdated = stamp;
          localStorage.setItem('lastUpdated', stamp);

          return values;
        }catch(e){
          const result = {};
          Object.keys(defaultValues).forEach(k => {
            const stored = localStorage.getItem(k);
            if(stored!==null && stored!==undefined){
              result[k] = (k==='lastUpdated') ? stored : (isNaN(parseInt(stored,10)) ? defaultValues[k] : parseInt(stored,10));
            } else { result[k] = defaultValues[k]; }
          });
          return result;
        }
      }

      async function render(){
        const data = await fetchData();
        ['totalPAR','onePlusPAR','npaCollection','collection','dbStatus','ftodStatus'].forEach(key=>{
          const newVal = data[key], oldVal = prevValues[key];
          animateChange(key,oldVal,newVal);
          updateOdometer(key,newVal);
          prevValues[key] = newVal;
        });

        lastUpdatedElem.textContent = localStorage.getItem('lastUpdated') || data.lastUpdated;
        footerYear.textContent = new Date().getFullYear();
      }

      function withinBusinessHours(){
        const now = new Date();
        const parts = new Intl.DateTimeFormat('en-US',{ timeZone:'Asia/Kolkata', hour12:false, hour:'numeric' }).formatToParts(now);
        const hour = parseInt(parts.find(p=>p.type==='hour').value,10);
        return (hour>=6 && hour<20);
      }

      setInterval(()=>{ if(withinBusinessHours()) render(); }, 1000);

      supabaseClient.channel('financial_metrics_updates')
        .on('postgres_changes', { event:'*', schema:'public', table:'financial_metrics' }, () => render())
        .subscribe(()=>{});

      render();

      // Header logo ‚Üí go back
      document.getElementById('logoArea').addEventListener('click', () => {
        if (window.history.length > 1) history.back();
      });

      // Expose client for matrix script via window (safe for this page)
      window._nlpl_sb = supabaseClient;
    })();
  </script>

  <!-- Company Matrix script (with skeleton while loading) -->
  <script>
    (function(){
      /* ====== SUPABASE CONFIG ====== */
      const SUPABASE_URL = "https://zovnmmdfthpbubrorsgh.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpvdm5tbWRmdGhwYnVicm9yc2doIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NzE3ODgsImV4cCI6MjA3NzE0Nzc4OH0.92BH2sjUOgkw6iSRj1_4gt0p3eThg3QT4VK-Q4EdmBE";
      const TABLE_NAME   = "NLPL_FINAL_TABLE";
      const ROW_LIMIT    = 50000;

      // Use the already-created client if present (from the KPI block)
      const sb = window._nlpl_sb || window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      /* ====== UTIL ====== */
      const MONTHS_LONG = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      const el = (sel)=> document.querySelector(sel);
      function norm(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,''); }
      function toNumber(v){ if (v===null || v===undefined || v==='') return NaN; const n=parseFloat(String(v).replace(/[^0-9.\-]/g,'')); return isNaN(n)?NaN:n; }
      function fmtNumIndian(n){
        if (!isFinite(n)) return '‚Äî';
        const isInt = Math.abs(n % 1) < 1e-9;
        return isInt
          ? Number(Math.round(n)).toLocaleString('en-IN')
          : Number(n).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
      function withPercent(val){
        if (val === null || val === undefined) return '‚Äî';
        const s = String(val).trim(); if (s==='') return '‚Äî';
        if (s.endsWith('%')) return s;
        const n = Number(s.replace(/,/g,'')); 
        return !isNaN(n)? (n.toFixed(2)+'%') : s+'%';
      }
      function isRegularCollectionLabel(label){
        const s=(label||'').toLowerCase();
        return s.includes('regular') && s.includes('collection') || s.includes('collection efficiency') || s.trim()==='ce';
      }
      function isIdentifierLabel(label){
        const s=(label||'').toLowerCase();
        return s.includes('code') || s.includes(' id') || s.endsWith(' id') || s.includes('account no') || s.includes('mobile') || s.includes('phone');
      }
      function isReverseDiffLabel(label){
        const s = (label || '').toLowerCase().replace(/[\u2013\u2014]/g,'-');
        if (s.includes('ftod') && s.includes('addition') && (s.includes('account') || s.includes('accounts'))) return true;
        if (s.includes('ftod') && s.includes('par') && s.includes('addition')) return true;
        if (s.includes('incremental') && s.includes('par') && (s.includes('1+')||s.includes('1 +')||s.includes('1 plus')||s.includes('1par'))) return true;
        if (s.includes('incremental') && s.includes('npa')) return true;
        return false;
      }

      /* Default rows (no Branch Code row; % row averages across branches) */
      const DEFAULT_PARAMS = [
        'Disbursement Vol ‚Äì Amt','Total POS','Regular Collection %','FTOD Addition ‚Äì Accounts',
        'FTOD PAR Addition','Incremental 1+ PAR','Incremental NPA','Total NPA Collections ‚Äì Accounts',
        'Total NPA Collections ‚Äì Amount','Total Collections ‚Äì Accounts','Total Collections ‚Äì Amount'
      ];

      /* ====== Column helpers ====== */
      function smartMatchTitleToColumn(desired, cols){
        if (!desired) return '';
        if (cols.includes(desired)) return desired;
        const nDesired = norm(desired);
        for (const c of cols){ if (norm(c) === nDesired) return c; }
        const tokens = (desired.toLowerCase().match(/[a-z0-9]+/g) || []);
        let best='', score=0;
        for (const c of cols){
          const lc=c.toLowerCase(); let s=0; tokens.forEach(t=>{ if(lc.includes(t)) s++; });
          if (s>score){ score=s; best=c; }
        }
        return score?best:'';
      }
      function pickMonthColumn(cols){
        const exact = cols.find(c => c.toLowerCase() === 'month'); if (exact) return exact;
        const cands = cols.filter(c=>{
          const n = norm(c);
          return /(^|[^a-z])month([^a-z]|$)/.test(n) || n.includes('mnth') || n==='mth' || n.endsWith('month') || n.startsWith('month');
        });
        if (cands.length) cands.sort((a,b)=>a.length-b.length);
        return cands[0] || '';
      }
      function pickBranchNameColumn(cols){
        const aliases=['Branch Name','branch name','branch_name','branch','Branch','BranchName'];
        for (const a of aliases){ const pick=smartMatchTitleToColumn(a, cols); if (pick) return pick; }
        const nCols = cols.map(c=>({raw:c, n:norm(c)}));
        const hit = nCols.find(o=>o.n.includes('branch') && o.n.includes('name'));
        return hit?hit.raw:'';
      }
      function monthIndexFromValue(v){
        if (typeof v === 'number'){ const n=Math.floor(v); return (n>=1&&n<=12)?n:null; }
        const s = String(v||'').toLowerCase();
        const map = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,july:7,jul:7,aug:8,sep:9,sept:9,oct:10,nov:11,dec:12};
        for (const k in map){ if (s.includes(k)) return map[k]; }
        const d = new Date(s); if (!isNaN(d.getTime())) return d.getMonth()+1;
        const m = parseInt(s,10); return (!isNaN(m)&&m>=1&&m<=12)?m:null;
      }

      /* ====== Data fetch ====== */
      async function fetchColumns(){
        try{
          const { data } = await sb.from(TABLE_NAME).select('*').limit(1);
          if (data && data.length){ return Object.keys(data[0]); }
        }catch{}
        return [];
      }
      async function computeAvailableMonths(cols){
        const monthCol = pickMonthColumn(cols);
        if (!monthCol) return [];
        const { data, error } = await sb.from(TABLE_NAME).select(`"${monthCol}"`).limit(ROW_LIMIT);
        if (error || !data) return [];
        const seen = new Set();
        for (const row of data){ const idx = monthIndexFromValue(row[monthCol]); if (idx!=null) seen.add(idx); }
        return Array.from(seen).sort((a,b)=>a-b).map(i => MONTHS_LONG[i-1]);
      }
      async function loadRowsForBranches(branchCol, monthCol, metrics, branches){
        const selectList = [`"${monthCol}"`, `"${branchCol}"`, ...metrics.map(m=>`"${m}"`)].join(',');
        try{
          const { data, error } = await sb.from(TABLE_NAME).select(selectList).in(branchCol, branches).limit(ROW_LIMIT);
          if (error) throw error;
          return data || [];
        }catch(e){
          // fallback: per-branch queries
          const chunks = [];
          for (const b of branches){
            const { data } = await sb.from(TABLE_NAME).select(selectList).eq(branchCol, b).limit(ROW_LIMIT);
            if (data && data.length) chunks.push(...data);
          }
          return chunks;
        }
      }

      /* ====== UI builders ====== */
      function buildSkeleton(tbody, rows){
        tbody.innerHTML = '';
        for (let i=0;i<rows;i++){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><div class="skl" style="width:180px;height:14px"></div></td>
            <td><div class="skl" style="width:120px;height:14px"></div></td>
            <td><div class="skl" style="width:120px;height:14px"></div></td>
            <td><div class="skl" style="width:140px;height:14px"></div></td>`;
          tbody.appendChild(tr);
        }
      }
      function setRowDisplay(cells, label, vb, vc, reverse, isPct, isId){
        const [tdLabel, tdB, tdC, tdD] = cells;
        tdLabel.textContent = label || '‚Äî';

        const nb = Number.isFinite(vb) ? vb : toNumber(vb);
        const nc = Number.isFinite(vc) ? vc : toNumber(vc);

        const disp = (n)=> Number.isFinite(n) ? (isPct?withPercent(n):fmtNumIndian(n)) : '‚Äî';
        tdB.textContent = disp(nb);
        tdC.textContent = disp(nc);

        if (Number.isFinite(nb) && Number.isFinite(nc)){
          const d = nc - nb;
          const pretty = isPct ? withPercent(d) : fmtNumIndian(d);
          let color = '#475569', weight = '500';
          if (!reverse){
            if (d > 0){ color = 'var(--good)'; weight='700'; }
            else if (d < 0){ color = 'var(--bad)'; weight='700'; }
          }else{
            if (d > 0){ color = 'var(--bad)'; weight='700'; }
            else if (d < 0){ color = 'var(--good)'; weight='700'; }
          }
          tdD.innerHTML = `<span style="color:${color};font-weight:${weight}">${pretty}</span>`;
        }else{
          tdD.innerHTML = '<span style="color:#94a3b8">‚Äî</span>';
        }
      }

      /* ====== MAIN ====== */
      async function main(){
        const hdrBadge = el('#hdrBadge');
        const thB = el('#thB'), thC = el('#thC');
        const finalBody = el('#finalBody');

        // Print + back on logo
        el('#btnPrint').addEventListener('click', ()=> window.print());
        // table starts with skeleton
        buildSkeleton(finalBody, 11);
        hdrBadge.classList.add('spin'); hdrBadge.textContent = 'Loading‚Ä¶';

        // Discover columns + months
        const cols = await fetchColumns();
        if (!cols.length){ hdrBadge.classList.remove('spin'); hdrBadge.textContent = 'No columns'; el('#statusLine').textContent = 'Could not discover columns in NLPL_FINAL_TABLE.'; return; }

        const monthCol  = pickMonthColumn(cols);
        const branchCol = pickBranchNameColumn(cols);
        const paramCols = DEFAULT_PARAMS.map(desired => smartMatchTitleToColumn(desired, cols) || desired);
        if (!monthCol || !branchCol){
          hdrBadge.classList.remove('spin');
          hdrBadge.textContent = 'Missing mapping';
          el('#statusLine').textContent = `Could not identify ${!monthCol?'Month':'Branch Name'} column.`;
          return;
        }

        // Prev/Current month labels from data
        let months = await computeAvailableMonths(cols);
        let labelPrev = 'Prev Month', labelCurr = 'Current Month';
        if (months && months.length){
          const last = months[months.length-1];
          const prev = months[months.length-2] || last;
          labelPrev = prev; labelCurr = last;
        }
        thB.textContent = labelPrev; 
        thC.textContent = labelCurr;

        /* >>> Title now uses Column 3 header (Current Month) <<< */
        const mxTitleEl = el('#mxTitle');
        if (mxTitleEl) {
          mxTitleEl.textContent = `NLPL - ${labelCurr} Month Highlights ( Amount in Cr)`;
        }

        // Build ALL_BRANCHES from the overlay list to keep in sync
        const overlayList = Array.from(document.querySelectorAll('#overlay-grid-branch .overlay-name')).map(n=>n.textContent.trim());
        let ALL_BRANCHES = overlayList.length ? overlayList : (function(){
          // fallback to hardcoded list if overlay not opened yet
          return [
            "AJJAMPURA","BAGEPALLI","BANGARPET","BETHAMANGALA","CHALLAKERE","CHANDAPURA","CHANNAGIRI","CHIKBALLAPURA","CHIKKAMAGALURU","CHIKKANAYAKANAHALLI","CHINTAMANI","CHITRADURGA","DABUSPET","DEVANAHALLI","DODDABALLAPURA","GOWRIBIDANUR","GUBBI","HEBBAL","HIRIYUR","HOLAKERE","HOSADURGA","HULIYAR","J P NAGAR","JAGALORE","KADUR","KENGERI","KOLAR","KORATAGERE","KUNIGAL","MADHUGIRI","MALUR","MUDIGERE","NR PURA","PANCHANHALLI","SIRA","SRINIVASPURA","TARIKERE","TIPTUR","TUMKUR","TUREVEKERE",
            "AFZALPUR","ALAND","ALMEL","AURAD","BAGALKOT","BASAVAKALYAN","BHALKI","BIDAR","BIDAR-2","BILAGI","CHADCHAN","CHINCHOLI","DEVADURGA","GANGAVATHI","HULSOOR","HUMNABAD","HUNGUND","INDI","JAMAKHANDI","JEVARGI","KALABURAGI","KALAGI","KALBURGI-2","KAMALAPURA","KOPPAL","KUSHTAGI","LINGSUGUR","LOKAPUR","MANVI","MUDDEBIHAL","RAICHUR","SEDAM","SHAHAPUR","SINDAGI","SINDHNUR","SIRWAR","TALIKOTI","TIKOTA","VIJAYAPUR","YADGIR",
            "ATHANI","BADAMI","BAILHONGAL","BALLARI","BELAGAVI","CHIKKODI","DAVANAGERE","DHARWAD","GADAG","GAJENDRAGAD","GOKAK","HAGARIBOMMANAHALLI","HARAPANAHALLI","HARIHARA","HONNALI","HOSPET","HUBLI","HUBLI-2","HUVENAHADAGALLI","KALGHATGI","KHANAHOSAHALLI","KITTUR","KOTTURU","KUDATHINI","KUDLIGI","LAXMESHWAR","MUDALAGI","MUNDARAGI","NARAGUNDA","NIPPANI","RAMDURGA","SANDURU","SANTHEBENNURU","SIRUGUPPA","YARAGATTI",
            "GADWAL","KODANGAL","MAHABUB NAGAR","MARIKAL","NARAYANKHED","SANGAREDDY","TANDUR","ZAHEERABAD",
            "BADVEL","DHARMAVARAM","KADAPA","KADIRI"
          ];
        })();

        // Fetch rows for all branches
        hdrBadge.classList.add('spin'); hdrBadge.textContent = 'Fetching‚Ä¶';
        const metricsUnique = Array.from(new Set(paramCols.filter(Boolean)));
        const rows = await loadRowsForBranches(branchCol, monthCol, metricsUnique, ALL_BRANCHES);

        // Map branch->month rows
        const byBranchMonth = new Map();
        for (const r of rows){
          const b = r[branchCol]; const mi = monthIndexFromValue(r[monthCol]);
          if (!b || !mi) continue;
          if (!byBranchMonth.has(b)) byBranchMonth.set(b, new Map());
          byBranchMonth.get(b).set(mi, r);
        }
        const miB = monthIndexFromValue(labelPrev);
        const miC = monthIndexFromValue(labelCurr);

        // Aggregators
        const agg = paramCols.map(label=>({
          label,
          isPct: isRegularCollectionLabel(label),
          isId:  isIdentifierLabel(label),
          reverse: isReverseDiffLabel(label),
          sumB:0, sumC:0, cntB:0, cntC:0
        }));

        // Aggregate
        for (const bName of ALL_BRANCHES){
          const m = byBranchMonth.get(bName) || new Map();
          const rowB = miB ? m.get(miB) : null;
          const rowC = miC ? m.get(miC) : null;
          for (const A of agg){
            if (A.isId) continue;
            const vb = rowB ? rowB[A.label] : null;
            const vc = rowC ? rowC[A.label] : null;
            const nb = toNumber(vb), nc = toNumber(vc);
            if (Number.isFinite(nb)){ A.sumB += nb; A.cntB += (A.isPct?1:0); }
            if (Number.isFinite(nc)){ A.sumC += nc; A.cntC += (A.isPct?1:0); }
          }
        }

        // Paint table (replace skeleton)
        const tbody = el('#finalBody'); tbody.innerHTML = '';
        for (let i=0;i<agg.length;i++){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td></td><td></td><td></td><td></td>`;
          tbody.appendChild(tr);

          const A = agg[i];
          const vb = A.isPct ? (A.cntB? A.sumB/A.cntB : NaN) : (A.sumB);
          const vc = A.isPct ? (A.cntC? A.sumC/A.cntC : NaN) : (A.sumC);
          const cells = [ tr.children[0], tr.children[1], tr.children[2], tr.children[3] ];
          setRowDisplay(cells, A.label, vb, vc, A.reverse, A.isPct, A.isId);
        }

        hdrBadge.classList.remove('spin');
        hdrBadge.textContent = 'live summary ‚Ä¢ all branches';
        el('#statusLine').textContent = `Period: ${thB.textContent} vs ${thC.textContent} ‚Ä¢ ${ALL_BRANCHES.length} branches`;
      }

      // start
      main();

    })();
  </script>

  <!-- Branch overlay logic -->
  <script>
    (function(){
      const BRANCHES = [
        {code:"5822",name:"AFZALPUR"},{code:"5888",name:"AJJAMPURA"},{code:"5895",name:"ALAND"},
        {code:"5920",name:"ALMEL"},{code:"5806",name:"ATHANI"},{code:"5892",name:"AURAD"},
        {code:"5815",name:"BADAMI"},{code:"5812",name:"BAGALKOT"},{code:"5887",name:"BAGEPALLI"},
        {code:"5905",name:"BAILHONGAL"},{code:"5851",name:"BALLARI"},{code:"5830",name:"BANGARPET"},
        {code:"5831",name:"BASAVAKALYAN"},{code:"5804",name:"BELAGAVI"},{code:"5899",name:"BETHAMANGALA"},
        {code:"5821",name:"BHALKI"},{code:"5832",name:"BIDAR"},{code:"5915",name:"BIDAR-2"},
        {code:"5882",name:"BILAGI"},{code:"5912",name:"BADVEL"},{code:"5875",name:"CHADCHAN"},
        {code:"5897",name:"CHALLAKERE"},{code:"5886",name:"CHANDAPURA"},{code:"5872",name:"CHANNAGIRI"},
        {code:"5863",name:"CHIKBALLAPURA"},{code:"5866",name:"CHIKKAMAGALURU"},{code:"5896",name:"CHIKKANAYAKANAHALLI"},
        {code:"5810",name:"CHIKKODI"},{code:"5823",name:"CHINCHOLI"},{code:"5864",name:"CHINTAMANI"},
        {code:"5870",name:"CHITRADURGA"},{code:"5860",name:"DABUSPET"},{code:"5873",name:"DAVANAGERE"},
        {code:"5833",name:"DEVADURGA"},{code:"5861",name:"DEVANAHALLI"},{code:"5914",name:"DHARMAVARAM"},
        {code:"5800",name:"DHARWAD"},{code:"5862",name:"DODDABALLAPURA"},{code:"5802",name:"GADAG"},
        {code:"5926",name:"GADWAL"},{code:"5819",name:"GAJENDRAGAD"},{code:"5818",name:"GANGAVATHI"},
        {code:"5805",name:"GOKAK"},{code:"5865",name:"GOWRIBIDANUR"},{code:"5834",name:"GUBBI"},
        {code:"5854",name:"HAGARIBOMMANAHALLI"},{code:"5855",name:"HARAPANAHALLI"},{code:"5890",name:"HARIHARA"},
        {code:"5858",name:"HEBBAL"},{code:"5885",name:"HIRIYUR"},{code:"5908",name:"HOLAKERE"},
        {code:"5874",name:"HONNALI"},{code:"5871",name:"HOSADURGA"},{code:"5856",name:"HOSPET"},
        {code:"5801",name:"HUBLI"},{code:"5900",name:"HUBLI-2"},{code:"5826",name:"HULIYAR"},
        {code:"5901",name:"HULSOOR"},{code:"5835",name:"HUMNABAD"},{code:"5827",name:"HUNGUND"},
        {code:"5918",name:"HUVENAHADAGALLI"},{code:"5876",name:"INDI"},{code:"5859",name:"J P NAGAR"},
        {code:"5889",name:"JAGALORE"},{code:"5807",name:"JAMAKHANDI"},{code:"5824",name:"JEVARGI"},
        {code:"5911",name:"KADAPA"},{code:"5913",name:"KADIRI"},{code:"5867",name:"KADUR"},
        {code:"5825",name:"KALABURAGI"},{code:"5904",name:"KALAGI"},{code:"5893",name:"KALBURGI-2"},
        {code:"5894",name:"KALGHATGI"},{code:"5903",name:"KAMALAPURA"},{code:"5916",name:"KENGERI"},
        {code:"5852",name:"KHANAHOSAHALLI"},{code:"5814",name:"KITTUR"},{code:"5923",name:"KODANGAL"},
        {code:"5836",name:"KOLAR"},{code:"5817",name:"KOPPAL"},{code:"5837",name:"KORATAGERE"},
        {code:"5891",name:"KOTTURU"},{code:"5898",name:"KUDATHINI"},{code:"5857",name:"KUDLIGI"},
        {code:"5838",name:"KUNIGAL"},{code:"5883",name:"KUSHTAGI"},{code:"5803",name:"LAXMESHWAR"},
        {code:"5839",name:"LINGSUGUR"},{code:"5816",name:"LOKAPUR"},{code:"5840",name:"MADHUGIRI"},
        {code:"5925",name:"MAHABUB NAGAR"},{code:"5828",name:"MALUR"},{code:"5841",name:"MANVI"},
        {code:"5927",name:"MARIKAL"},{code:"5809",name:"MUDALAGI"},{code:"5877",name:"MUDDEBIHAL"},
        {code:"5868",name:"MUDIGERE"},{code:"5820",name:"MUNDARAGI"},{code:"5881",name:"NARAGUNDA"},
        {code:"5922",name:"NARAYANKHED"},{code:"5811",name:"NIPPANI"},{code:"5906",name:"NR PURA"},
        {code:"5907",name:"PANCHANHALLI"},{code:"5842",name:"RAICHUR"},{code:"5813",name:"RAMDURGA"},
        {code:"5884",name:"SANDURU"},{code:"5921",name:"SANGAREDDY"},{code:"5909",name:"SANTHEBENNURU"},
        {code:"5843",name:"SEDAM"},{code:"5844",name:"SHAHAPUR"},{code:"5878",name:"SINDAGI"},
        {code:"5845",name:"SINDHNUR"},{code:"5846",name:"SIRA"},{code:"5853",name:"SIRUGUPPA"},
        {code:"5917",name:"SIRWAR"},{code:"5829",name:"SRINIVASPURA"},{code:"5879",name:"TALIKOTI"},
        {code:"5924",name:"TANDUR"},{code:"5869",name:"TARIKERE"},{code:"5902",name:"TIKOTA"},
        {code:"5847",name:"TIPTUR"},{code:"5848",name:"TUMKUR"},{code:"5849",name:"TUREVEKERE"},
        {code:"5880",name:"VIJAYAPUR"},{code:"5850",name:"YADGIR"},{code:"5808",name:"YARAGATTI"},
        {code:"5919",name:"ZAHEERABAD"}
      ];

      // Elements
      const btnBranch = document.getElementById('btn-branch');
      const overlayBranch = document.getElementById('overlay-branch');
      const overlayGridBranch = document.getElementById('overlay-grid-branch');
      const overlaySearchBranch = document.getElementById('overlay-search-input-branch');
      const overlaySearchBtnBranch = document.getElementById('overlay-search-button-branch');
      const overlayCloseBranch = document.getElementById('overlay-close-branch');
      const overlayTitleBranch = document.getElementById('overlay-title-branch');
      const dashboardContainer = document.getElementById('dashboard-container');

      function setTitleCountBranch(list){ overlayTitleBranch.textContent = `BRANCH (${list.length})`; }
      function normalize(s){ return s.toString().toLowerCase().replace(/\s+/g,'').trim(); }

      function renderGridBranch(items){
        overlayGridBranch.innerHTML = '';
        items.forEach(({code,name})=>{
          const div = document.createElement('div');
          div.className = 'overlay-item';
          div.title = `${code} ‚Ä¢ ${name}`;
          div.innerHTML = `
            <div class="overlay-code">${code}</div>
            <div class="overlay-name">${name}</div>
            <div class="overlay-sub">Tap to open</div>
          `;
          div.addEventListener('click', ()=> openBranchPage(code, name));
          overlayGridBranch.appendChild(div);
        });
      }

      function doSearchBranch(){
        const raw = overlaySearchBranch.value || '';
        const term = normalize(raw);
        let list = BRANCHES.slice();
        if(term){ list = list.filter(b => normalize(b.name).includes(term) || b.code.includes(term)); }
        renderGridBranch(list);
        setTitleCountBranch(list);
      }

      function openOverlayBranch(){
        overlaySearchBranch.value = '';
        const items = BRANCHES.slice();
        renderGridBranch(items);
        setTitleCountBranch(items);
        overlayBranch.style.display = 'flex';
        dashboardContainer.style.display = 'none';
        overlaySearchBranch.focus();
      }

      function closeOverlayBranch(){
        overlayBranch.style.display = 'none';
        dashboardContainer.style.display = 'flex';
      }

      function openBranchPage(code, name){
        localStorage.setItem('branch_code', code);
        localStorage.setItem('branch_name', name);
        const url = `branch.html?code=${encodeURIComponent(code)}&branch=${encodeURIComponent(name)}`;
        window.location.href = url;
      }

      // Wire events + keyboard niceties
      btnBranch.addEventListener('click', openOverlayBranch);
      overlayCloseBranch.addEventListener('click', closeOverlayBranch);
      overlaySearchBtnBranch.addEventListener('click', doSearchBranch);
      overlaySearchBranch.addEventListener('input', debounce(doSearchBranch, 120));
      overlaySearchBranch.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); doSearchBranch(); } });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && overlayBranch.style.display==='flex'){ closeOverlayBranch(); } });

      if(location.hash.toLowerCase()==='#branch'){ openOverlayBranch(); }

      function debounce(fn, wait){
        let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), wait); };
      }
    })();
  </script>

  <!-- Region overlay logic -->
  <script>
    (function(){
      const REGIONS_ALL = [
        { name: "ANDRA PRADESH", branchCount: 4 },
        { name: "TELANGANA",      branchCount: 8 },
        { name: "DHARWAD",        branchCount: 35 },
        { name: "KALBURGI",       branchCount: 40 },
        { name: "TUMKUR",         branchCount: 40 }
      ];

      const btnRegion          = document.getElementById('btn-region');
      const overlayRegion      = document.getElementById('overlay-region');
      const overlayGridRegion  = document.getElementById('overlay-grid-region');
      const overlayCloseRegion = document.getElementById('overlay-close-region');
      const overlayTitleRegion = document.getElementById('overlay-title-region');
      const overlaySearchInput = document.getElementById('overlay-search-input-region');
      const overlaySearchBtn   = document.getElementById('overlay-search-button-region');
      const dashboardContainer = document.getElementById('dashboard-container');

      function setTitleCountRegion(list){ overlayTitleRegion.textContent = `REGION (${list.length})`; }
      function normalize(s){ return s.toString().toLowerCase().replace(/\s+/g,'').trim(); }

      function renderGridRegion(items){
        overlayGridRegion.innerHTML = '';
        items.forEach(r=>{
          const div = document.createElement('div');
          div.className = 'overlay-item';
          div.title = `${r.name} ‚Ä¢ ${r.branchCount} branches`;
          div.innerHTML = `
            <div class="overlay-name">${r.name}</div>
            <div class="overlay-sub">${r.branchCount} branches</div>
          `;
          div.addEventListener('click', ()=>openRegion(r.name, r.branchCount));
          overlayGridRegion.appendChild(div);
        });
      }

      function openOverlayRegion(){
        overlaySearchInput.value = '';
        const items = REGIONS_ALL.slice();
        renderGridRegion(items);
        setTitleCountRegion(items);
        overlayRegion.style.display = 'flex';
        dashboardContainer.style.display = 'none';
        overlaySearchInput.focus();
      }

      function closeOverlayRegion(){
        overlayRegion.style.display = 'none';
        dashboardContainer.style.display = 'flex';
      }

      function openRegion(regionName, branchCount){
        localStorage.setItem('region_name', regionName);
        localStorage.setItem('region_branch_count', String(branchCount));
        const url = `region.html?region=${encodeURIComponent(regionName)}&count=${encodeURIComponent(String(branchCount))}`;
        window.location.href = url;
      }

      function doSearchRegion(){
        const raw = overlaySearchInput.value || '';
        const term = normalize(raw);
        let list = REGIONS_ALL.slice();
        if(term){ list = list.filter(r => normalize(r.name).includes(term)); }
        renderGridRegion(list);
        setTitleCountRegion(list);
      }

      btnRegion.addEventListener('click', openOverlayRegion);
      overlayCloseRegion.addEventListener('click', closeOverlayRegion);
      overlaySearchBtn.addEventListener('click', doSearchRegion);
      overlaySearchInput.addEventListener('input', debounce(doSearchRegion, 120));
      overlaySearchInput.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); doSearchRegion(); } });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && overlayRegion.style.display==='flex'){ closeOverlayRegion(); } });

      if(location.hash.toLowerCase()==='#region'){ openOverlayRegion(); }

      function debounce(fn, wait){
        let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), wait); };
      }
    })();
  </script>
</body>
</html>
